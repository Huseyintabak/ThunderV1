<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OperatÃ¶r Ãœretim Paneli - Thunder Production</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1.5rem;
        }
        
        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .stats-card .card-body {
            padding: 1.5rem;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .product-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .product-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }
        
        .product-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 13px 13px 0 0;
            padding: 1rem;
        }
        
        .product-card .card-body {
            padding: 1.5rem;
        }
        
        .product-card .card-footer {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 13px 13px;
            padding: 1rem;
        }
        
        .btn-start-production {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-start-production:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }
        
        .btn-logout {
            background: #dc3545;
            border: none;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            background: #c82333;
            transform: translateY(-1px);
            color: white;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .table tbody td {
            border: none;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .section-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
            display: inline-block;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <!-- OperatÃ¶r Paneli - Sadece OperatÃ¶r Bilgileri -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-industry me-2"></i>OperatÃ¶r Ãœretim Paneli
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="operatorDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i><span id="operatorName">OperatÃ¶r</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Ã‡Ä±kÄ±ÅŸ Yap
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Ä°statistikler -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="stats-number" id="plannedOrdersCount">0</h3>
                        <p class="stats-label">Planlanan SipariÅŸler</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="stats-number" id="activeProductionsCount">0</h3>
                        <p class="stats-label">Aktif Ãœretimler</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="stats-number" id="totalProductsCount">0</h3>
                        <p class="stats-label">Toplam ÃœrÃ¼n</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="stats-number" id="completedTodayCount">0</h3>
                        <p class="stats-label">BugÃ¼n Tamamlanan</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Planlanan SipariÅŸler ve Aktif Ãœretimler -->
        <div class="row mb-4">
            <!-- Planlanan SipariÅŸler -->
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-list me-2"></i>Planlanan SipariÅŸler</h5>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner text-center py-4" id="plannedOrdersLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="plannedOrdersTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">SipariÅŸ No</th>
                                        <th style="width: 15%;">MÃ¼ÅŸteri</th>
                                        <th style="width: 10%;">Miktar</th>
                                        <th style="width: 15%;">Teslim Tarihi</th>
                                        <th style="width: 10%;">Ã–ncelik</th>
                                        <th style="width: 10%;">Durum</th>
                                        <th style="width: 20%;">Ãœretim</th>
                                    </tr>
                                </thead>
                                <tbody id="plannedOrdersBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="empty-state" id="plannedOrdersEmpty" style="display: none;">
                            <i class="fas fa-clipboard-list"></i>
                            <h5>Planlanan sipariÅŸ bulunmuyor</h5>
                            <p>HenÃ¼z size atanmÄ±ÅŸ planlanan sipariÅŸ bulunmuyor.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aktif Ãœretimler -->
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>Aktif Ãœretimler</h5>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner text-center py-4" id="activeProductionsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                        </div>
                    <div class="table-responsive" id="activeProductionsTable" style="display: none;">
                        <table class="table table-hover">
                                <thead>
                                    <tr>
                                    <th>ID</th>
                                    <th>ÃœrÃ¼n</th>
                                    <th>Planlanan</th>
                                    <th>Ãœretilen</th>
                                        <th>Ä°lerleme</th>
                                        <th>BaÅŸlangÄ±Ã§</th>
                                    <th>AÅŸama</th>
                                        <th>Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="activeProductionsBody">
                                <!-- Aktif Ã¼retimler buraya yÃ¼klenecek -->
                                </tbody>
                            </table>
                        </div>
                        <div class="empty-state" id="activeProductionsEmpty" style="display: none;">
                            <i class="fas fa-cogs"></i>
                            <h5>Aktif Ã¼retim bulunmuyor</h5>
                            <p>Åžu anda devam eden Ã¼retim bulunmuyor.</p>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- YarÄ±da Kalan Ãœretimler -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-pause-circle me-2"></i>YarÄ±da Kalan Ãœretimler</h5>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner text-center py-4" id="pausedProductionsLoading">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="pausedProductionsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Ãœretim ID</th>
                                        <th style="width: 20%;">ÃœrÃ¼n AdÄ±</th>
                                        <th style="width: 10%;">Hedef</th>
                                        <th style="width: 10%;">Ãœretilen</th>
                                        <th style="width: 15%;">Ä°lerleme</th>
                                        <th style="width: 15%;">Duraklatma</th>
                                        <th style="width: 15%;">Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="pausedProductionsBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="empty-state" id="pausedProductionsEmpty" style="display: none;">
                            <i class="fas fa-pause-circle"></i>
                            <h5>YarÄ±da kalan Ã¼retim bulunmuyor</h5>
                            <p>Åžu anda duraklatÄ±lmÄ±ÅŸ Ã¼retim bulunmuyor.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÃœreteceÄŸi ÃœrÃ¼nler -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-boxes me-2"></i>ÃœreteceÄŸi ÃœrÃ¼nler</h5>
                        <small class="text-muted">Aktif Ãœretimler tabÄ±ndan bir Ã¼retim seÃ§in</small>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner text-center py-4" id="productsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                        </div>
                        <div class="row" id="productsContainer" style="display: none;">
                            <!-- ÃœrÃ¼n kartlarÄ± buraya yÃ¼klenecek -->
                        </div>
                        <div class="empty-state" id="productsEmpty" style="display: none;">
                            <i class="fas fa-boxes"></i>
                            <h5>Ãœretilecek Ã¼rÃ¼n bulunmuyor</h5>
                            <p>HenÃ¼z size atanmÄ±ÅŸ Ã¼retilecek Ã¼rÃ¼n bulunmuyor.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BugÃ¼n Tamamlanan Ãœretimler -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-check-circle me-2"></i>BugÃ¼n Tamamlanan Ãœretimler</h5>
                        <small class="text-light">Sadece bugÃ¼n tamamladÄ±ÄŸÄ±nÄ±z Ã¼retimler gÃ¶sterilmektedir</small>
                    </div>
                    <div class="card-body">
                        <div class="loading-spinner text-center py-4" id="completedProductionsLoading">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">YÃ¼kleniyor...</span>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="completedProductionsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Ãœretim ID</th>
                                        <th style="width: 20%;">ÃœrÃ¼n AdÄ±</th>
                                        <th style="width: 10%;">Hedef</th>
                                        <th style="width: 10%;">Ãœretilen</th>
                                        <th style="width: 15%;">Ä°lerleme</th>
                                        <th style="width: 15%;">BugÃ¼n Tamamlanma</th>
                                        <th style="width: 15%;">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="completedProductionsBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="empty-state" id="completedProductionsEmpty" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <h5>BugÃ¼n tamamlanan Ã¼retim bulunmuyor</h5>
                            <p>BugÃ¼n henÃ¼z tamamladÄ±ÄŸÄ±nÄ±z Ã¼retim bulunmuyor. Ãœretimlerinizi tamamladÄ±ÄŸÄ±nÄ±zda burada gÃ¶rÃ¼necektir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ãœretim Modal -->
    <div class="modal fade" id="productionModal" tabindex="-1" aria-labelledby="productionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productionModalLabel">
                        <i class="fas fa-cogs me-2"></i>Ãœretim SÃ¼reci
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <!-- SeÃ§ilen ÃœrÃ¼n Bilgisi -->
                        <div class="alert alert-info mb-3" id="selectedProductInfo" style="display: none;">
                            <div class="row">
                                <div class="col-8">
                                    <strong>SeÃ§ilen ÃœrÃ¼n:</strong> <span id="selectedProductName">-</span><br>
                                    <strong>ÃœrÃ¼n Kodu:</strong> <span id="selectedProductCode">-</span>
                                </div>
                                <div class="col-4 text-end">
                                    <small class="text-muted">Bu Ã¼rÃ¼ne ait barkodlarÄ± okutabilirsiniz</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted">ÃœrÃ¼n Bilgileri</h6>
                                <div class="card product-card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-box me-2"></i><span id="modalProductName">-</span>
                                        </h6>
                                            </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>ÃœrÃ¼n Kodu:</strong>
                                                <div class="text-primary fw-bold" id="modalProductCode">-</div>
                                            </div>
                                            <div class="col-6">
                                                <strong>Miktar:</strong>
                                                <div class="text-success fw-bold" id="modalTargetQuantity">-</div>
                                            </div>
                                            </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Barkod:</strong>
                                                <div class="text-info fw-bold" id="modalProductBarcode">-</div>
                                            </div>
                                            <div class="col-6">
                                                <strong>Ãœretilen:</strong>
                                                <div class="text-warning fw-bold" id="modalProducedQuantity">-</div>
                                            </div>
                                            </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>SipariÅŸ No:</strong>
                                                <div class="text-muted small" id="modalOrderNumber">-</div>
                                        </div>
                                            <div class="col-6">
                                                <strong>MÃ¼ÅŸteri:</strong>
                                                <div class="text-muted small" id="modalCustomerName">-</div>
                                            </div>
                                            </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Plan ID:</strong>
                                                <div class="text-info small" id="modalPlanId">-</div>
                                        </div>
                                            <div class="col-6">
                                                <strong>Ãœretim ID:</strong>
                                                <div class="text-info small" id="modalProductionId">-</div>
                                        </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Planlanan Miktar:</strong>
                                                <div class="text-info small" id="modalPlannedQuantity">-</div>
                                        </div>
                                            <div class="col-6">
                                                <strong>Ã–ncelik:</strong>
                                                <span class="badge bg-info" id="modalPriority">-</span>
                                                </div>
                                                </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Teslim Tarihi:</strong>
                                                <div class="text-muted small" id="modalDeliveryDate">-</div>
                                            </div>
                                            <div class="col-6">
                                                <strong>Durum:</strong>
                                                <div class="text-success fw-bold" id="modalStatus">-</div>
                                        </div>
                                    </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>Ä°lerleme:</strong>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar" id="modalProgressBar" style="width: 0%"></div>
                                </div>
                                                <small class="text-muted" id="modalProgressText">0%</small>
                                            </div>
                                            <div class="col-6">
                                                <strong>OperatÃ¶r:</strong>
                                                <div class="text-muted small" id="modalOperator">-</div>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <strong>ÃœrÃ¼n DetayÄ±:</strong>
                                            <div class="text-muted small" id="modalProductDetail">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">Barkod Okutma</h6>
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-barcode fa-3x text-primary mb-3"></i>
                                        <h5>ÃœrÃ¼n Barkodunu Okutun</h5>
                                        <p class="text-muted">Barkod okuyucuyu kullanarak Ã¼rÃ¼n barkodunu okutun</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="barcodeInput" class="form-label">Barkod</label>
                                        <input type="text" class="form-control form-control-lg text-center" id="barcodeInput" 
                                               placeholder="Barkod okuyucu ile okutun veya manuel girin" autofocus>
                                        <div class="form-text">Barkod okuyucu otomatik olarak algÄ±layacaktÄ±r</div>
                                    </div>
                                    
                                    <!-- Ãœretim Adedi Girme AlanÄ± -->
                                    <div class="mb-3" id="quantityInputSection" style="display: none;">
                                        <label for="quantityInput" class="form-label">Ãœretim Adedi</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control form-control-lg text-center" id="quantityInput" 
                                                   placeholder="Ãœretilen adet sayÄ±sÄ±nÄ± girin" min="1" value="1">
                                            <button class="btn btn-success" type="button" onclick="addProductionQuantity()">
                                                <i class="fas fa-plus me-2"></i>Ekle
                                            </button>
                                        </div>
                                        <div class="form-text">Barkod doÄŸrulandÄ±ktan sonra Ã¼retim adedini girin</div>
                                    </div>

                                    <div class="alert alert-info" id="barcodeStatus" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span id="barcodeMessage">Barkod okutuldu, iÅŸleniyor...</span>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                        <button class="btn btn-outline-secondary" onclick="clearBarcode()">
                                            <i class="fas fa-times me-2"></i>Temizle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Kapat
                    </button>
                    <button type="button" class="btn btn-warning" onclick="pauseProduction()" id="pauseBtn">
                        <i class="fas fa-pause me-2"></i>Duraklat
                    </button>
                    <button type="button" class="btn btn-success" onclick="resumeProduction()" id="resumeBtn" style="display: none;">
                        <i class="fas fa-play me-2"></i>Devam Et
                    </button>
                    <button type="button" class="btn btn-primary" onclick="completeProduction()" id="completeBtn" disabled>
                        <i class="fas fa-check-circle me-2"></i>Ãœretimi Tamamla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="realtime-client.js"></script>
    <script>
        let currentOperator = null;
        let realtimeClient = null;

        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', async function() {
            await checkOperatorLogin();
            initializeRealtimeClient();
            loadData();
        });

        // OperatÃ¶r giriÅŸi kontrolÃ¼ - GerÃ§ek zamanlÄ± veritabanÄ± kontrolÃ¼
        async function checkOperatorLogin() {
            console.log('ðŸ” OperatÃ¶r giriÅŸi gerÃ§ek zamanlÄ± kontrol ediliyor...');
            
            const operatorData = localStorage.getItem('currentOperator');
            if (!operatorData) {
                console.log('âŒ OperatÃ¶r verisi bulunamadÄ±, login sayfasÄ±na yÃ¶nlendiriliyor');
                window.location.href = 'operator-login.html';
                return;
            }

            try {
                currentOperator = JSON.parse(operatorData);
                console.log('ðŸ‘¤ LocalStorage operatÃ¶r verisi:', currentOperator);
                
                // OperatÃ¶r verisi geÃ§erli mi kontrol et
                if (!currentOperator.id || !currentOperator.name) {
                    console.log('âŒ GeÃ§ersiz operatÃ¶r verisi, login sayfasÄ±na yÃ¶nlendiriliyor');
                    localStorage.removeItem('currentOperator');
                    window.location.href = 'operator-login.html';
                    return;
                }
                
                // GerÃ§ek zamanlÄ± veritabanÄ± kontrolÃ¼
                const verifyResponse = await fetch('/api/operators/verify-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operatorId: currentOperator.id,
                        sessionToken: currentOperator.sessionToken || null
                    })
                });

                if (!verifyResponse.ok) {
                    console.log('âŒ OperatÃ¶r oturumu geÃ§ersiz, login sayfasÄ±na yÃ¶nlendiriliyor');
                    localStorage.removeItem('currentOperator');
                    window.location.href = 'operator-login.html';
                    return;
                }

                const verification = await verifyResponse.json();
                
                if (!verification.valid) {
                    console.log('âŒ OperatÃ¶r oturumu doÄŸrulanamadÄ±, login sayfasÄ±na yÃ¶nlendiriliyor');
                    localStorage.removeItem('currentOperator');
                    window.location.href = 'operator-login.html';
                    return;
                }

                // GÃ¼ncel operatÃ¶r bilgilerini gÃ¼ncelle
                currentOperator = {
                    ...currentOperator,
                    name: verification.operator.name,
                    email: verification.operator.email,
                    role: verification.operator.role,
                    lastVerified: new Date().toISOString()
                };

                // LocalStorage'Ä± gÃ¼ncelle
                localStorage.setItem('currentOperator', JSON.stringify(currentOperator));
                
                // OperatÃ¶r adÄ±nÄ± header'da gÃ¶ster
                const operatorNameElement = document.getElementById('operatorName');
                if (operatorNameElement) {
                    operatorNameElement.textContent = currentOperator.name;
                }
                
                console.log('âœ… OperatÃ¶r oturumu gerÃ§ek zamanlÄ± doÄŸrulandÄ±:', currentOperator.name);
                
                // Periyodik oturum kontrolÃ¼ baÅŸlat (5 dakikada bir)
                startPeriodicSessionCheck();
                
            } catch (error) {
                console.error('âŒ OperatÃ¶r oturum doÄŸrulama hatasÄ±:', error);
                localStorage.removeItem('currentOperator');
                window.location.href = 'operator-login.html';
            }
        }

        // Periyodik oturum kontrolÃ¼
        let sessionCheckInterval = null;
        
        function startPeriodicSessionCheck() {
            // Ã–nceki interval'Ä± temizle
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
            
            // 5 dakikada bir oturum kontrolÃ¼ yap
            sessionCheckInterval = setInterval(async () => {
                console.log('ðŸ”„ Periyodik oturum kontrolÃ¼ yapÄ±lÄ±yor...');
                await checkOperatorLogin();
            }, 5 * 60 * 1000); // 5 dakika
        }

        // Sayfa kapatÄ±lÄ±rken interval'Ä± temizle
        window.addEventListener('beforeunload', () => {
            if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
            }
        });

        // Real-time client baÅŸlatma
        function initializeRealtimeClient() {
            if (typeof RealtimeClient !== 'undefined') {
                realtimeClient = new RealtimeClient();
                realtimeClient.connect();
                
                // OperatÃ¶rÃ¼ kaydet (eÄŸer fonksiyon varsa)
                if (currentOperator && typeof realtimeClient.registerOperator === 'function') {
                    realtimeClient.registerOperator(currentOperator.id, currentOperator.name);
                } else if (currentOperator) {
                    console.log('RealtimeClient.registerOperator fonksiyonu bulunamadÄ±, operatÃ¶r bilgisi:', currentOperator);
                }
            } else {
                console.log('RealtimeClient bulunamadÄ±');
            }
        }

        // Verileri yÃ¼kle
        async function loadData() {
            await Promise.all([
                loadPlannedOrders(),
                loadActiveProductions(),
                loadPausedProductions(),
                loadCompletedProductions(),
                loadProducts()
            ]);
        }

        // Planlanan sipariÅŸleri yÃ¼kle (Ãœretim PlanlarÄ±ndan)
        async function loadPlannedOrders() {
            try {
                showLoading('plannedOrdersLoading', true);
                
                // Bu operatÃ¶re atanmÄ±ÅŸ Ã¼retim planlarÄ±nÄ± yÃ¼kle
                const response = await fetch(`/api/production-plans?operator_id=${currentOperator.id}`);
                if (!response.ok) throw new Error('Ãœretim planlarÄ± yÃ¼klenemedi');
                
                const plans = await response.json();
                console.log('OperatÃ¶re atanmÄ±ÅŸ planlar:', plans);
                console.log('Mevcut operatÃ¶r:', currentOperator.name);
                
                // Sadece draft ve approved durumundaki planlarÄ± gÃ¶ster
                const plannedOrders = plans.filter(plan => 
                    plan.status === 'draft' || plan.status === 'approved'
                );
                
                console.log('FiltrelenmiÅŸ planlar:', plannedOrders);
                console.log('FiltrelenmiÅŸ plan sayÄ±sÄ±:', plannedOrders.length);
                
                updateStats('plannedOrdersCount', plannedOrders.length);
                await displayPlannedOrders(plannedOrders);
                
            } catch (error) {
                console.error('Planlanan sipariÅŸler yÃ¼kleme hatasÄ±:', error);
                showEmpty('plannedOrdersEmpty', true);
            } finally {
                showLoading('plannedOrdersLoading', false);
            }
        }

        // Aktif Ã¼retimleri yÃ¼kle
        async function loadActiveProductions() {
            try {
                showLoading('activeProductionsLoading', true);
                
                const response = await fetch(`/api/active-productions?operator_id=${currentOperator.id}`);
                if (!response.ok) throw new Error('Aktif Ã¼retimler yÃ¼klenemedi');
                
                const productions = await response.json();
                console.log('OperatÃ¶re atanmÄ±ÅŸ aktif Ã¼retimler:', productions);
                console.log('Mevcut operatÃ¶r:', currentOperator.name);
                
                const activeProductions = productions.filter(production => 
                    production.status !== 'completed'
                );
                
                console.log('FiltrelenmiÅŸ aktif Ã¼retimler:', activeProductions);
                
                updateStats('activeProductionsCount', activeProductions.length);
                displayActiveProductions(activeProductions);
                
            } catch (error) {
                console.error('Aktif Ã¼retimler yÃ¼kleme hatasÄ±:', error);
                showEmpty('activeProductionsEmpty', true);
            } finally {
                showLoading('activeProductionsLoading', false);
            }
        }

        // ÃœrÃ¼nleri yÃ¼kle (BaÅŸlangÄ±Ã§ta boÅŸ)
        async function loadProducts() {
            try {
                showLoading('productsLoading', true);
                
                // Bu operatÃ¶re ait aktif Ã¼retimleri al
                const response = await fetch(`/api/active-productions?operator_id=${currentOperator.id}`);
                if (!response.ok) throw new Error('Aktif Ã¼retimler yÃ¼klenemedi');
                
                const productions = await response.json();
                console.log('OperatÃ¶re atanmÄ±ÅŸ aktif Ã¼retimler (loadProducts):', productions);
                
                // Sadece tamamlanmamÄ±ÅŸ Ã¼retimleri filtrele
                const activeProductions = productions.filter(production => 
                    production.status !== 'completed'
                );
                
                if (activeProductions.length === 0) {
                    console.log('ÃœreteceÄŸi ÃœrÃ¼nler bÃ¶lÃ¼mÃ¼ - aktif Ã¼retim yok');
                    updateStats('totalProductsCount', 0);
                    showEmpty('productsEmpty', true);
                    return;
                }
                
                // Ä°lk aktif Ã¼retimi seÃ§ ve gÃ¶ster
                const firstProduction = activeProductions[0];
                console.log('Ä°lk aktif Ã¼retim seÃ§ildi:', firstProduction);
                await loadProductsForProduction(firstProduction);
                
            } catch (error) {
                console.error('ÃœrÃ¼nler yÃ¼kleme hatasÄ±:', error);
                showEmpty('productsEmpty', true);
            } finally {
                showLoading('productsLoading', false);
            }
        }

        // YarÄ±da kalan Ã¼retimleri yÃ¼kle
        async function loadPausedProductions() {
            try {
                showLoading('pausedProductionsLoading', true);
                
                const response = await fetch(`/api/active-productions?operator_id=${currentOperator.id}`);
                if (!response.ok) throw new Error('YarÄ±da kalan Ã¼retimler yÃ¼klenemedi');
                
                const productions = await response.json();
                const pausedProductions = productions.filter(production => 
                    production.status === 'paused'
                );
                
                displayPausedProductions(pausedProductions);
                
            } catch (error) {
                console.error('YarÄ±da kalan Ã¼retimler yÃ¼kleme hatasÄ±:', error);
                showEmpty('pausedProductionsEmpty', true);
            } finally {
                showLoading('pausedProductionsLoading', false);
            }
        }

        // Tamamlanan Ã¼retimleri yÃ¼kle (sadece bugÃ¼n)
        async function loadCompletedProductions() {
            try {
                showLoading('completedProductionsLoading', true);
                
                const response = await fetch(`/api/active-productions?operator_id=${currentOperator.id}`);
                if (!response.ok) throw new Error('Tamamlanan Ã¼retimler yÃ¼klenemedi');
                
                const productions = await response.json();
                
                // BugÃ¼nÃ¼n tarihini al
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                
                console.log('BugÃ¼n aralÄ±ÄŸÄ±:', {
                    start: todayStart.toISOString(),
                    end: todayEnd.toISOString()
                });
                
                const completedProductions = productions.filter(production => {
                    // OperatÃ¶r ve durum kontrolÃ¼
                    if (production.assigned_operator !== currentOperator.name || production.status !== 'completed') {
                        return false;
                    }
                    
                    // Tamamlanma tarihi kontrolÃ¼
                    if (production.completed_time) {
                        const completedDate = new Date(production.completed_time);
                        return completedDate >= todayStart && completedDate < todayEnd;
                    }
                    
                    // EÄŸer completed_time yoksa updated_at kullan
                    if (production.updated_at) {
                        const updatedDate = new Date(production.updated_at);
                        return updatedDate >= todayStart && updatedDate < todayEnd;
                    }
                    
                    return false;
                });
                
                console.log('BugÃ¼n tamamlanan Ã¼retimler:', completedProductions);
                
                // Ä°statistikleri gÃ¼ncelle
                updateStats('completedTodayCount', completedProductions.length);
                
                displayCompletedProductions(completedProductions);
                
            } catch (error) {
                console.error('Tamamlanan Ã¼retimler yÃ¼kleme hatasÄ±:', error);
                showEmpty('completedProductionsEmpty', true);
            } finally {
                showLoading('completedProductionsLoading', false);
            }
        }

        // Planlanan sipariÅŸleri gÃ¶ster (Ãœretim PlanlarÄ±ndan)
        async function displayPlannedOrders(plans) {
            const tbody = document.getElementById('plannedOrdersBody');
            const table = document.getElementById('plannedOrdersTable');
            const empty = document.getElementById('plannedOrdersEmpty');
            
            if (plans.length === 0) {
                showEmpty('plannedOrdersEmpty', true);
                return;
            }
            
            // Her plan iÃ§in sipariÅŸ detaylarÄ±nÄ± al
            console.log('displayPlannedOrders Ã§aÄŸrÄ±ldÄ±, plan sayÄ±sÄ±:', plans.length);
            const plansWithOrderDetails = await Promise.all(plans.map(async (plan) => {
                try {
                    console.log('Plan iÅŸleniyor:', plan.id, 'order_id:', plan.order_id);
                    if (plan.order_id) {
                        const response = await fetch(`/api/orders/${plan.order_id}`);
                        console.log('SipariÅŸ API yanÄ±tÄ±:', plan.order_id, response.status);
                        if (response.ok) {
                            const order = await response.json();
                            
                            // SipariÅŸ detaylarÄ±ndan toplam miktarÄ± hesapla
                            let totalQuantity = 0;
                            if (order.product_details) {
                                let productDetails;
                                try {
                                    // product_details string ise parse et
                                    productDetails = typeof order.product_details === 'string' 
                                        ? JSON.parse(order.product_details) 
                                        : order.product_details;
                                } catch (parseError) {
                                    console.error('Product details parse hatasÄ±:', parseError);
                                    productDetails = [];
                                }
                                
                                if (Array.isArray(productDetails)) {
                                    totalQuantity = productDetails.reduce((sum, product) => {
                                        return sum + (parseInt(product.quantity) || 0);
                                    }, 0);
                                }
                            }
                            
                            console.log('SipariÅŸ miktar hesaplama:', {
                                order_id: order.id,
                                product_details: order.product_details,
                                total_quantity: totalQuantity
                            });
                            
                            return {
                                ...plan,
                                customer_name: order.customer_name,
                                priority: order.priority || 2, // VarsayÄ±lan olarak 2 (Orta)
                                order_status: order.status, // SipariÅŸin durumunu da ekle
                                display_status: order.status, // GÃ¶sterim iÃ§in sipariÅŸ durumunu kullan
                                total_quantity: totalQuantity // Hesaplanan toplam miktar
                            };
                        }
                    }
                    return {
                        ...plan,
                        display_status: plan.status, // Plan durumunu fallback olarak kullan
                        total_quantity: plan.total_quantity || 0
                    };
                } catch (error) {
                    console.error('SipariÅŸ detaylarÄ± alÄ±namadÄ±:', error);
                    return {
                        ...plan,
                        display_status: plan.status, // Plan durumunu fallback olarak kullan
                        total_quantity: plan.total_quantity || 0
                    };
                }
            }));
            
            tbody.innerHTML = plansWithOrderDetails.map(plan => `
                <tr>
                    <td><strong>${plan.plan_name || 'PLAN-' + plan.id}</strong></td>
                    <td>${plan.customer_name || 'N/A'}</td>
                    <td><span class="badge bg-info">${plan.total_quantity || 0} adet</span></td>
                    <td>${formatDate(plan.end_date)}</td>
                    <td><span class="badge ${getPriorityBadgeClass(plan.priority)}">${getPriorityText(plan.priority)}</span></td>
                    <td><span class="badge ${getOrderStatusBadgeClass(plan.display_status)}">${getOrderStatusText(plan.display_status)}</span></td>
                    <td class="text-center">
                        <button class="btn btn-success btn-sm w-100" onclick="startProductionFromPlan(${plan.id}, '${plan.plan_name || 'PLAN-' + plan.id}', ${plan.total_quantity || 0})" title="PlanÄ± Kabul Et ve Ãœretime BaÅŸla">
                            <i class="fas fa-check me-1"></i>Kabul Et
                        </button>
                    </td>
                </tr>
            `).join('');
            
            table.style.display = 'table';
            empty.style.display = 'none';
        }

        // Aktif Ã¼retimleri gÃ¶ster
        function displayActiveProductions(productions) {
            console.log('displayActiveProductions Ã§aÄŸrÄ±ldÄ±:', productions);
            const tbody = document.getElementById('activeProductionsBody');
            const table = document.getElementById('activeProductionsTable');
            const empty = document.getElementById('activeProductionsEmpty');
            
            if (productions.length === 0) {
                console.log('Aktif Ã¼retim bulunamadÄ±, empty state gÃ¶steriliyor');
                showEmpty('activeProductionsEmpty', true);
                return;
            }
            
            console.log('Aktif Ã¼retimler gÃ¶steriliyor:', productions.length, 'adet');
            
            tbody.innerHTML = productions.map(production => {
                const progress = production.planned_quantity > 0 ? 
                    ((production.produced_quantity || 0) / production.planned_quantity) * 100 : 0;
                
                return `
                    <tr>
                        <td><strong>#${production.id}</strong></td>
                        <td>${production.product_name || 'N/A'}</td>
                        <td><span class="badge bg-primary">${production.planned_quantity || 0} adet</span></td>
                        <td><span class="badge bg-success">${production.produced_quantity || 0} adet</span></td>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${progress.toFixed(1)}%</small>
                        </td>
                        <td>${formatDate(production.start_time)}</td>
                        <td><span class="badge bg-warning">${production.current_stage || 'Aktif'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewProduction(${production.id})">
                                <i class="fas fa-eye me-1"></i>GÃ¶rÃ¼ntÃ¼le
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            table.style.display = 'table';
            empty.style.display = 'none';
        }

        // YarÄ±da kalan Ã¼retimleri gÃ¶ster
        function displayPausedProductions(productions) {
            console.log('displayPausedProductions Ã§aÄŸrÄ±ldÄ±:', productions);
            const tbody = document.getElementById('pausedProductionsBody');
            const table = document.getElementById('pausedProductionsTable');
            const empty = document.getElementById('pausedProductionsEmpty');
            
            if (productions.length === 0) {
                console.log('YarÄ±da kalan Ã¼retim bulunamadÄ±, empty state gÃ¶steriliyor');
                showEmpty('pausedProductionsEmpty', true);
                return;
            }
            
            console.log('YarÄ±da kalan Ã¼retimler gÃ¶steriliyor:', productions.length, 'adet');
            
            tbody.innerHTML = productions.map(production => {
                const progress = production.planned_quantity > 0 ? 
                    ((production.produced_quantity || 0) / production.planned_quantity) * 100 : 0;
                
                return `
                    <tr>
                        <td><strong>#${production.id}</strong></td>
                        <td>${production.product_name || 'N/A'}</td>
                        <td><span class="badge bg-primary">${production.planned_quantity || 0} adet</span></td>
                        <td><span class="badge bg-success">${production.produced_quantity || 0} adet</span></td>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${progress.toFixed(1)}%</small>
                        </td>
                        <td>
                            <small class="text-muted">${formatDate(production.pause_time || production.updated_at)}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="resumeProductionFromList(${production.id})" title="Devam Et">
                                <i class="fas fa-play me-1"></i>Devam Et
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            table.style.display = 'table';
            empty.style.display = 'none';
        }

        // Tamamlanan Ã¼retimleri gÃ¶ster (bugÃ¼n)
        function displayCompletedProductions(productions) {
            console.log('displayCompletedProductions Ã§aÄŸrÄ±ldÄ± (bugÃ¼n):', productions);
            const tbody = document.getElementById('completedProductionsBody');
            const table = document.getElementById('completedProductionsTable');
            const empty = document.getElementById('completedProductionsEmpty');
            
            if (productions.length === 0) {
                console.log('BugÃ¼n tamamlanan Ã¼retim bulunamadÄ±, empty state gÃ¶steriliyor');
                showEmpty('completedProductionsEmpty', true);
                return;
            }
            
            console.log('BugÃ¼n tamamlanan Ã¼retimler gÃ¶steriliyor:', productions.length, 'adet');
            
            tbody.innerHTML = productions.map(production => {
                const progress = production.planned_quantity > 0 ? 
                    ((production.produced_quantity || 0) / production.planned_quantity) * 100 : 0;
                
                return `
                    <tr>
                        <td><strong>#${production.id}</strong></td>
                        <td>${production.product_name || 'N/A'}</td>
                        <td><span class="badge bg-primary">${production.planned_quantity || 0} adet</span></td>
                        <td><span class="badge bg-success">${production.produced_quantity || 0} adet</span></td>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                            <small class="text-muted">100%</small>
                        </td>
                        <td>
                            <small class="text-muted">${formatDate(production.completed_time || production.updated_at)}</small>
                        </td>
                        <td>
                            <span class="badge bg-success">TamamlandÄ±</span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            table.style.display = 'table';
            empty.style.display = 'none';
        }

        // ÃœrÃ¼nleri gÃ¶ster
        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            const empty = document.getElementById('productsEmpty');
            
            if (products.length === 0) {
                showEmpty('productsEmpty', true);
                return;
            }
            
            let html = '';
            products.forEach(product => {
                        html += `
                            <div class="col-lg-4 col-md-6 mb-4">
                                <div class="card product-card" style="cursor: pointer;" onclick="selectProductForProduction(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-box me-2"></i>${product.name || 'Bilinmeyen ÃœrÃ¼n'}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>ÃœrÃ¼n Kodu:</strong>
                                        <div class="text-primary fw-bold">${product.code || product.product_code || 'N/A'}</div>
                                            </div>
                                            <div class="col-6">
                                                <strong>Miktar:</strong>
                                        <div class="text-success fw-bold">${product.quantity || 0} adet</div>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <strong>SipariÅŸ No:</strong>
                                        <div class="text-muted small">${product.order_number || 'N/A'}</div>
                                            </div>
                                            <div class="col-6">
                                                <strong>MÃ¼ÅŸteri:</strong>
                                        <div class="text-muted small">${product.customer_name || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <strong>Plan ID:</strong>
                                        <div class="text-info small">${product.plan_id || 'N/A'}</div>
                                    </div>
                                    <div class="col-6">
                                        <strong>Ã–ncelik:</strong>
                                        <span class="badge ${getPriorityBadgeClass(product.priority)}">${getPriorityText(product.priority)}</span>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Teslim Tarihi:</strong>
                                    <div class="text-muted small">${formatDate(product.delivery_date)}</div>
                                </div>
                                <div class="mb-2">
                                    <strong>ÃœrÃ¼n DetayÄ±:</strong>
                                    <div class="text-muted small">${product.name || 'N/A'}</div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                <button class="btn btn-start-production" onclick="event.stopPropagation(); selectProductForProduction(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                            <i class="fas fa-play me-2"></i>Ãœretimi BaÅŸlat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
            });
            
            container.innerHTML = html;
            container.style.display = 'flex';
            empty.style.display = 'none';
        }

        // Ãœretim baÅŸlat
        function startProduction(orderId, productCode, quantity) {
            if (confirm(`${productCode} Ã¼rÃ¼nÃ¼ iÃ§in Ã¼retimi baÅŸlatmak istediÄŸinizden emin misiniz?`)) {
                // Burada Ã¼retim baÅŸlatma API'si Ã§aÄŸrÄ±lacak
                console.log('Ãœretim baÅŸlatÄ±lÄ±yor:', { orderId, productCode, quantity });
                alert('Ãœretim baÅŸlatÄ±ldÄ±!');
                loadData(); // Verileri yenile
            }
        }

        
        // SeÃ§ilen Ã¼rÃ¼nÃ¼ modal'da gÃ¶ster
        function selectProductForProduction(product) {
            console.log('SeÃ§ilen Ã¼rÃ¼n:', product);
            
            // SeÃ§ilen Ã¼rÃ¼n bilgisini global deÄŸiÅŸkende sakla (barkod kontrolÃ¼ iÃ§in)
            // Product ID'yi doÄŸru ÅŸekilde set et
            if (product.id) {
                window.selectedProduct = {
                    ...product,
                    id: product.id  // Product ID'yi doÄŸru ÅŸekilde set et
                };
            } else {
                window.selectedProduct = product;
            }
            
            // currentProductionId'yi set et
            currentProductionId = product.production_id;
            
            // SeÃ§ilen Ã¼rÃ¼n bilgisini modal'da gÃ¶ster
            document.getElementById('selectedProductName').textContent = product.name || product.product_name || 'N/A';
            document.getElementById('selectedProductCode').textContent = product.code || product.product_code || 'N/A';
            document.getElementById('selectedProductInfo').style.display = 'block';
            
            // Modal'Ä± aÃ§ ve seÃ§ilen Ã¼rÃ¼n bilgilerini gÃ¶ster
            try {
                const modalElement = document.getElementById('productionModal');
                if (modalElement) {
                    // Bootstrap 5 modal'Ä± aÃ§
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.error('Modal elementi bulunamadÄ±');
                    return;
                }
            } catch (error) {
                console.error('Modal aÃ§ma hatasÄ±:', error);
                // Alternatif yÃ¶ntem: jQuery kullan
                $('#productionModal').modal('show');
            }
            
            // Modal iÃ§eriÄŸini seÃ§ilen Ã¼rÃ¼n bilgileriyle doldur
            document.getElementById('modalProductCode').textContent = product.code || product.product_code || 'N/A';
            document.getElementById('modalProductName').textContent = product.name || product.product_name || 'N/A';
            document.getElementById('modalTargetQuantity').textContent = product.quantity || 0;
            document.getElementById('modalOrderNumber').textContent = product.order_number || 'N/A';
            document.getElementById('modalCustomerName').textContent = product.customer_name || 'N/A';
            
            // Eksik elementleri kontrol et ve ekle
            const deliveryDateElement = document.getElementById('modalDeliveryDate');
            if (deliveryDateElement) {
                deliveryDateElement.textContent = product.delivery_date ? new Date(product.delivery_date).toLocaleDateString('tr-TR') : 'N/A';
            }
            
            const priorityElement = document.getElementById('modalPriority');
            if (priorityElement) {
                const priority = product.priority === 'high' ? 'YÃ¼ksek' : product.priority === 'medium' ? 'Orta' : 'DÃ¼ÅŸÃ¼k';
                const priorityClass = product.priority === 'high' ? 'bg-danger' : product.priority === 'medium' ? 'bg-warning' : 'bg-info';
                priorityElement.textContent = priority;
                priorityElement.className = `badge ${priorityClass}`;
            }
            
            const planIdElement = document.getElementById('modalPlanId');
            if (planIdElement) {
                planIdElement.textContent = product.plan_id || 'N/A';
            }
            
            const productionIdElement = document.getElementById('modalProductionId');
            if (productionIdElement) {
                // GerÃ§ek product ID'yi al - product_details'ten
                let realProductId = 'N/A';
                if (product.product_details && product.product_details.length > 0) {
                    realProductId = product.product_details[0].id;
                } else if (product.product_id && product.product_id !== product.plan_id) {
                    // EÄŸer product_id plan_id'den farklÄ±ysa, product_id kullan
                    realProductId = product.product_id;
                } else {
                    // Son Ã§are: production_id
                    realProductId = product.production_id || 'N/A';
                }
                productionIdElement.textContent = realProductId;
                console.log('ðŸ”§ Modal Production ID set:', realProductId, 'Plan ID:', product.plan_id);
            }
            
            const plannedQuantityElement = document.getElementById('modalPlannedQuantity');
            if (plannedQuantityElement) {
                plannedQuantityElement.textContent = product.planned_quantity || 0;
            }
            
            const producedQuantity = product.produced_quantity || 0;
            document.getElementById('modalProducedQuantity').textContent = producedQuantity;
            console.log('Ãœretilen miktar:', producedQuantity);
            
            // Eksik bilgileri doldur
            const operatorElement = document.getElementById('modalOperator');
            if (operatorElement) {
                operatorElement.textContent = product.assigned_operator || 'AtanmamÄ±ÅŸ';
            }
            
            const productDetailElement = document.getElementById('modalProductDetail');
            if (productDetailElement) {
                productDetailElement.textContent = product.name || product.product_name || 'N/A';
            }
            
            const statusElement = document.getElementById('modalStatus');
            if (statusElement) {
                const status = product.status === 'active' ? 'Aktif' : product.status === 'completed' ? 'TamamlandÄ±' : product.status === 'paused' ? 'DuraklatÄ±ldÄ±' : 'Bilinmeyen';
                statusElement.textContent = status;
            }
            
            // Ä°lerleme hesapla
            const plannedQty = product.planned_quantity || 0;
            const producedQty = product.produced_quantity || 0;
            const progress = plannedQty > 0 ? Math.round((producedQty / plannedQty) * 100) : 0;
            
            const progressBarElement = document.getElementById('modalProgressBar');
            const progressTextElement = document.getElementById('modalProgressText');
            if (progressBarElement) {
                progressBarElement.style.width = progress + '%';
                progressBarElement.setAttribute('aria-valuenow', progress);
            }
            if (progressTextElement) {
                progressTextElement.textContent = progress + '%';
            }
            
            // Barkod bilgisini al
            loadBarcodeForProduct(product.code || product.product_code);
            
            // Ãœretim adedi girme alanÄ±nÄ± gizle (barkod okutulmadan Ã¶nce)
            hideQuantityInput();
            
            // Barkod alanÄ±nÄ± temizle ve sÄ±fÄ±rla
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                barcodeInput.value = '';
                barcodeInput.style.display = 'block';
            }
            
            // Barkod durumunu sÄ±fÄ±rla
            showBarcodeStatus('Barkod okuyucu ile okutun veya manuel girin', 'info');
        }
        
        // ÃœrÃ¼n barkodunu yÃ¼kle
        async function loadBarcodeForProduct(productCode) {
            if (!productCode || productCode === 'N/A') {
                document.getElementById('modalProductBarcode').textContent = 'N/A';
                return;
            }
            
            try {
                // Barkod arama baÅŸlÄ±yor
                const nihaiResponse = await fetch(`/api/nihai_urunler`);
                
                if (nihaiResponse.ok) {
                    const nihaiData = await nihaiResponse.json();
                    const nihaiProduct = nihaiData.find(p => p.kod === productCode);
                    
                    if (nihaiProduct && nihaiProduct.barkod) {
                        document.getElementById('modalProductBarcode').textContent = nihaiProduct.barkod;
                        return;
                    }
                }
                
                // EÄŸer nihai Ã¼rÃ¼nlerde bulunamadÄ±ysa yarÄ± mamullerde ara
                const yarimamulResponse = await fetch(`/api/yarimamuller`);
                
                if (yarimamulResponse.ok) {
                    const yarimamulData = await yarimamulResponse.json();
                    const yarimamulProduct = yarimamulData.find(p => p.kod === productCode);
                    
                    if (yarimamulProduct && yarimamulProduct.barkod) {
                        document.getElementById('modalProductBarcode').textContent = yarimamulProduct.barkod;
                        return;
                    }
                }
                
                // Barkod bulunamadÄ±
                document.getElementById('modalProductBarcode').textContent = 'N/A';
                
            } catch (error) {
                console.error('âŒ Barkod bilgisi alÄ±namadÄ±:', error);
                document.getElementById('modalProductBarcode').textContent = 'N/A';
            }
        }
        
        let currentProductionId = null;

        // Ãœretim gÃ¶rÃ¼ntÃ¼le ve ÃœreteceÄŸi ÃœrÃ¼nler bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        async function viewProduction(productionId) {
            console.log('Ãœretim gÃ¶rÃ¼ntÃ¼leniyor:', productionId);
            
            // GeÃ§ersiz ID kontrolÃ¼
            if (!productionId || productionId === 'undefined' || productionId === 'null') {
                console.error('GeÃ§ersiz Ã¼retim ID:', productionId);
                alert('GeÃ§ersiz Ã¼retim ID!');
                return;
            }
            
            try {
                // Aktif Ã¼retim detaylarÄ±nÄ± al
                const response = await fetch(`/api/active-productions/${productionId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API yanÄ±t hatasÄ±:', response.status, errorText);
                    throw new Error(`Ãœretim detaylarÄ± alÄ±namadÄ± (${response.status}): ${errorText}`);
                }
                
                const production = await response.json();
                console.log('Ãœretim detaylarÄ±:', production);
                console.log('Plan ID:', production.plan_id);
                
                // ÃœreteceÄŸi ÃœrÃ¼nler bÃ¶lÃ¼mÃ¼nÃ¼ bu Ã¼retimle gÃ¼ncelle
                await loadProductsForProduction(production);
                
            } catch (error) {
                console.error('Ãœretim detaylarÄ± yÃ¼kleme hatasÄ±:', error);
                alert('Ãœretim detaylarÄ± yÃ¼klenemedi: ' + error.message);
            }
        }
        
        // Belirli bir Ã¼retim iÃ§in Ã¼rÃ¼nleri yÃ¼kle
        async function loadProductsForProduction(production) {
            try {
                showLoading('productsLoading', true);
                
                // SipariÅŸ detaylarÄ±nÄ± al
                let productsWithDetails = [];
                console.log('loadProductsForProduction Ã§aÄŸrÄ±ldÄ±, plan_id:', production.plan_id);
                
                // Plan ID varsa Ã¶nce plan detaylarÄ±nÄ± al, sonra order_id'yi bul
                if (production.plan_id) {
                    try {
                        console.log('Plan detaylarÄ± alÄ±nÄ±yor, plan_id:', production.plan_id);
                        const planResponse = await fetch(`/api/production-plans/${production.plan_id}`);
                        console.log('Plan response status:', planResponse.status);
                        
                        if (planResponse.ok) {
                            const plan = await planResponse.json();
                            console.log('Plan detaylarÄ±:', plan);
                            
                            const orderId = plan.order_id;
                            console.log('Plan\'dan alÄ±nan order_id:', orderId);
                            
                            if (orderId) {
                                console.log('SipariÅŸ detaylarÄ± alÄ±nÄ±yor, order_id:', orderId);
                                const orderResponse = await fetch(`/api/orders/${orderId}`);
                                console.log('Order response status:', orderResponse.status);
                        
                                if (orderResponse.ok) {
                                    const order = await orderResponse.json();
                                    console.log('Ãœretim iÃ§in sipariÅŸ detayÄ±:', order);
                                    
                                    if (order.product_details) {
                                        let productDetails;
                                        try {
                                            productDetails = typeof order.product_details === 'string' 
                                                ? JSON.parse(order.product_details) 
                                                : order.product_details;
                                        } catch (parseError) {
                                            console.error('Product details parse hatasÄ±:', parseError);
                                            productDetails = [];
                                        }
                                        
                                        if (productDetails && productDetails.length > 0) {
                                            productDetails.forEach(product => {
                                                console.log('ÃœrÃ¼n detayÄ± iÅŸleniyor:', product);
                                                const productCode = product.code || product.product_code || 'N/A';
                                                console.log('ÃœrÃ¼n kodu:', productCode);
                                                productsWithDetails.push({
                                                    ...product,
                                                    // ÃœrÃ¼n kodunu doÄŸru alanlardan al
                                                    code: productCode,
                                                    name: product.name || product.product_name || 'Bilinmeyen ÃœrÃ¼n',
                                                    quantity: product.quantity || 0,
                                                    order_number: order.order_number,
                                                    customer_name: order.customer_name,
                                                    delivery_date: order.delivery_date,
                                                    priority: order.priority,
                                                    plan_id: production.plan_id,
                                                    plan_name: production.product_name,
                                                    production_id: production.id,
                                                    planned_quantity: production.planned_quantity,
                                                    produced_quantity: production.produced_quantity,
                                                    assigned_operator: production.assigned_operator || 'AtanmamÄ±ÅŸ',
                                                    status: production.status || 'active',
                                                    // Product ID'yi doÄŸru ÅŸekilde set et - order.product_details'den al
                                                    id: product.id  // Bu Product ID 1241 olmalÄ±
                                                });
                                            });
                                        }
                                    }
                                } else {
                                    console.error('SipariÅŸ detaylarÄ± alÄ±namadÄ±:', orderResponse.status);
                                }
                            } else {
                                console.error('Plan\'da order_id bulunamadÄ±');
                            }
                        } else {
                            console.error('Plan detaylarÄ± alÄ±namadÄ±:', planResponse.status);
                        }
                    } catch (error) {
                        console.error('Plan detayÄ± alÄ±namadÄ±:', error);
                    }
                } else {
                    console.error('Production\'da plan_id bulunamadÄ±');
                }
                
                console.log('SeÃ§ilen Ã¼retim Ã¼rÃ¼n detaylarÄ±:', productsWithDetails);
                updateStats('totalProductsCount', productsWithDetails.length);
                displayProducts(productsWithDetails);
                
            } catch (error) {
                console.error('ÃœrÃ¼nler yÃ¼kleme hatasÄ±:', error);
                showEmpty('productsEmpty', true);
            } finally {
                showLoading('productsLoading', false);
            }
        }

        function startProductionProcess(productionId) {
            currentProductionId = productionId;
            console.log('Ãœretim sÃ¼reci baÅŸlatÄ±lÄ±yor:', productionId);
            
            // Modal'Ä± aÃ§ ve Ã¼retim bilgilerini yÃ¼kle
            loadProductionForModal(productionId);
            const modal = new bootstrap.Modal(document.getElementById('productionModal'));
            modal.show();
        }

        // PlanÄ± kabul et ve aktif Ã¼retim oluÅŸtur
        async function startProductionFromPlan(planId, planName, quantity) {
            try {
                console.log('Plan kabul ediliyor:', planId, planName, quantity);
                
                // Ã–nce bu plan iÃ§in mevcut aktif Ã¼retim var mÄ± kontrol et
                // Mevcut aktif Ã¼retim kontrol ediliyor
                const existingProductionsResponse = await fetch('/api/active-productions');
                if (existingProductionsResponse.ok) {
                    const existingProductions = await existingProductionsResponse.json();
                    const existingProduction = existingProductions.find(p => p.plan_id === planId && p.status === 'active');
                    
                    if (existingProduction) {
                        console.log('âš ï¸ Bu plan iÃ§in zaten aktif Ã¼retim mevcut:', existingProduction);
                        alert('Bu plan iÃ§in zaten aktif Ã¼retim mevcut! Ãœretim ID: ' + existingProduction.id);
                        return;
                    }
                }
                
                // Plan durumunu 'approved' olarak gÃ¼ncelle
                const updateResponse = await fetch(`/api/production-plans/${planId}/update-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'approved' })
                });

                if (!updateResponse.ok) {
                    throw new Error('Plan durumu gÃ¼ncellenemedi');
                }

                // Plan iÃ§in aÅŸamalarÄ± oluÅŸtur
                const stagesResponse = await fetch(`/api/production-plans/${planId}/create-stages`, {
                    method: 'POST'
                });

                if (!stagesResponse.ok) {
                    console.warn('AÅŸamalar oluÅŸturulamadÄ±, devam ediliyor...');
                }

                // Aktif Ã¼retim oluÅŸtur
                const productionResponse = await fetch('/api/active-productions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plan_id: planId,
                        product_id: planId, // Zorunlu alan - plan_id'yi kullan
                        product_name: planName,
                        product_type: 'nihai', // Zorunlu alan
                        planned_quantity: quantity,
                        produced_quantity: 0,
                        status: 'active',
                        assigned_operator: 'Thunder Serisi OperatÃ¶r',
                        start_time: new Date().toISOString()
                    })
                });

                if (!productionResponse.ok) {
                    throw new Error('Aktif Ã¼retim oluÅŸturulamadÄ±');
                }

                const newProduction = await productionResponse.json();
                console.log('Aktif Ã¼retim oluÅŸturuldu:', newProduction);

                // SayfayÄ± yenile
                location.reload();

            } catch (error) {
                console.error('Plan kabul etme hatasÄ±:', error);
                alert('Plan kabul edilemedi: ' + error.message);
            }
        }

        // Modal iÃ§in Ã¼retim bilgilerini yÃ¼kle
        async function loadProductionForModal(productionId) {
            console.log('loadProductionForModal Ã§aÄŸrÄ±ldÄ±, productionId:', productionId);
            
            // GeÃ§ersiz ID kontrolÃ¼
            if (!productionId || productionId === 'undefined' || productionId === 'null') {
                console.error('GeÃ§ersiz Ã¼retim ID (modal):', productionId);
                alert('GeÃ§ersiz Ã¼retim ID!');
                return;
            }
            
            try {
                console.log('Aktif Ã¼retim detaylarÄ± alÄ±nÄ±yor, ID:', productionId);
                const response = await fetch(`/api/active-productions/${productionId}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API yanÄ±t hatasÄ± (modal):', response.status, errorText);
                    throw new Error(`Ãœretim detaylarÄ± alÄ±namadÄ± (${response.status}): ${errorText}`);
                }
                
                const production = await response.json();
                console.log('Modal iÃ§in Ã¼retim detaylarÄ±:', production);
                
                // SipariÅŸ detaylarÄ±nÄ± al (plan_id Ã¼zerinden)
                let productCode = production.product_name || 'N/A';
                let orderNumber = '#' + production.id;
                let planName = production.product_name || 'N/A'; // Plan adÄ± iÃ§in
                let customerName = 'N/A';
                let deliveryDate = 'N/A';
                let priority = 'BelirtilmemiÅŸ';
                let productDetail = production.product_name || 'N/A';
                let productBarcode = 'N/A'; // Barkod bilgisi
                let orderPriority = 0; // order deÄŸiÅŸkenini scope dÄ±ÅŸÄ±nda tanÄ±mla
                
                if (production.plan_id) {
                    try {
                        console.log('Plan detaylarÄ± alÄ±nÄ±yor (modal), plan_id:', production.plan_id);
                        const planResponse = await fetch(`/api/production-plans/${production.plan_id}`);
                        console.log('Plan response status (modal):', planResponse.status);
                        if (planResponse.ok) {
                            const plan = await planResponse.json();
                            console.log('Plan detaylarÄ± (modal):', plan);

                            const orderId = plan.order_id;
                            console.log('Plan\'dan alÄ±nan order_id (modal):', orderId);
                            if (orderId) {
                                console.log('SipariÅŸ detaylarÄ± alÄ±nÄ±yor (modal), order_id:', orderId);
                                const orderResponse = await fetch(`/api/orders/${orderId}`);
                                console.log('Order response status (modal):', orderResponse.status);
                                if (orderResponse.ok) {
                                    const order = await orderResponse.json();
                                    console.log('SipariÅŸ detaylarÄ± (modal):', order);
                            
                            // ÃœrÃ¼n kodunu product_details'den al
                            if (order.product_details) {
                                let productDetails;
                                try {
                                    // product_details string ise parse et
                                    productDetails = typeof order.product_details === 'string' 
                                        ? JSON.parse(order.product_details) 
                                        : order.product_details;
                                } catch (parseError) {
                                    console.error('Product details parse hatasÄ±:', parseError);
                                    productDetails = [];
                                }
                                
                                if (productDetails && productDetails.length > 0) {
                                    // GerÃ§ek Ã¼rÃ¼n kodunu al
                                    productCode = productDetails[0].code || productDetails[0].product_code || 'N/A';
                                    productDetail = productDetails[0].name || productDetails[0].product_name || production.product_name || 'N/A';
                                    console.log('GerÃ§ek Ã¼rÃ¼n kodu bulundu:', productCode);
                                    
                                    // Barkod bilgisini al - Ã¼rÃ¼n kodundan Ã¼rÃ¼n bilgilerini bul
                                    // ProductDetails kontrol ediliyor
                                    console.log('ðŸ” ProductDetails[0].code:', productDetails[0]?.code);
                                    
                                    // productCode zaten doÄŸru ÅŸekilde alÄ±nmÄ±ÅŸ, onu kullan
                                    if (productCode && productCode !== 'N/A') {
                                        try {
                                            console.log('ðŸ” Barkod arama baÅŸlÄ±yor...');
                                            console.log('ÃœrÃ¼n kodu (productCode):', productCode);
                                            console.log('ÃœrÃ¼n detayÄ±:', productDetails[0]);
                                            
                                            // Ã–nce nihai Ã¼rÃ¼nlerde ara
                                            console.log('ðŸ“¦ Nihai Ã¼rÃ¼nlerde aranÄ±yor...');
                                            const nihaiResponse = await fetch(`/api/nihai_urunler`);
                                            console.log('Nihai Ã¼rÃ¼nler API yanÄ±tÄ±:', nihaiResponse.status);
                                            
                                            if (nihaiResponse.ok) {
                                                const nihaiData = await nihaiResponse.json();
                                                console.log('Nihai Ã¼rÃ¼nler sayÄ±sÄ±:', nihaiData.length);
                                                console.log('Ä°lk 3 nihai Ã¼rÃ¼n:', nihaiData.slice(0, 3));
                                                
                                                const nihaiProduct = nihaiData.find(p => p.kod === productCode);
                                                console.log('Aranan Ã¼rÃ¼n kodu:', productCode);
                                                console.log('Bulunan nihai Ã¼rÃ¼n:', nihaiProduct);
                                                
                                                if (nihaiProduct && nihaiProduct.barkod) {
                                                    productBarcode = nihaiProduct.barkod;
                                                    console.log('âœ… Nihai Ã¼rÃ¼n barkod bulundu:', productBarcode);
                                                } else {
                                                    console.log('âŒ Nihai Ã¼rÃ¼nlerde barkod bulunamadÄ±');
                                                }
                                            } else {
                                                console.error('âŒ Nihai Ã¼rÃ¼nler API hatasÄ±:', nihaiResponse.status);
                                            }
                                            
                                            // EÄŸer nihai Ã¼rÃ¼nlerde bulunamadÄ±ysa yarÄ± mamullerde ara
                                            if (productBarcode === 'N/A') {
                                                console.log('ðŸ“¦ YarÄ± mamullerde aranÄ±yor...');
                                                const yarimamulResponse = await fetch(`/api/yarimamuller`);
                                                console.log('YarÄ± mamuller API yanÄ±tÄ±:', yarimamulResponse.status);
                                                
                                                if (yarimamulResponse.ok) {
                                                    const yarimamulData = await yarimamulResponse.json();
                                                    console.log('YarÄ± mamuller sayÄ±sÄ±:', yarimamulData.length);
                                                    
                                                    const yarimamulProduct = yarimamulData.find(p => p.kod === productCode);
                                                    console.log('Bulunan yarÄ± mamul:', yarimamulProduct);
                                                    
                                                    if (yarimamulProduct && yarimamulProduct.barkod) {
                                                        productBarcode = yarimamulProduct.barkod;
                                                        console.log('âœ… YarÄ± mamul barkod bulundu:', productBarcode);
                                                    } else {
                                                        console.log('âŒ YarÄ± mamullerde barkod bulunamadÄ±');
                                                    }
                                                } else {
                                                    console.error('âŒ YarÄ± mamuller API hatasÄ±:', yarimamulResponse.status);
                                                }
                                            }
                                            
                                            console.log('ðŸŽ¯ Final barkod deÄŸeri:', productBarcode);
                                        } catch (barcodeError) {
                                            console.error('âŒ Barkod bilgisi alÄ±namadÄ±:', barcodeError);
                                        }
                                    } else {
                                        console.log('âŒ ÃœrÃ¼n kodu bulunamadÄ±');
                                    }
                                }
                            }
                                    orderNumber = order.order_number || '#' + production.id;
                                    customerName = order.customer_name || 'N/A';
                                    deliveryDate = order.delivery_date ? new Date(order.delivery_date).toLocaleDateString('tr-TR') : 'N/A';
                                    orderPriority = order.priority || 0;
                                    priority = getPriorityText(orderPriority);
                                    // Plan adÄ±nÄ± oluÅŸtur: Plan-{plan_id}-{customer_name}
                                    planName = `Plan-${production.plan_id}-${order.customer_name || 'UNKNOWN'}`;
                                } else {
                                    console.error('SipariÅŸ detaylarÄ± alÄ±namadÄ± (modal), status:', orderResponse.status);
                                }
                            } else {
                                console.error('Plan\'da order_id bulunamadÄ± (modal)');
                            }
                        } else {
                            console.error('Plan detaylarÄ± alÄ±namadÄ± (modal), status:', planResponse.status);
                        }
                    } catch (error) {
                        console.error('SipariÅŸ detaylarÄ± alÄ±namadÄ± (modal):', error);
                    }
                }
                
                // Modal alanlarÄ±nÄ± doldur (detaylÄ± kart tasarÄ±mÄ±na uygun)
                document.getElementById('modalProductName').textContent = productDetail; // ÃœrÃ¼n adÄ± (header'da)
                document.getElementById('modalProductCode').textContent = productCode; // ÃœrÃ¼n kodu
                document.getElementById('modalProductBarcode').textContent = productBarcode; // Barkod
                document.getElementById('modalOrderNumber').textContent = orderNumber; // SipariÅŸ no
                document.getElementById('modalCustomerName').textContent = customerName; // MÃ¼ÅŸteri
                document.getElementById('modalPlanId').textContent = production.plan_id || 'N/A'; // Plan ID
                document.getElementById('modalPriority').textContent = priority; // Ã–ncelik
                document.getElementById('modalPriority').className = `badge ${getPriorityBadgeClass(orderPriority)}`; // Ã–ncelik badge sÄ±nÄ±fÄ±
                document.getElementById('modalDeliveryDate').textContent = deliveryDate; // Teslim tarihi
                document.getElementById('modalTargetQuantity').textContent = (production.planned_quantity || 0) + ' adet'; // Miktar
                document.getElementById('modalProducedQuantity').textContent = (production.produced_quantity || 0) + ' adet'; // Ãœretilen
                document.getElementById('modalOperator').textContent = production.assigned_operator || 'N/A'; // OperatÃ¶r
                document.getElementById('modalProductDetail').textContent = productDetail; // ÃœrÃ¼n detayÄ±
                
                // Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
                const progress = production.planned_quantity > 0 ? 
                    ((production.produced_quantity || 0) / production.planned_quantity) * 100 : 0;
                
                document.getElementById('modalProgressBar').style.width = progress + '%';
                document.getElementById('modalProgressText').textContent = progress.toFixed(1) + '%';
                
                // Ãœretimi Tamamla butonunu kontrol et
                const completeBtn = document.getElementById('completeBtn');
                const plannedQuantity = production.planned_quantity || 0;
                const producedQuantity = production.produced_quantity || 0;
                
                if (producedQuantity >= plannedQuantity && plannedQuantity > 0) {
                    completeBtn.disabled = false;
                    completeBtn.className = 'btn btn-primary';
                    completeBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Ãœretimi Tamamla';
                } else {
                    completeBtn.disabled = true;
                    completeBtn.className = 'btn btn-secondary';
                    const remaining = plannedQuantity - producedQuantity;
                    completeBtn.innerHTML = `<i class="fas fa-lock me-2"></i>Ãœretimi Tamamla (${remaining} adet eksik)`;
                }
                
            } catch (error) {
                console.error('Modal Ã¼retim bilgileri yÃ¼kleme hatasÄ±:', error);
                alert('Ãœretim bilgileri yÃ¼klenemedi: ' + error.message);
            }
        }

        // Barkod iÅŸleme
        async function processBarcode() {
            const barcodeInput = document.getElementById('barcodeInput');
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                showBarcodeStatus('LÃ¼tfen bir barkod giriniz!', 'warning');
                return;
            }
            
            showBarcodeStatus('Barkod doÄŸrulanÄ±yor...', 'info');
            
            try {
                // Barkod veritabanÄ±ndan doÄŸrula
                const isValidBarcode = await validateBarcode(barcode);
                
                if (isValidBarcode) {
                    // ÃœrÃ¼n bilgilerini al
                    const productInfo = window.currentBarcodeProduct;
                    if (productInfo) {
                        showBarcodeStatus(`Barkod geÃ§erli! ÃœrÃ¼n: ${productInfo.name} (${productInfo.code}) - Ãœretim adedini girin.`, 'success');
                    } else {
                        showBarcodeStatus('Barkod geÃ§erli! Ãœretim adedini girin.', 'success');
                    }
                    
                    // Ãœretim adedi girme alanÄ±nÄ± gÃ¶ster ve temizle
                    showQuantityInput();
                    const quantityInput = document.getElementById('quantityInput');
                    quantityInput.value = '1';
                    quantityInput.focus();
                    
                    // Barkod alanÄ±nÄ± temizle
                    barcodeInput.value = '';
                    
                    // Ãœretimi Tamamla butonunu gÃ¼ncelle
                    updateCompleteButton();
                } else {
                    showBarcodeStatus('Barkod geÃ§ersiz! LÃ¼tfen geÃ§erli bir barkod okutun.', 'danger');
                    barcodeInput.value = '';
                    barcodeInput.focus();
                }
            } catch (error) {
                console.error('Barkod doÄŸrulama hatasÄ±:', error);
                showBarcodeStatus('Barkod doÄŸrulama hatasÄ±!', 'danger');
            }
        }
        
        // Ãœretim adedi girme alanÄ±nÄ± gÃ¶ster
        function showQuantityInput() {
            const quantitySection = document.getElementById('quantityInputSection');
            const quantityInput = document.getElementById('quantityInput');
            
            if (quantitySection) {
                quantitySection.style.display = 'block';
                quantityInput.focus();
                quantityInput.select();
            }
        }

        // Ãœretimi Tamamla butonunu gÃ¼ncelle
        function updateCompleteButton() {
            if (!currentProductionId) return;
            
            // Mevcut Ã¼retim bilgilerini al
            fetch(`/api/active-productions/${currentProductionId}`)
                .then(response => response.json())
                .then(production => {
                    const completeBtn = document.getElementById('completeBtn');
                    const plannedQuantity = production.planned_quantity || 0;
                    const producedQuantity = production.produced_quantity || 0;
                    
                    if (producedQuantity >= plannedQuantity && plannedQuantity > 0) {
                        completeBtn.disabled = false;
                        completeBtn.className = 'btn btn-primary';
                        completeBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Ãœretimi Tamamla';
                    } else {
                        completeBtn.disabled = true;
                        completeBtn.className = 'btn btn-secondary';
                        const remaining = plannedQuantity - producedQuantity;
                        completeBtn.innerHTML = `<i class="fas fa-lock me-2"></i>Ãœretimi Tamamla (${remaining} adet eksik)`;
                    }
                })
                .catch(error => {
                    console.error('Buton gÃ¼ncelleme hatasÄ±:', error);
                });
        }
        
        // Malzemeleri tÃ¼ket
        async function consumeMaterialsForProduction(materials, quantity) {
            for (const material of materials) {
                if (material.required > 0) {
                    try {
                        const response = await fetch('/api/stock/consume', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                product_id: material.material_id,
                                product_type: material.material_type,
                                quantity: material.required,
                                production_id: currentProductionId,
                                operator_id: 'OPERATOR-001' // GerÃ§ek operatÃ¶r ID'si buraya gelecek
                            })
                        });
                        
                        const result = await response.json();
                        console.log(`Malzeme tÃ¼ketildi: ${material.material_name} - ${material.required} ${material.unit}`);
                    } catch (error) {
                        console.error(`Malzeme tÃ¼ketim hatasÄ±: ${material.material_name}`, error);
                    }
                }
            }
        }
        
        // Ãœretim adedi ekleme
        async function addProductionQuantity() {
            const quantityInput = document.getElementById('quantityInput');
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (quantity < 1) {
                showBarcodeStatus('LÃ¼tfen geÃ§erli bir adet girin!', 'warning');
                return;
            }
            
            // currentProductionId kontrolÃ¼
            console.log('currentProductionId:', currentProductionId);
            if (!currentProductionId) {
                showBarcodeStatus('Ã–nce bir Ã¼retim seÃ§in!', 'danger');
                return;
            }
            
            // Mevcut Ã¼retim bilgilerini al ve miktar kontrolÃ¼ yap
            try {
                const productionResponse = await fetch(`/api/active-productions/${currentProductionId}`);
                if (!productionResponse.ok) {
                    throw new Error('Ãœretim detaylarÄ± alÄ±namadÄ±');
                }
                const production = await productionResponse.json();
                
                const plannedQuantity = production.planned_quantity || 0;
                const currentProduced = production.produced_quantity || 0;
                const newTotal = currentProduced + quantity;
                
                if (newTotal > plannedQuantity) {
                    const remaining = plannedQuantity - currentProduced;
                    showBarcodeStatus(`Hata! Planlanan miktar: ${plannedQuantity} adet, Mevcut Ã¼retim: ${currentProduced} adet. En fazla ${remaining} adet daha Ã¼retebilirsiniz!`, 'danger');
                    return;
                }
                
                // Stok kontrolÃ¼ yap
                showBarcodeStatus('Malzeme kontrolÃ¼ yapÄ±lÄ±yor...', 'info');
                
                try {
                    // ÃœrÃ¼n ID'sini al - Ã¶nce modal'dan, sonra production'dan
                    let productId = document.getElementById('modalProductionId')?.textContent;
                    
                    // EÄŸer modal'da yoksa, production'dan al ama dikkatli ol
                    if (!productId || productId === 'N/A') {
                        // window.selectedProduct'tan al (en gÃ¼ncel ve doÄŸru veri)
                        if (window.selectedProduct && window.selectedProduct.id) {
                            productId = window.selectedProduct.id;
                            console.log('âœ… Product ID selectedProduct\'tan alÄ±ndÄ±:', productId);
                        } else if (production.product_id) {
                            // production.product_id kullan (veritabanÄ±ndan gelen doÄŸru veri)
                            productId = production.product_id;
                            console.log('âœ… Product ID production.product_id\'den alÄ±ndÄ±:', productId);
                        } else {
                            // Son Ã§are: modal'dan veya production'dan
                            productId = production.product_id;
                            console.log('âš ï¸ Product ID son Ã§are olarak alÄ±ndÄ±:', productId);
                        }
                    }
                    
                    console.log('ðŸ” Product ID belirlendi:', productId, 'Plan ID:', production.plan_id);
                    
                    if (!productId || productId === 'N/A') {
                        showBarcodeStatus('ÃœrÃ¼n ID bulunamadÄ±!', 'danger');
                        return;
                    }
                    
                    // Malzeme kontrolÃ¼ yap
                    const materialCheckResponse = await fetch('/api/production/check-materials', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_id: productId,
                            product_type: 'nihai',
                            quantity: quantity
                        })
                    });
                    
                    const materialCheck = await materialCheckResponse.json();
                    
                    if (!materialCheck.can_produce) {
                        // Yetersiz malzeme uyarÄ±sÄ±
                        let warningMessage = 'Yetersiz malzeme! Ãœretim yapÄ±lamaz.\n\n';
                        materialCheck.materials.forEach(material => {
                            if (!material.sufficient) {
                                warningMessage += `âŒ ${material.material_name}: ${material.required} ${material.unit} gerekli, ${material.available} ${material.unit} mevcut\n`;
                            }
                        });
                        
                        showBarcodeStatus(warningMessage, 'danger');
                        return;
                    }
                    
                    // Malzeme yeterli, stok dÃ¼ÅŸme iÅŸlemi
                    await consumeMaterialsForProduction(materialCheck.materials, quantity);
                    
                } catch (stockError) {
                    console.error('Stok kontrolÃ¼ hatasÄ±:', stockError);
                    showBarcodeStatus('Stok kontrolÃ¼ yapÄ±lamadÄ±, Ã¼retim devam ediyor...', 'warning');
                }
                
                showBarcodeStatus(`${quantity} adet Ã¼retim ekleniyor...`, 'info');
                
                // Ãœretim miktarÄ±nÄ± artÄ±r
                await updateProducedQuantity(quantity);
                
                // ÃœrÃ¼n bilgilerini al ve gÃ¶ster
                const productInfo = window.currentBarcodeProduct;
                if (productInfo) {
                    showBarcodeStatus(`${quantity} adet ${productInfo.name} (${productInfo.code}) Ã¼retimi baÅŸarÄ±yla eklendi! Tekrar barkod okutun.`, 'success');
                } else {
                    showBarcodeStatus(`${quantity} adet Ã¼retim baÅŸarÄ±yla eklendi! Tekrar barkod okutun.`, 'success');
                }
                
                // AlanlarÄ± temizle ve gizle
                quantityInput.value = '1';
                hideQuantityInput();
                
                // Barkod alanÄ±na odaklan
                const barcodeInput = document.getElementById('barcodeInput');
                barcodeInput.focus();
                
                // Ãœretimi Tamamla butonunu gÃ¼ncelle
                updateCompleteButton();
                
            } catch (error) {
                console.error('Ãœretim adedi ekleme hatasÄ±:', error);
                showBarcodeStatus('Ãœretim adedi eklenemedi!', 'danger');
            }
        }
        
        // Ãœretim adedi girme alanÄ±nÄ± gizle
        function hideQuantityInput() {
            const quantitySection = document.getElementById('quantityInputSection');
            if (quantitySection) {
                quantitySection.style.display = 'none';
            }
        }
        
        // Barkod doÄŸrulama - Sadece seÃ§ilen Ã¼rÃ¼ne ait barkodlarÄ± kabul et
        async function validateBarcode(barcode) {
            try {
                console.log('Barkod doÄŸrulanÄ±yor:', barcode);
                
                // SeÃ§ilen Ã¼rÃ¼n bilgisini kontrol et
                if (!window.selectedProduct) {
                    console.error('SeÃ§ilen Ã¼rÃ¼n bilgisi bulunamadÄ±');
                    showBarcodeStatus('Ã–nce bir Ã¼rÃ¼n seÃ§in!', 'danger');
                    return false;
                }
                
                const selectedProduct = window.selectedProduct;
                console.log('SeÃ§ilen Ã¼rÃ¼n:', selectedProduct);
                
                // GerÃ§ek zamanlÄ± barkod kontrolÃ¼ - veritabanÄ±ndan direkt kontrol
                const response = await fetch(`/api/debug/product-barcodes?barcode=${barcode}`);
                if (!response.ok) {
                    console.error('Barkod kontrol API hatasÄ±:', response.status);
                    return false;
                }
                
                const data = await response.json();
                console.log('Barkod kontrol sonucu:', data);
                
                // Nihai Ã¼rÃ¼nlerde barkod var mÄ±?
                if (data.nihai_urunler && data.nihai_urunler.length > 0) {
                    const product = data.nihai_urunler[0];
                    console.log('Nihai Ã¼rÃ¼n barkod eÅŸleÅŸmesi bulundu:', product);
                    
                    // SeÃ§ilen Ã¼rÃ¼n kodu ile eÅŸleÅŸiyor mu kontrol et
                    if (product.kod === selectedProduct.code || product.kod === selectedProduct.product_code) {
                        console.log('âœ… Barkod seÃ§ilen Ã¼rÃ¼ne ait!');
                        
                        // ÃœrÃ¼n kodunu global deÄŸiÅŸkende sakla
                        window.currentBarcodeProduct = {
                            type: 'nihai',
                            id: product.id,
                            code: product.kod,
                            name: product.ad,
                            barcode: product.barkod
                        };
                        
                        return true;
                    } else {
                        console.log('âŒ Barkod seÃ§ilen Ã¼rÃ¼ne ait deÄŸil!');
                        console.log('SeÃ§ilen Ã¼rÃ¼n kodu:', selectedProduct.code || selectedProduct.product_code);
                        console.log('Barkod Ã¼rÃ¼n kodu:', product.kod);
                        showBarcodeStatus('Bu barkod seÃ§ilen Ã¼rÃ¼ne ait deÄŸil!', 'danger');
                        return false;
                    }
                }
                
                // YarÄ±mamul Ã¼rÃ¼nlerde barkod var mÄ±?
                if (data.yarimamuller && data.yarimamuller.length > 0) {
                    const product = data.yarimamuller[0];
                    console.log('YarÄ±mamul barkod eÅŸleÅŸmesi bulundu:', product);
                    
                    // SeÃ§ilen Ã¼rÃ¼n kodu ile eÅŸleÅŸiyor mu kontrol et
                    if (product.kod === selectedProduct.code || product.kod === selectedProduct.product_code) {
                        console.log('âœ… Barkod seÃ§ilen Ã¼rÃ¼ne ait!');
                        
                        // ÃœrÃ¼n kodunu global deÄŸiÅŸkende sakla
                        window.currentBarcodeProduct = {
                            type: 'yarimamul',
                            id: product.id,
                            code: product.kod,
                            name: product.ad,
                            barcode: product.barkod
                        };
                        
                        return true;
                    } else {
                        console.log('âŒ Barkod seÃ§ilen Ã¼rÃ¼ne ait deÄŸil!');
                        console.log('SeÃ§ilen Ã¼rÃ¼n kodu:', selectedProduct.code || selectedProduct.product_code);
                        console.log('Barkod Ã¼rÃ¼n kodu:', product.kod);
                        showBarcodeStatus('Bu barkod seÃ§ilen Ã¼rÃ¼ne ait deÄŸil!', 'danger');
                        return false;
                    }
                }
                
                console.log('Barkod eÅŸleÅŸmedi - veritabanÄ±nda bulunamadÄ±');
                showBarcodeStatus('Barkod veritabanÄ±nda bulunamadÄ±!', 'danger');
                return false;
            } catch (error) {
                console.error('Barkod doÄŸrulama hatasÄ±:', error);
                showBarcodeStatus('Barkod doÄŸrulama hatasÄ±!', 'danger');
                return false;
            }
        }
        
        // Barkod durumu gÃ¶sterme
        function showBarcodeStatus(message, type) {
            const statusDiv = document.getElementById('barcodeStatus');
            const messageSpan = document.getElementById('barcodeMessage');
            
            if (statusDiv && messageSpan) {
                statusDiv.className = `alert alert-${type}`;
                messageSpan.textContent = message;
                statusDiv.style.display = 'block';
                
                // 3 saniye sonra gizle
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Ãœretilen miktarÄ± gÃ¼ncelle
        async function updateProducedQuantity(additionalQuantity = 1) {
            if (!currentProductionId) return;
            
            try {
                // Mevcut Ã¼retim bilgilerini al
                const response = await fetch(`/api/active-productions/${currentProductionId}`);
                if (!response.ok) return;
                
                const production = await response.json();
                const newProducedQuantity = (production.produced_quantity || 0) + additionalQuantity;
                
                // VeritabanÄ±nda Ã¼retilen miktarÄ± gÃ¼ncelle
                const updateResponse = await fetch(`/api/active-productions/${currentProductionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        produced_quantity: newProducedQuantity,
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Ãœretim miktarÄ± gÃ¼ncellenemedi');
                }
                
                // UI'yi gÃ¼ncelle
                document.getElementById('modalProducedQuantity').textContent = newProducedQuantity + ' adet';
                
                // Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
                const progress = production.planned_quantity > 0 ? 
                    (newProducedQuantity / production.planned_quantity) * 100 : 0;
                
                document.getElementById('modalProgressBar').style.width = progress + '%';
                document.getElementById('modalProgressText').textContent = progress.toFixed(1) + '%';
                
                // Hedef miktara ulaÅŸÄ±ldÄ± mÄ± kontrol et
                if (newProducedQuantity >= production.planned_quantity) {
                    document.getElementById('barcodeMessage').textContent = 'ðŸŽ‰ Hedef miktara ulaÅŸÄ±ldÄ±! Ãœretim tamamlanabilir.';
                    document.getElementById('barcodeStatus').className = 'alert alert-success';
                    
                    // Barkod okutma alanÄ±nÄ± gizle
                    document.getElementById('barcodeInput').style.display = 'none';
                    document.getElementById('quantityInputSection').style.display = 'none';
                    document.getElementById('barcodeStatus').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Ãœretilen miktar gÃ¼ncelleme hatasÄ±:', error);
                throw error; // Hata yukarÄ±ya fÄ±rlatÄ±lsÄ±n
            }
        }

        // Barkod alanÄ±nÄ± temizle
        function clearBarcode() {
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeStatus').style.display = 'none';
            document.getElementById('barcodeInput').focus();
        }

        // Ãœretimi tamamla
        async function completeProduction() {
            if (!currentProductionId) return;
            
            try {
                console.log('Ãœretim tamamlanÄ±yor:', currentProductionId);
                
                // Ã–nce Ã¼retim detaylarÄ±nÄ± al
                const productionResponse = await fetch(`/api/active-productions/${currentProductionId}`);
                if (!productionResponse.ok) {
                    throw new Error('Ãœretim detaylarÄ± alÄ±namadÄ±');
                }
                const production = await productionResponse.json();
                
                // Miktar kontrolÃ¼ yap
                const plannedQuantity = production.planned_quantity || 0;
                const producedQuantity = production.produced_quantity || 0;
                
                console.log('Miktar kontrolÃ¼:', {
                    planned: plannedQuantity,
                    produced: producedQuantity
                });
                
                if (producedQuantity < plannedQuantity) {
                    const remaining = plannedQuantity - producedQuantity;
                    alert(`Ãœretim tamamlanamaz!\n\nPlanlanan miktar: ${plannedQuantity} adet\nÃœretilen miktar: ${producedQuantity} adet\nEksik miktar: ${remaining} adet\n\nLÃ¼tfen eksik miktarÄ± Ã¼retin.`);
                    return;
                }
                
                if (confirm(`Ãœretimi tamamlamak istediÄŸinizden emin misiniz?\n\nPlanlanan: ${plannedQuantity} adet\nÃœretilen: ${producedQuantity} adet`)) {
                    
                    // Ãœretim durumunu "completed" olarak gÃ¼ncelle
                    const response = await fetch(`/api/active-productions/${currentProductionId}/complete`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'completed',
                            completed_time: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        // Planlanan Ã¼rÃ¼nlerde durumu gÃ¼ncelle
                        if (production.plan_id) {
                            await updateProductionPlanStatus(production.plan_id, 'completed');
                            
                            // SipariÅŸ durumunu da gÃ¼ncelle
                            await updateOrderStatusFromPlan(production.plan_id, 'completed');
                        }
                        
                        // Modal'Ä± kapat
                        const modal = bootstrap.Modal.getInstance(document.getElementById('productionModal'));
                        modal.hide();
                        
                        // Verileri yenile
                        loadData();
                        
                        alert('Ãœretim baÅŸarÄ±yla tamamlandÄ±! Planlanan Ã¼rÃ¼nler ve sipariÅŸ durumu gÃ¼ncellendi.');
                    } else {
                        const error = await response.json();
                        console.error('Ãœretim tamamlama hatasÄ±:', response.status, error);
                        alert('Ãœretim tamamlanamadÄ±: ' + (error.message || 'Bilinmeyen hata'));
                    }
                }
                
            } catch (error) {
                console.error('Ãœretim tamamlama hatasÄ±:', error);
                alert('Ãœretim tamamlanÄ±rken hata oluÅŸtu: ' + error.message);
            }
        }

        // Planlanan Ã¼rÃ¼n durumunu gÃ¼ncelle
        async function updateProductionPlanStatus(planId, status) {
            try {
                console.log('Plan durumu gÃ¼ncelleniyor:', planId, status);
                
                const response = await fetch(`/api/production-plans/${planId}/update-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    console.log('Plan durumu baÅŸarÄ±yla gÃ¼ncellendi');
                } else {
                    const error = await response.json();
                    console.error('Plan durumu gÃ¼ncelleme hatasÄ±:', response.status, error);
                }
                
            } catch (error) {
                console.error('Plan durumu gÃ¼ncelleme hatasÄ±:', error);
            }
        }

        // Plan ID'den sipariÅŸ durumunu gÃ¼ncelle
        async function updateOrderStatusFromPlan(planId, status) {
            try {
                console.log('Plan ID\'den sipariÅŸ durumu gÃ¼ncelleniyor:', planId, status);
                
                // Ã–nce plan detaylarÄ±nÄ± al
                const planResponse = await fetch(`/api/production-plans/${planId}`);
                if (!planResponse.ok) {
                    console.error('Plan detaylarÄ± alÄ±namadÄ±:', planResponse.status);
                    return;
                }
                
                const plan = await planResponse.json();
                const orderId = plan.order_id;
                
                if (!orderId) {
                    console.error('Plan\'da order_id bulunamadÄ±');
                    return;
                }
                
                console.log('SipariÅŸ durumu gÃ¼ncelleniyor:', orderId, status);
                
                // SipariÅŸ durumunu gÃ¼ncelle
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    console.log('SipariÅŸ durumu baÅŸarÄ±yla gÃ¼ncellendi');
                } else {
                    const error = await response.json();
                    console.error('SipariÅŸ durumu gÃ¼ncelleme hatasÄ±:', response.status, error);
                }
                
            } catch (error) {
                console.error('SipariÅŸ durumu gÃ¼ncelleme hatasÄ±:', error);
            }
        }


        // Ãœretimi duraklat
        async function pauseProduction() {
            if (!currentProductionId) return;
            
            if (confirm('Ãœretimi duraklatmak istediÄŸinizden emin misiniz? Daha sonra devam edebilirsiniz.')) {
                try {
                    console.log('Ãœretim duraklatÄ±lÄ±yor:', currentProductionId);
                    
                    // Ã–nce mevcut Ã¼retim detaylarÄ±nÄ± al
                    const productionResponse = await fetch(`/api/active-productions/${currentProductionId}`);
                    if (!productionResponse.ok) {
                        throw new Error('Ãœretim detaylarÄ± alÄ±namadÄ±');
                    }
                    const production = await productionResponse.json();
                    
                    const response = await fetch(`/api/active-productions/${currentProductionId}/pause`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'paused',
                            pause_time: new Date().toISOString(),
                            produced_quantity: production.produced_quantity || 0 // Mevcut Ã¼retilen miktarÄ± koru
                        })
                    });
                    
                    if (response.ok) {
                        // Modal'Ä± kapat
                        const modal = bootstrap.Modal.getInstance(document.getElementById('productionModal'));
                        modal.hide();
                        
                        // Verileri yenile
                        loadData();
                        
                        alert('Ãœretim baÅŸarÄ±yla duraklatÄ±ldÄ±! YarÄ±da kalan Ã¼retimler bÃ¶lÃ¼mÃ¼nden devam edebilirsiniz.');
                    } else {
                        const error = await response.json();
                        console.error('Ãœretim duraklatma hatasÄ±:', response.status, error);
                        alert('Ãœretim duraklatÄ±lamadÄ±: ' + (error.message || 'Bilinmeyen hata'));
                    }
                    
                } catch (error) {
                    console.error('Ãœretim duraklatma hatasÄ±:', error);
                    alert('Ãœretim duraklatÄ±lÄ±rken hata oluÅŸtu: ' + error.message);
                }
            }
        }

        // Ãœretime devam et (modal iÃ§inden)
        async function resumeProduction() {
            if (!currentProductionId) return;
            
            try {
                console.log('Ãœretime devam ediliyor:', currentProductionId);
                
                // Ã–nce mevcut Ã¼retim detaylarÄ±nÄ± al
                const productionResponse = await fetch(`/api/active-productions/${currentProductionId}`);
                if (!productionResponse.ok) {
                    throw new Error('Ãœretim detaylarÄ± alÄ±namadÄ±');
                }
                const production = await productionResponse.json();
                
                const response = await fetch(`/api/active-productions/${currentProductionId}/resume`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'active',
                        resume_time: new Date().toISOString(),
                        produced_quantity: production.produced_quantity || 0 // Mevcut Ã¼retilen miktarÄ± koru
                    })
                });
                
                if (response.ok) {
                    // ButonlarÄ± gÃ¼ncelle
                    document.getElementById('pauseBtn').style.display = 'inline-block';
                    document.getElementById('resumeBtn').style.display = 'none';
                    
                } else {
                    const error = await response.json();
                    console.error('Ãœretime devam etme hatasÄ±:', response.status, error);
                    alert('Ãœretime devam edilemedi: ' + (error.message || 'Bilinmeyen hata'));
                }
                
            } catch (error) {
                console.error('Ãœretime devam etme hatasÄ±:', error);
                alert('Ãœretime devam edilirken hata oluÅŸtu: ' + error.message);
            }
        }

        // YarÄ±da kalan Ã¼retimlerden devam et
        async function resumeProductionFromList(productionId) {
            try {
                    console.log('YarÄ±da kalan Ã¼retime devam ediliyor:', productionId);
                    
                    // Ã–nce mevcut Ã¼retim detaylarÄ±nÄ± al
                    const productionResponse = await fetch(`/api/active-productions/${productionId}`);
                    if (!productionResponse.ok) {
                        throw new Error('Ãœretim detaylarÄ± alÄ±namadÄ±');
                    }
                    const production = await productionResponse.json();
                    
                    const response = await fetch(`/api/active-productions/${productionId}/resume`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'active',
                            resume_time: new Date().toISOString(),
                            produced_quantity: production.produced_quantity || 0 // Mevcut Ã¼retilen miktarÄ± koru
                        })
                    });
                    
                    if (response.ok) {
                        // Ãœretim modalÄ±nÄ± aÃ§
                        currentProductionId = productionId;
                        loadProductionForModal(productionId);
                        const modal = new bootstrap.Modal(document.getElementById('productionModal'));
                        modal.show();
                        
                        // Verileri yenile
                        loadData();
                        
                    } else {
                        const error = await response.json();
                        console.error('Ãœretime devam etme hatasÄ±:', response.status, error);
                        alert('Ãœretime devam edilemedi: ' + (error.message || 'Bilinmeyen hata'));
                    }
                    
            } catch (error) {
                console.error('Ãœretime devam etme hatasÄ±:', error);
                alert('Ãœretime devam edilirken hata oluÅŸtu: ' + error.message);
            }
        }

        // Barkod input'u iÃ§in Enter tuÅŸu desteÄŸi
        document.addEventListener('DOMContentLoaded', function() {
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                // Enter tuÅŸu ile iÅŸleme
                barcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        processBarcode();
                    }
                });
                
                // Otomatik iÅŸleme - barkod okutulduktan sonra
                barcodeInput.addEventListener('input', function(e) {
                    const barcode = e.target.value.trim();
                    // Barkod uzunluÄŸu 8 karakterden fazla ise otomatik iÅŸle
                    if (barcode.length >= 8) {
                        setTimeout(() => {
                            processBarcode();
                        }, 500); // 500ms bekle
                    }
                });
                
                // Ãœretim adedi input'u iÃ§in Enter tuÅŸu desteÄŸi
                const quantityInput = document.getElementById('quantityInput');
                if (quantityInput) {
                    quantityInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addProductionQuantity();
                        }
                    });
                }
            }
        });
        


        // Ã‡Ä±kÄ±ÅŸ yap
        function logout() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                localStorage.removeItem('currentOperator');
                window.location.href = 'operator-login.html';
            }
        }
        

        // YardÄ±mcÄ± fonksiyonlar
        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }

        function showEmpty(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }

        function updateStats(elementId, value) {
            document.getElementById(elementId).textContent = value;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('tr-TR');
        }

        function getPriorityBadgeClass(priority) {
            // SayÄ±sal deÄŸerleri de destekle
            if (typeof priority === 'number') {
                switch(priority) {
                    case 1: return 'bg-success'; // DÃ¼ÅŸÃ¼k - YeÅŸil
                    case 2: return 'bg-info'; // Orta - Mavi
                    case 3: return 'bg-warning'; // YÃ¼ksek - SarÄ±
                    case 4: return 'bg-danger'; // ACÄ°L - KÄ±rmÄ±zÄ±
                    default: return 'bg-secondary';
                }
            }
            
            // String deÄŸerleri destekle
            switch(priority) {
                case 'urgent': return 'bg-danger'; // ACÄ°L - KÄ±rmÄ±zÄ±
                case 'high': return 'bg-warning'; // YÃ¼ksek - SarÄ±
                case 'medium': return 'bg-info'; // Orta - Mavi
                case 'low': return 'bg-success'; // DÃ¼ÅŸÃ¼k - YeÅŸil
                case '1': return 'bg-success'; // DÃ¼ÅŸÃ¼k - YeÅŸil
                case '2': return 'bg-info'; // Orta - Mavi
                case '3': return 'bg-warning'; // YÃ¼ksek - SarÄ±
                case '4': return 'bg-danger'; // ACÄ°L - KÄ±rmÄ±zÄ±
                default: return 'bg-secondary';
            }
        }

        function getPriorityText(priority) {
            // SayÄ±sal deÄŸerleri de destekle
            if (typeof priority === 'number') {
                switch(priority) {
                    case 1: return 'DÃ¼ÅŸÃ¼k';
                    case 2: return 'Orta';
                    case 3: return 'YÃ¼ksek';
                    case 4: return 'ACÄ°L';
                    default: return 'BelirtilmemiÅŸ';
                }
            }
            
            // String deÄŸerleri destekle
            switch(priority) {
                case 'urgent': return 'ACÄ°L';
                case 'high': return 'YÃ¼ksek';
                case 'medium': return 'Orta';
                case 'low': return 'DÃ¼ÅŸÃ¼k';
                case '1': return 'DÃ¼ÅŸÃ¼k';
                case '2': return 'Orta';
                case '3': return 'YÃ¼ksek';
                case '4': return 'ACÄ°L';
                default: return 'BelirtilmemiÅŸ';
            }
        }
        
        // Durum badge class'Ä±
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'approved': return 'bg-success';
                case 'active': return 'bg-primary';
                case 'in_progress': return 'bg-warning';
                case 'pending': return 'bg-warning';
                case 'completed': return 'bg-info';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        // Durum metni
        function getStatusText(status) {
            switch(status) {
                case 'approved': return 'OnaylandÄ±';
                case 'active': return 'Aktif';
                case 'in_progress': return 'Devam Ediyor';
                case 'pending': return 'Beklemede';
                case 'completed': return 'TamamlandÄ±';
                case 'cancelled': return 'Ä°ptal';
                default: return 'Bilinmiyor';
            }
        }

        // Plan status badge sÄ±nÄ±fÄ±
        function getPlanStatusBadgeClass(status) {
            switch(status) {
                case 'draft': return 'bg-secondary';
                case 'approved': return 'bg-success';
                case 'in_progress': return 'bg-warning';
                case 'completed': return 'bg-info';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Plan status metni
        function getPlanStatusText(status) {
            switch(status) {
                case 'draft': return 'Taslak';
                case 'approved': return 'OnaylandÄ±';
                case 'in_progress': return 'Devam Ediyor';
                case 'completed': return 'TamamlandÄ±';
                case 'cancelled': return 'Ä°ptal';
                default: return 'Bilinmiyor';
            }
        }

        // SipariÅŸ durum badge sÄ±nÄ±fÄ±
        function getOrderStatusBadgeClass(status) {
            switch(status) {
                case 'pending': return 'bg-warning';
                case 'approved': return 'bg-success';
                case 'in_progress': return 'bg-primary';
                case 'completed': return 'bg-info';
                case 'cancelled': return 'bg-danger';
                case 'draft': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        // SipariÅŸ durum metni
        function getOrderStatusText(status) {
            switch(status) {
                case 'pending': return 'Beklemede';
                case 'approved': return 'OnaylandÄ±';
                case 'in_progress': return 'Devam Ediyor';
                case 'completed': return 'TamamlandÄ±';
                case 'cancelled': return 'Ä°ptal';
                case 'draft': return 'Taslak';
                default: return 'Bilinmiyor';
            }
        }
    </script>
</body>
</html>
