<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thunder V1 - Üretim Yönetimi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css?v=20241220" rel="stylesheet">
    
    <!-- Faz 0: State Management ve Event Bus -->
    <script src="state-manager.js?v=20241220"></script>
    <script src="event-bus.js?v=20241220"></script>
    <script src="workflow-engine.js?v=20241220"></script>
    <script src="realtime-updates.js?v=20241220"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-industry me-2"></i>Thunder V1
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-boxes me-1"></i>Hammadde Yönetimi
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#yarimamul">
                            <i class="fas fa-cogs me-1"></i>Yarı Mamul Yönetimi
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#nihai">
                            <i class="fas fa-cube me-1"></i>Nihai Ürün Yönetimi
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#urun-agaci">
                            <i class="fas fa-sitemap me-1"></i>Ürün Ağacı
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="production.html">
                            <i class="fas fa-industry me-1"></i>Üretim Yönetimi
                        </a>
                    </li>
                </ul>
                
                <!-- Faz 0: Workflow Status Göstergesi -->
                <div class="navbar-nav">
                    <div class="nav-item">
                        <span class="navbar-text me-3">
                            <i class="fas fa-cog me-1"></i>Durum: 
                            <span id="workflow-status" class="badge bg-secondary">Hazır</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Faz 0: Notification Container -->
        <div id="notification-container" class="mb-3"></div>
        
        <!-- Üretim Yönetimi Başlık -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient-primary text-white">
                    <div class="card-body text-center">
                        <h2 class="mb-3">
                            <i class="fas fa-industry me-3"></i>Üretim Yönetimi
                        </h2>
                        <p class="lead mb-0">Hammaddelerden yarı mamul ve yarı mamullerden nihai ürün üretimi</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Üretim Yönetimi Tab Sistemi -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="productionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="order-management-tab" data-bs-toggle="tab" data-bs-target="#order-management-pane" type="button" role="tab" aria-selected="true">
                                    <i class="fas fa-shopping-cart me-2"></i>Sipariş Yönetimi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="production-planning-tab" data-bs-toggle="tab" data-bs-target="#production-planning-pane" type="button" role="tab">
                                    <i class="fas fa-calendar-alt me-2"></i>Üretim Planlama
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="production-stages-tab" data-bs-toggle="tab" data-bs-target="#production-stages-pane" type="button" role="tab">
                                    <i class="fas fa-users me-2"></i>Operatör Takibi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="quality-control-tab" data-bs-toggle="tab" data-bs-target="#quality-control-pane" type="button" role="tab">
                                    <i class="fas fa-check-circle me-2"></i>Kalite Kontrol
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="production-history-tab" data-bs-toggle="tab" data-bs-target="#production-history-pane" type="button" role="tab">
                                    <i class="fas fa-history me-2"></i>Üretim Geçmişi
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="productionTabContent">
                            <!-- Sipariş Yönetimi Tab -->
                            <div class="tab-pane fade show active" id="order-management-pane" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-shopping-cart me-2"></i>Sipariş Yönetimi
                                            </h5>
                                            <div>
                                                <button class="btn btn-warning btn-sm me-2" onclick="checkAndFixOrderStatuses()" title="Sipariş durumlarını kontrol et ve düzelt">
                                                    <i class="fas fa-sync-alt me-1"></i>Durumları Düzelt
                                                </button>
                                                <button class="btn btn-primary btn-sm me-2" onclick="showAddOrderModal()">
                                                    <i class="fas fa-plus me-1"></i>Yeni Sipariş
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm" onclick="loadOrders()">
                                                    <i class="fas fa-sync me-1"></i>Yenile
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sipariş Listesi -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-list me-2"></i>Aktif Siparişler
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="orders-container">
                                                    <div class="text-center py-4">
                                                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">Siparişler yükleniyor...</h5>
                                                <p class="text-muted">Sipariş verileri getiriliyor...</p>
                                                        </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <!-- Sipariş İstatistikleri -->
                                <div class="row mt-4">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-shopping-cart fa-2x text-primary mb-2"></i>
                                                <h5 class="card-title" id="total-orders">0</h5>
                                                <p class="card-text text-muted">Toplam Sipariş</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                                <h5 class="card-title" id="pending-orders">0</h5>
                                                <p class="card-text text-muted">Bekleyen</p>
                                </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-cogs fa-2x text-info mb-2"></i>
                                                <h5 class="card-title" id="processing-orders">0</h5>
                                                <p class="card-text text-muted">İşlenen</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                                <h5 class="card-title" id="completed-orders">0</h5>
                                                <p class="card-text text-muted">Tamamlanan</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Üretim Planlama Tab -->
                            <div class="tab-pane fade" id="production-planning-pane" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-calendar-alt me-2"></i>Üretim Planlama ve Zamanlama
                                            </h5>
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="loadProductionPlans()">
                                                    <i class="fas fa-sync me-1"></i>Yenile
                                                </button>
                                                <button class="btn btn-success btn-sm" onclick="showAddPlanModal()">
                                                    <i class="fas fa-plus me-1"></i>Yeni Plan
                                                </button>
                                                <button class="btn btn-info btn-sm" onclick="showSchedulingModal()">
                                                    <i class="fas fa-clock me-1"></i>Zamanlama
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Planlama İstatistikleri -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h5 id="total-plans">0</h5>
                                                <small>Toplam Plan</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h5 id="active-plans">0</h5>
                                                <small>Aktif Plan</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white">
                                            <div class="card-body text-center">
                                                <h5 id="total-orders">0</h5>
                                                <small>Toplam Sipariş</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h5 id="total-value">₺0</h5>
                                                <small>Toplam Değer</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Üretim Planları -->
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list me-2"></i>Üretim Planları
                                        </h6>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-success btn-sm" onclick="showCreatePlanFromOrdersModal()">
                                                <i class="fas fa-plus-circle me-1"></i>Siparişlerden Plan Oluştur
                                            </button>
                                            <button type="button" class="btn btn-primary btn-sm" onclick="showAddPlanModal()">
                                                <i class="fas fa-plus me-1"></i>Yeni Plan
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="btn-group" role="group" aria-label="Görünüm Seçenekleri">
                                            <button type="button" class="btn btn-outline-primary btn-sm active" id="gantt-view-btn" onclick="switchView('gantt')">
                                                <i class="fas fa-chart-gantt me-1"></i>Gantt Chart
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="timeline-view-btn" onclick="switchView('timeline')">
                                                <i class="fas fa-timeline me-1"></i>Timeline
                                            </button>
                                        </div>
                                        <div class="btn-group" role="group" aria-label="Zaman Filtreleri">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByDateRange('week')">
                                                <i class="fas fa-calendar-week me-1"></i>Bu Hafta
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByDateRange('month')">
                                                <i class="fas fa-calendar-alt me-1"></i>Bu Ay
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterByDateRange('all')">
                                                <i class="fas fa-calendar me-1"></i>Tümü
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="production-plans-container">
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Yükleniyor...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <script>
                                            // Üretim planlarını hemen yükle
                                            fetch('/api/production-plans')
                                                .then(response => response.json())
                                                .then(data => {
                                                    allPlans = data;
                                                    const container = document.getElementById('production-plans-container');
                                                    if (container) {
                                                        if (data.length > 0) {
                                                            renderPlansView(data);
                                                        } else {
                                                            container.innerHTML = `
                                                                <div class="text-center py-4">
                                                                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                                                                    <h5 class="text-muted">Henüz üretim planı bulunmuyor</h5>
                                                                    <p class="text-muted">Yeni üretim planı oluşturmak için "Yeni Plan" butonuna tıklayın.</p>
                                                                </div>
                                                            `;
                                                        }
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Üretim planları yükleme hatası:', error);
                                                    const container = document.getElementById('production-plans-container');
                                                    if (container) {
                                                        container.innerHTML = `
                                                            <div class="alert alert-danger">
                                                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Üretim Planları Yükleme Hatası!</h6>
                                                                <p>Üretim planları yüklenemedi: ${error.message}</p>
                                                            </div>
                                                        `;
                                                    }
                                                });
                                        </script>
                                    </div>
                                </div>

                                <!-- Kaynak Yönetimi -->
                                <div class="card mt-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cogs me-2"></i>Kaynak Yönetimi
                                        </h6>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddResourceModal()">
                                            <i class="fas fa-plus me-1"></i>Yeni Kaynak Ekle
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="resources-container">
                                            <div class="text-center py-4">
                                                <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">Kaynaklar yükleniyor...</h5>
                                                <p class="text-muted">Kaynak verileri getiriliyor...</p>
                                                </div>
                                            </div>
                                    </div>
                                </div>

                            </div>



                            <!-- Operatör Takibi Tab -->
                            <div class="tab-pane fade" id="production-stages-pane" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-users me-2"></i>Operatör Takibi
                                            </h5>
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="loadOperatorStatus()">
                                                    <i class="fas fa-sync me-1"></i>Yenile
                                                </button>
                                                <button class="btn btn-info btn-sm" onclick="loadRealtimeOperatorData()">
                                                    <i class="fas fa-eye me-1"></i>Canlı Takip
                                                </button>
                                                <button class="btn btn-success btn-sm" onclick="loadOperatorPerformance()">
                                                    <i class="fas fa-chart-line me-1"></i>Performans
                                                </button>
                                                <button class="btn btn-warning btn-sm" onclick="loadOperatorProductionHistory()">
                                                    <i class="fas fa-history me-1"></i>Üretim Geçmişi
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Operatör Durumu İstatistikleri -->
                                <div class="row mb-4" id="operator-status-stats">
                                    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                        <div class="card bg-primary text-white h-100">
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <h5 id="total-operators-count" class="mb-2">0</h5>
                                                <small>Toplam Operatör</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                        <div class="card bg-success text-white h-100">
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <h5 id="active-operators-count" class="mb-2">0</h5>
                                                <small>Aktif Operatör</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                        <div class="card bg-warning text-white h-100">
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <h5 id="active-productions-count" class="mb-2">0</h5>
                                                <small>Aktif Üretim</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                        <div class="card bg-info text-white h-100">
                                            <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <h5 id="completed-today-count" class="mb-2">0</h5>
                                                <small>Bugün Tamamlanan</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Canlı Operatör Takibi -->
                                <div class="row mb-4" id="realtime-operator-section">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-users me-2"></i>Canlı Operatör Takibi
                                                    <span class="badge bg-success ms-2" id="realtime-indicator">CANLI</span>
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="realtime-operators-container">
                                                    <div class="text-center py-4">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Yükleniyor...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Operatörler yükleniyor...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Operatör Listesi -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-users me-2"></i>Operatör Listesi
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="operators-list-container">
                                                    <div class="text-center py-4">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Yükleniyor...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Operatörler yükleniyor...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                
                                
                            </div>



                            <!-- Kalite Kontrol Tab -->
                            <div class="tab-pane fade" id="quality-control-pane" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-check-circle me-2"></i>Kalite Kontrol Yönetimi
                                            </h5>
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="loadQualityCheckpoints()">
                                                    <i class="fas fa-sync me-1"></i>Yenile
                                                </button>
                                                <button class="btn btn-success btn-sm" onclick="showAddCheckpointModal()">
                                                    <i class="fas fa-plus me-1"></i>Yeni Kontrol Noktası
                                                </button>
                                                <button class="btn btn-warning btn-sm" onclick="showAddStandardModal()">
                                                    <i class="fas fa-award me-1"></i>Yeni Standard
                                                </button>
                                                <button class="btn btn-info btn-sm" onclick="showQualityReports()">
                                                    <i class="fas fa-chart-bar me-1"></i>Raporlar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kalite İstatistikleri -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h5 id="quality-pass-rate">0%</h5>
                                                <small>Geçme Oranı</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-danger text-white">
                                            <div class="card-body text-center">
                                                <h5 id="quality-fail-rate">0%</h5>
                                                <small>Hata Oranı</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white">
                                            <div class="card-body text-center">
                                                <h5 id="quality-warning-rate">0%</h5>
                                                <small>Uyarı Oranı</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h5 id="quality-score">0</h5>
                                                <small>Kalite Skoru</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kalite Kontrol Noktaları -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-list-check me-2"></i>Kalite Kontrol Noktaları
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="quality-checkpoints-container">
                                                    <div class="text-center py-4">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Yükleniyor...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Kalite kontrol noktaları yükleniyor...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kalite Standartları -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-award me-2"></i>Kalite Standartları
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="quality-standards-container">
                                                    <div class="text-center py-4">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Yükleniyor...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Kalite standartları yükleniyor...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Üretim Geçmişi Tab -->
                            <div class="tab-pane fade" id="production-history-pane" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-history me-2"></i>Üretim Geçmişi
                                            </h5>
                                            <div>
                                                <button class="btn btn-primary btn-sm" onclick="loadProductionHistory()">
                                                    <i class="fas fa-sync me-1"></i>Yenile
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" onclick="getProductionHistory()">
                                                    <i class="fas fa-database me-1"></i>API Test
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm" onclick="showEfficiencyReport(1)">
                                                    <i class="fas fa-chart-line me-1"></i>Verimlilik
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="production-history-container">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Üretim geçmişi yükleniyor...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yarı Mamul Üretim Formu -->
        <div id="yarimamul-production-form" class="production-form" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-hammer me-2"></i>Yarı Mamul Üretimi
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideProductionForm()">
                                <i class="fas fa-times me-1"></i>Kapat
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="yarimamul-production-form-element">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="yarimamul-product" class="form-label">Üretilecek Yarı Mamul *</label>
                                            <select class="form-select" id="yarimamul-product" required>
                                                <option value="">Seçiniz...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="yarimamul-quantity" class="form-label">Üretim Miktarı *</label>
                                            <input type="number" class="form-control" id="yarimamul-quantity" min="1" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gerekli Hammaddeler -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-list me-2"></i>Gerekli Hammaddeler
                                    </h6>
                                    <div id="yarimamul-required-materials" class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Hammadde</th>
                                                    <th>Gerekli Miktar</th>
                                                    <th>Mevcut Stok</th>
                                                    <th>Eksik</th>
                                                    <th>Birim Fiyat</th>
                                                    <th>Toplam Maliyet</th>
                                                </tr>
                                            </thead>
                                            <tbody id="yarimamul-materials-list">
                                                <!-- Gerekli malzemeler buraya gelecek -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                        <div class="alert alert-info">
                                            <strong>Toplam Maliyet:</strong> <span id="yarimamul-total-cost">₺0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-info" onclick="calculateYarimamulMaterials()">
                                        <i class="fas fa-calculator me-1"></i>Malzeme Hesapla
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-play me-1"></i>Üretimi Başlat
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nihai Ürün Üretim Formu -->
        <div id="nihai-production-form" class="production-form" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-cube me-2"></i>Nihai Ürün Üretimi
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideProductionForm()">
                                <i class="fas fa-times me-1"></i>Kapat
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="nihai-production-form-element">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="nihai-product" class="form-label">Üretilecek Nihai Ürün *</label>
                                            <select class="form-select" id="nihai-product" required>
                                                <option value="">Seçiniz...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="nihai-quantity" class="form-label">Üretim Miktarı *</label>
                                            <input type="number" class="form-control" id="nihai-quantity" min="1" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gerekli Yarı Mamuller -->
                                <div class="mb-4">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-list me-2"></i>Gerekli Yarı Mamuller
                                    </h6>
                                    <div id="nihai-required-materials" class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Yarı Mamul</th>
                                                    <th>Gerekli Miktar</th>
                                                    <th>Mevcut Stok</th>
                                                    <th>Eksik</th>
                                                    <th>Birim Maliyet</th>
                                                    <th>Toplam Maliyet</th>
                                                </tr>
                                            </thead>
                                            <tbody id="nihai-materials-list">
                                                <!-- Gerekli malzemeler buraya gelecek -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                                        <div class="alert alert-success">
                                            <strong>Toplam Maliyet:</strong> <span id="nihai-total-cost">₺0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-info" onclick="calculateNihaiMaterials()">
                                        <i class="fas fa-calculator me-1"></i>Malzeme Hesapla
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-play me-1"></i>Üretimi Başlat
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- Üretim Seçim Modal -->
    <div class="modal fade" id="productionSelectionModal" tabindex="-1" aria-labelledby="productionSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productionSelectionModalLabel">
                        <i class="fas fa-industry me-2"></i>Üretim Başlat
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="production-product" class="form-label">Üretilecek Ürün *</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="production-product-autocomplete" 
                                           placeholder="Ürün kodunu yazın... (örn: TRX)" 
                                           autocomplete="off" required>
                                    <div id="production-autocomplete-results" class="autocomplete-results" style="display: none;">
                                        <!-- Autocomplete sonuçları buraya gelecek -->
                                    </div>
                                </div>
                                <input type="hidden" id="production-product" name="production-product" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    En az 3 karakter yazarak ürün arayabilirsiniz
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="production-quantity" class="form-label">Üretim Miktarı *</label>
                                <input type="number" class="form-control" id="production-quantity" min="1" step="1" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Malzeme Kontrolü -->
                    <div id="material-check-section" style="display: none;">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-list me-2"></i>Malzeme Kontrolü
                        </h6>
                        <div id="material-check-result" class="alert alert-info">
                            Malzeme kontrolü yapılıyor...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="start-production-btn" onclick="startProductionOld()" disabled>
                        <i class="fas fa-play me-1"></i>Üretimi Başlat
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Barkod Okutma Modal -->
    <div class="modal fade" id="barcodeModal" tabindex="-1" aria-labelledby="barcodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="barcodeModalLabel">
                        <i class="fas fa-barcode me-2"></i>Barkod Okutma - Üretim Takibi
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Üretim Bilgileri -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Hedef Ürün</h6>
                                    <h4 id="target-product-name">-</h4>
                                    <small id="target-product-code">-</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Hedef Miktar</h6>
                                    <h4 id="target-quantity">0</h4>
                                    <small>adet</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Kalan Miktar</h6>
                                    <h4 id="remaining-quantity">0</h4>
                                    <small>adet</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Üretim İlerlemesi -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-chart-line me-2"></i>Üretim İlerlemesi
                                    </h6>
                                    <div class="progress mb-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" id="production-progress" style="width: 0%">
                                            <span id="progress-text">0%</span>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <h5 class="text-primary" id="produced-count">0</h5>
                                            <small class="text-muted">Üretilen</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-success" id="success-count">0</h5>
                                            <small class="text-muted">Başarılı</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-danger" id="error-count">0</h5>
                                            <small class="text-muted">Hatalı</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barkod Okutma Alanı -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-qrcode me-2"></i>Barkod Okutma
                                    </h6>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control form-control-lg" id="barcode-input-old" 
                                               placeholder="Barkodu buraya okutun veya yazın... (8+ karakter otomatik okutur)" autofocus>
                                        <button class="btn btn-success" type="button" onclick="window.scanBarcode()">
                                            <i class="fas fa-camera me-1"></i>Manuel Okut
                                        </button>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Otomatik Okutma:</strong> 8+ karakter yazdığınızda otomatik olarak okutulur. 
                                        Barkod okuyucu kullanıyorsanız sadece okutun, yazmaya gerek yok.
                                    </div>
                                    <div id="barcode-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-history me-2"></i>Son Okutulan
                                    </h6>
                                    <div id="last-scanned" class="text-muted">
                                        Henüz barkod okutulmadı
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" id="complete-production-btn" onclick="completeProduction()" disabled>
                        <i class="fas fa-check me-1"></i>Üretimi Tamamla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Üretim Detay Modal -->
    <div class="modal fade" id="productionDetailModal" tabindex="-1" aria-labelledby="productionDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productionDetailModalTitle">
                        <i class="fas fa-industry me-2"></i>Üretim Detayları
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="productionDetailContent">
                        <!-- Üretim detayları buraya gelecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-warning" onclick="editProduction()" id="editProductionBtn">
                        <i class="fas fa-edit me-1"></i>Düzenle
                    </button>
                    <button type="button" class="btn btn-danger" onclick="cancelProduction()" id="cancelProductionBtn">
                        <i class="fas fa-times me-1"></i>İptal Et
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Üretim Düzenleme Modal -->
    <div class="modal fade" id="editProductionModal" tabindex="-1" aria-labelledby="editProductionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="editProductionModalTitle">
                        <i class="fas fa-edit me-2"></i>Üretim Düzenle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ürün Adı</label>
                                    <input type="text" class="form-control" id="edit-product-name" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ürün Kodu</label>
                                    <input type="text" class="form-control" id="edit-product-code" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Hedef Miktar</label>
                                    <input type="number" class="form-control" id="edit-target-quantity" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Üretilen Miktar</label>
                                    <input type="number" class="form-control" id="edit-produced-quantity" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Durum</label>
                                    <select class="form-select" id="edit-production-status" required>
                                        <option value="active">Aktif</option>
                                        <option value="paused">Duraklatıldı</option>
                                        <option value="completed">Tamamlandı</option>
                                        <option value="cancelled">İptal Edildi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Öncelik</label>
                                    <select class="form-select" id="edit-production-priority">
                                        <option value="low">Düşük</option>
                                        <option value="normal">Normal</option>
                                        <option value="high">Yüksek</option>
                                        <option value="urgent">Acil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notlar</label>
                            <textarea class="form-control" id="edit-production-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProductionChanges()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Aşama Şablonu Ekleme Modal -->
    <div class="modal fade" id="addStageTemplateModal" tabindex="-1" aria-labelledby="addStageTemplateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addStageTemplateModalLabel">
                        <i class="fas fa-plus me-2"></i>Yeni Aşama Şablonu
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addStageTemplateForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="template-product-type" class="form-label">Ürün Tipi *</label>
                                    <select class="form-select" id="template-product-type" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="hammadde">Hammadde</option>
                                        <option value="yarimamul">Yarı Mamul</option>
                                        <option value="nihai">Nihai Ürün</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="template-stage-name" class="form-label">Aşama Adı *</label>
                                    <input type="text" class="form-control" id="template-stage-name" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="template-stage-order" class="form-label">Aşama Sırası *</label>
                                    <input type="number" class="form-control" id="template-stage-order" min="1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="template-duration" class="form-label">Tahmini Süre (dakika)</label>
                                    <input type="number" class="form-control" id="template-duration" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="template-skills" class="form-label">Gerekli Yetenekler</label>
                                    <input type="text" class="form-control" id="template-skills" placeholder="operatör, teknisyen, kalite_kontrol">
                                    <small class="form-text text-muted">Virgülle ayırın</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="template-quality-check">
                                        <label class="form-check-label" for="template-quality-check">
                                            Kalite kontrolü gerekli
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="template-mandatory" checked>
                                        <label class="form-check-label" for="template-mandatory">
                                            Zorunlu aşama
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" onclick="addStageTemplate()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Üretim Aşamaları Yönetim Modal -->
    <div class="modal fade" id="productionStagesModal" tabindex="-1" aria-labelledby="productionStagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="productionStagesModalLabel">
                        <i class="fas fa-list-ol me-2"></i>Üretim Aşamaları
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Üretim ID: <span id="stages-production-id">-</span></h6>
                                <div>
                                    <button class="btn btn-primary btn-sm" onclick="loadProductionStages()">
                                        <i class="fas fa-sync me-1"></i>Yenile
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="startNextStage()">
                                        <i class="fas fa-play me-1"></i>Sonraki Aşama
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aşamalar Timeline -->
                    <div id="stages-timeline" class="stages-timeline">
                        <!-- Aşamalar buraya gelecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kalite Kontrol Noktası Ekleme Modal -->
    <div class="modal fade" id="addCheckpointModal" tabindex="-1" aria-labelledby="addCheckpointModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="addCheckpointModalLabel">
                        <i class="fas fa-plus me-2"></i>Yeni Kalite Kontrol Noktası
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCheckpointForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="checkpoint-name" class="form-label">Kontrol Noktası Adı *</label>
                                    <input type="text" class="form-control" id="checkpoint-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="checkpoint-type" class="form-label">Kontrol Tipi *</label>
                                    <select class="form-select" id="checkpoint-type" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="visual">Görsel Kontrol</option>
                                        <option value="measurement">Ölçüm</option>
                                        <option value="test">Test</option>
                                        <option value="inspection">Muayene</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="checkpoint-product-type" class="form-label">Ürün Tipi *</label>
                                    <select class="form-select" id="checkpoint-product-type" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="hammadde">Hammadde</option>
                                        <option value="yarimamul">Yarı Mamul</option>
                                        <option value="nihai">Nihai Ürün</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="checkpoint-frequency" class="form-label">Kontrol Sıklığı</label>
                                    <select class="form-select" id="checkpoint-frequency">
                                        <option value="every">Her Üretim</option>
                                        <option value="random">Rastgele</option>
                                        <option value="first">İlk Üretim</option>
                                        <option value="last">Son Üretim</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="checkpoint-description" class="form-label">Açıklama</label>
                            <textarea class="form-control" id="checkpoint-description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkpoint-mandatory" checked>
                                    <label class="form-check-label" for="checkpoint-mandatory">
                                        Zorunlu kontrol
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-warning" onclick="addQualityCheckpoint()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kalite Kontrol Gerçekleştirme Modal -->
    <div class="modal fade" id="qualityCheckModal" tabindex="-1" aria-labelledby="qualityCheckModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="qualityCheckModalLabel">
                        <i class="fas fa-check-circle me-2"></i>Kalite Kontrol Gerçekleştir
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="qualityCheckForm">
                        <input type="hidden" id="check-production-id">
                        <input type="hidden" id="check-stage-id">
                        <input type="hidden" id="check-checkpoint-id">
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 id="checkpoint-name-display">Kontrol Noktası</h6>
                                <p class="text-muted" id="checkpoint-description-display">Açıklama</p>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="check-operator" class="form-label">Operatör *</label>
                                    <select class="form-select" id="check-operator" required>
                                        <option value="">Operatör seçiniz...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="check-result" class="form-label">Sonuç *</label>
                                    <select class="form-select" id="check-result" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="pass">Geçti</option>
                                        <option value="fail">Başarısız</option>
                                        <option value="warning">Uyarı</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row" id="measurement-fields" style="display: none;">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="check-measured-value" class="form-label">Ölçülen Değer</label>
                                    <input type="number" class="form-control" id="check-measured-value" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="check-expected-value" class="form-label">Beklenen Değer</label>
                                    <input type="number" class="form-control" id="check-expected-value" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="check-tolerance" class="form-label">Tolerans (±)</label>
                                    <input type="number" class="form-control" id="check-tolerance" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="check-notes" class="form-label">Notlar</label>
                            <textarea class="form-control" id="check-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="submitQualityCheck()">
                        <i class="fas fa-check me-1"></i>Kontrolü Tamamla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kalite Standardı Ekleme Modal -->
    <div class="modal fade" id="addStandardModal" tabindex="-1" aria-labelledby="addStandardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addStandardModalLabel">
                        <i class="fas fa-award me-2"></i>Yeni Kalite Standardı
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addStandardForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="standard-name" class="form-label">Standard Adı *</label>
                                    <input type="text" class="form-control" id="standard-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="standard-type" class="form-label">Standard Tipi *</label>
                                    <select class="form-select" id="standard-type" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="internal">İç Standard</option>
                                        <option value="external">Dış Standard</option>
                                        <option value="iso">ISO Standardı</option>
                                        <option value="customer">Müşteri Standardı</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="standard-product-type" class="form-label">Ürün Tipi *</label>
                                    <select class="form-select" id="standard-product-type" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="hammadde">Hammadde</option>
                                        <option value="yarimamul">Yarı Mamul</option>
                                        <option value="nihai">Nihai Ürün</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="standard-version" class="form-label">Versiyon</label>
                                    <input type="text" class="form-control" id="standard-version" placeholder="v1.0">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="standard-description" class="form-label">Açıklama</label>
                            <textarea class="form-control" id="standard-description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="standard-active" checked>
                                    <label class="form-check-label" for="standard-active">
                                        Aktif standard
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" onclick="addQualityStandard()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kalite Raporları Modal -->
    <div class="modal fade" id="qualityReportsModal" tabindex="-1" aria-labelledby="qualityReportsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="qualityReportsModalLabel">
                        <i class="fas fa-chart-bar me-2"></i>Kalite Raporları
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="qualityReportsModalBody">
                    <!-- Rapor içeriği buraya gelecek -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary" onclick="showQualityReports()">
                        <i class="fas fa-sync me-1"></i>Yenile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pop-up Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="alertModalHeader">
                    <h5 class="modal-title" id="alertModalTitle">Bildirim</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    <!-- Mesaj buraya gelecek -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sipariş Ekleme/Düzenleme Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderModalTitle">Yeni Sipariş Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customer-name" class="form-label">Müşteri Adı *</label>
                                    <input type="text" class="form-control" id="customer-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="order-date" class="form-label">Sipariş Tarihi *</label>
                                    <input type="date" class="form-control" id="order-date" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-name" class="form-label">Nihai Ürün *</label>
                                    <select class="form-select" id="product-name" required>
                                        <option value="">Nihai ürün seçiniz</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-code" class="form-label">Ürün Kodu</label>
                                    <input type="text" class="form-control" id="product-code" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sipariş Detayları -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Sipariş Detayları</h6>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addProductToOrder()">
                                    <i class="fas fa-plus me-1"></i>Ürün Ekle
                                </button>
                            </div>
                            
                            <div id="order-products-container">
                                <!-- Ürün satırları buraya eklenecek -->
                            </div>
                            
                               <div class="row mt-3">
                                   <div class="col-md-6">
                                       <div class="mb-3">
                                           <label for="total-quantity" class="form-label">Toplam Miktar</label>
                                           <input type="number" class="form-control" id="total-quantity" readonly>
                                       </div>
                                   </div>
                               </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="delivery-date" class="form-label">Teslim Tarihi *</label>
                                    <input type="date" class="form-control" id="delivery-date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Öncelik *</label>
                                    <select class="form-select" id="priority" required>
                                        <option value="">Seçiniz</option>
                                        <option value="low">Düşük</option>
                                        <option value="medium">Orta</option>
                                        <option value="high">Yüksek</option>
                                        <option value="urgent">Acil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label">Durum *</label>
                                    <div class="btn-group w-100" role="group" aria-label="Durum seçimi">
                                        <input type="radio" class="btn-check" name="status" id="status-draft" value="pending" checked>
                                        <label class="btn btn-outline-secondary" for="status-draft">
                                            <i class="fas fa-edit me-1"></i>Taslak
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="status" id="status-active" value="approved">
                                        <label class="btn btn-outline-success" for="status-active">
                                            <i class="fas fa-play me-1"></i>Aktif
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        <strong>Taslak:</strong> Sipariş oluşturulur, plan oluşturulmaz<br>
                                        <strong>Aktif:</strong> Sipariş onaylanır, otomatik plan oluşturulur
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assigned-operator" class="form-label">Atanan Operatör</label>
                                    <select class="form-select" id="assigned-operator">
                                        <option value="">Operatör seçiniz</option>
                                        <option value="Thunder Serisi Operatör">Thunder Serisi Operatör</option>
                                        <option value="ThunderPRO Serisi Operatör">ThunderPRO Serisi Operatör</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Notlar</label>
                                    <textarea class="form-control" id="notes" rows="3" placeholder="Sipariş ile ilgili notlar..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrder()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kaynak Ekleme/Düzenleme Modal -->
    <div class="modal fade" id="resourceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resourceModalTitle">Yeni Kaynak Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="resourceForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resource-name" class="form-label">Kaynak Adı *</label>
                                    <input type="text" class="form-control" id="resource-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resource-type" class="form-label">Kaynak Türü *</label>
                                    <select class="form-select" id="resource-type" required>
                                        <option value="">Seçiniz</option>
                                        <option value="machine">Makine</option>
                                        <option value="operator">Operatör</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resource-capacity" class="form-label">Kapasite (Saat) *</label>
                                    <input type="number" class="form-control" id="resource-capacity" min="1" max="24" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resource-cost" class="form-label">Saatlik Maliyet (₺) *</label>
                                    <input type="number" class="form-control" id="resource-cost" step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resource-location" class="form-label">Konum *</label>
                                    <input type="text" class="form-control" id="resource-location" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="resource-status" class="form-label">Durum</label>
                                    <select class="form-select" id="resource-status">
                                        <option value="true">Aktif</option>
                                        <option value="false">Pasif</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="resource-skills" class="form-label">Gerekli Yetenekler</label>
                            <input type="text" class="form-control" id="resource-skills" placeholder="örn: montaj, kalite_kontrol, paketleme">
                            <div class="form-text">Virgülle ayırarak birden fazla yetenek ekleyebilirsiniz</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="resource-notes" class="form-label">Notlar</label>
                            <textarea class="form-control" id="resource-notes" rows="3"></textarea>
                        </div>
                    </form>
                    
                    <!-- Kapasite Hesaplama Kartı -->
                    <div class="card mt-4" id="resource-capacity-card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Kapasite Hesaplama
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Çalışma Saatleri:</small>
                                        <div id="resource-work-hours" class="fw-bold">09:00 - 18:00</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Net Çalışma:</small>
                                        <div id="resource-net-work" class="fw-bold">8 saat</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Kaynak Kapasitesi:</small>
                                        <div id="resource-capacity-display" class="fw-bold">-</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Günlük Üretim:</small>
                                        <div id="resource-daily-production" class="fw-bold text-success">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>Kapasite hesaplaması zamanlama ayarları ve kaynak bilgilerine göre yapılır.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveResource()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flowchart Modal -->
    <div class="modal fade" id="flowchartModal" tabindex="-1" aria-labelledby="flowchartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="flowchartModalLabel">
                        <i class="fas fa-project-diagram me-2"></i>Aşama Şablonları Flowchart
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="flowchartProductType" class="form-label">Ürün Tipi Seçin:</label>
                            <select class="form-select" id="flowchartProductType" onchange="updateFlowchart()">
                                <option value="">Tüm Ürün Tipleri</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="flowchartViewType" class="form-label">Görünüm Tipi:</label>
                            <select class="form-select" id="flowchartViewType" onchange="updateFlowchart()">
                                <option value="simple">Basit HTML (Hızlı ve Güvenilir)</option>
                            </select>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div id="flowchart-container" style="min-height: 500px; overflow: auto;">
                                <div class="text-center p-5">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="mt-2 text-muted">Flowchart yükleniyor...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary" onclick="exportFlowchart()">
                        <i class="fas fa-download me-1"></i>Dışa Aktar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flowchart.js kaldırıldı - sadece basit HTML kullanılıyor -->
    <script src="production.js?v=20241220-125"></script>
    
    <script>
        // Direkt yükleme - sayfa yüklendiğinde (Sipariş Yönetimi tab'ı için)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 HTML içinde direkt yükleme başlatılıyor...');
            
            // Sipariş Yönetimi tab'ı için veri yükle
            if (typeof loadOrders === 'function') {
                console.log('✅ loadOrders fonksiyonu bulundu, çağrılıyor...');
                loadOrders();
            } else {
                console.error('❌ loadOrders fonksiyonu bulunamadı!');
            }
        });
    </script>
    
    <script>
        // Sipariş yönetimi fonksiyonları
        let orderProducts = []; // Sipariş ürünleri
        let nihaiUrunler = []; // Nihai ürünler listesi
        
        window.showAddOrderModal = function() {
            currentOrderId = null;
            orderProducts = []; // Sipariş ürünlerini temizle
            document.getElementById('orderModalTitle').textContent = 'Yeni Sipariş Ekle';
            document.getElementById('orderForm').reset();
            
            // Bugünün tarihini sipariş tarihi olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('order-date').value = today;
            
            // Teslim tarihini 5 gün sonra olarak ayarla
            const deliveryDate = new Date();
            deliveryDate.setDate(deliveryDate.getDate() + 5);
            document.getElementById('delivery-date').value = deliveryDate.toISOString().split('T')[0];
            
            // Teslim tarihi değişikliklerinde çalışma günü kontrolü
            document.getElementById('delivery-date').addEventListener('change', function() {
                checkAndAdjustDeliveryDate();
            });
            
            document.getElementById('status-draft').checked = true;
            
            // Nihai ürünleri yükle
            loadNihaiUrunler();
            
            
            // Ürün container'ını temizle
            document.getElementById('order-products-container').innerHTML = '';
            
            // Toplamları sıfırla
            document.getElementById('total-quantity').value = '0';
            
            const modal = new bootstrap.Modal(document.getElementById('orderModal'));
            modal.show();
        };
        
        
        function loadNihaiUrunler() {
            fetch('/api/nihai_urunler')
                .then(response => response.json())
                .then(data => {
                    nihaiUrunler = data;
                    const productSelect = document.getElementById('product-name');
                    productSelect.innerHTML = '<option value="">Nihai ürün seçiniz</option>';
                    
                    data.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.ad} (${product.kod})`;
                        option.dataset.code = product.kod;
                        option.dataset.price = product.satis_fiyati || 0;
                        productSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Nihai ürünler yüklenemedi:', error);
                });
        }
        
        function editOrder(orderId) {
            currentOrderId = orderId;
            document.getElementById('orderModalTitle').textContent = 'Sipariş Düzenle';
            
            // Sipariş verilerini yükle
            fetch(`/api/orders/${orderId}`)
                .then(response => response.json())
                .then(order => {
                    // Form alanlarını doldur
                    document.getElementById('customer-name').value = order.customer_name || '';
                    document.getElementById('order-date').value = order.order_date || '';
                    document.getElementById('delivery-date').value = order.delivery_date || '';
                    
                    // Teslim tarihi değişikliklerinde çalışma günü kontrolü
                    document.getElementById('delivery-date').addEventListener('change', function() {
                        checkAndAdjustDeliveryDate();
                    });
                    document.getElementById('priority').value = order.priority || '';
                    // Durum radio butonlarını ayarla
                    if (order.status === 'pending') {
                        document.getElementById('status-draft').checked = true;
                    } else if (order.status === 'approved') {
                        document.getElementById('status-active').checked = true;
                    } else {
                        document.getElementById('status-draft').checked = true;
                    }
                    // Notları ayır (kullanıcı notları vs ürün detayları)
                    let userNotes = order.notes || '';
                    let productDetails = [];
                    
                    // Ürün detaylarını notlardan çıkar
                    if (userNotes.includes('[ÜRÜN DETAYLARI:')) {
                        const parts = userNotes.split('[ÜRÜN DETAYLARI:');
                        userNotes = parts[0].trim();
                        
                        if (parts[1]) {
                            const jsonPart = parts[1].replace(']', '').trim();
                            try {
                                productDetails = JSON.parse(jsonPart);
                            } catch (error) {
                                console.log('Ürün detayları parse edilemedi:', error);
                                productDetails = [];
                            }
                        }
                    }
                    
                    document.getElementById('notes').value = userNotes;
                    
                    // Nihai ürünleri yükle
                    loadNihaiUrunler();
                    
                    // Ürün detaylarını yükle
                    if (Array.isArray(productDetails) && productDetails.length > 0) {
                        orderProducts = productDetails;
                        renderOrderProducts();
                    } else {
                        // Eski siparişlerde ürün detayları yok
                        document.getElementById('order-products-container').innerHTML = `
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Ürün Detayları Bulunamadı</h6>
                                <p class="mb-2">Bu sipariş eski sistemde oluşturulmuş ve ürün detayları saklanmamış.</p>
                                <p class="mb-0">Yeni ürünler ekleyebilir veya mevcut bilgileri düzenleyebilirsiniz.</p>
                            </div>
                        `;
                        orderProducts = [];
                    }
                    
                    // Toplamları hesapla
                    calculateOrderTotals();
                    
                    const modal = new bootstrap.Modal(document.getElementById('orderModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Sipariş yükleme hatası:', error);
                    alert('Sipariş bilgileri yüklenemedi!');
                });
        }
        
        function saveOrder() {
            // Debug: Form değerlerini kontrol et
            console.log('Form validation kontrolü:');
            console.log('customer-name:', document.getElementById('customer-name').value);
            console.log('order-date:', document.getElementById('order-date').value);
            console.log('delivery-date:', document.getElementById('delivery-date').value);
            console.log('priority:', document.getElementById('priority').value);
            console.log('orderProducts length:', orderProducts.length);
            
            // Validation
            const customerName = document.getElementById('customer-name').value;
            const orderDate = document.getElementById('order-date').value;
            const deliveryDate = document.getElementById('delivery-date').value;
            const priority = document.getElementById('priority').value;
            
            if (!customerName || !orderDate || !deliveryDate || !priority) {
                alert('Lütfen tüm zorunlu alanları doldurun!');
                console.log('Validation failed - missing required fields');
                return;
            }
            
            if (orderProducts.length === 0) {
                alert('Lütfen en az bir ürün ekleyin!');
                console.log('Validation failed - no products added');
                return;
            }
            
            // Ürün detaylarını notlara JSON olarak ekle
            const userNotes = document.getElementById('notes').value;
            const productDetails = JSON.stringify(orderProducts);
            const combinedNotes = userNotes ? `${userNotes}\n\n[ÜRÜN DETAYLARI: ${productDetails}]` : `[ÜRÜN DETAYLARI: ${productDetails}]`;
            
            // Priority'yi integer'a çevir
            const priorityValue = document.getElementById('priority').value;
            let priorityInt = 1; // default
            if (priorityValue === 'low') priorityInt = 1;
            else if (priorityValue === 'medium') priorityInt = 2;
            else if (priorityValue === 'high') priorityInt = 3;
            else if (priorityValue === 'urgent') priorityInt = 4;
            
            // Toplam miktarı hesapla
            const totalQuantity = orderProducts.reduce((sum, product) => sum + product.quantity, 0);
            
            const formData = {
                customer_name: document.getElementById('customer-name').value,
                order_date: document.getElementById('order-date').value,
                delivery_date: document.getElementById('delivery-date').value,
                priority: priorityInt,
                status: document.querySelector('input[name="status"]:checked').value,
                notes: combinedNotes,
                quantity: totalQuantity, // Toplam miktarı ekle
                product_details: productDetails, // Ürün detaylarını ayrı alan olarak ekle
                total_amount: 0 // Toplam tutar kaldırıldı, 0 olarak gönder
                // reference_number ve products sütunları kaldırıldı - tablo yapısında yok
            };
            
            const url = currentOrderId ? `/api/orders/${currentOrderId}` : '/api/orders';
            const method = currentOrderId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    alert(currentOrderId ? 'Sipariş başarıyla güncellendi!' : 'Sipariş başarıyla eklendi!');
                    bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
                    
                    // Sipariş listesini yenile
                    loadOrders();
                }
            })
            .catch(error => {
                console.error('Sipariş kaydetme hatası:', error);
                alert('Sipariş kaydedilemedi!');
            });
        }
        
        function deleteOrder(orderId) {
            if (confirm('Bu siparişi silmek istediğinizden emin misiniz?')) {
                fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Hata: ' + data.error);
                    } else {
                        alert('Sipariş başarıyla silindi!');
                        loadOrders();
                    }
                })
                .catch(error => {
                    console.error('Sipariş silme hatası:', error);
                    alert('Sipariş silinemedi!');
                });
            }
        }
        
        
        function updateOrderStatistics(orders) {
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.status === 'pending').length;
            const processingOrders = orders.filter(o => o.status === 'processing').length;
            const completedOrders = orders.filter(o => o.status === 'completed').length;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pendingOrders;
            document.getElementById('processing-orders').textContent = processingOrders;
            document.getElementById('completed-orders').textContent = completedOrders;
        }
        
        function getPriorityColor(priority) {
            switch(priority) {
                case 'urgent': return 'danger';
                case 'high': return 'warning';
                case 'medium': return 'info';
                case 'low': return 'secondary';
                default: return 'secondary';
            }
        }
        
        function getPriorityText(priority) {
            switch(priority) {
                case 'urgent': return 'Acil';
                case 'high': return 'Yüksek';
                case 'medium': return 'Orta';
                case 'low': return 'Düşük';
                default: return priority;
            }
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'pending': return 'warning';
                case 'processing': return 'info';
                case 'completed': return 'success';
                case 'cancelled': return 'danger';
                default: return 'secondary';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'Bekleyen';
                case 'processing': return 'İşlenen';
                case 'completed': return 'Tamamlanan';
                case 'cancelled': return 'İptal';
                default: return status;
            }
        }
        
        // Ürün seçimi değiştiğinde
        document.getElementById('product-name').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('product-code').value = selectedOption.dataset.code || '';
            } else {
                document.getElementById('product-code').value = '';
            }
        });
        
        function addProductToOrder() {
            const productSelect = document.getElementById('product-name');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Lütfen bir nihai ürün seçin!');
                return;
            }
            
           const productId = selectedOption.value;
           const productName = selectedOption.textContent;
           const productCode = selectedOption.dataset.code;
           
           // Miktar girişi için prompt
           const quantity = prompt(`${productName} için miktar girin:`, '1');
           if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
               return;
           }
           
           const qty = parseFloat(quantity);
           
           // Ürünü listeye ekle
           const product = {
               id: productId,
               name: productName,
               code: productCode,
               quantity: qty
           };
            
            orderProducts.push(product);
            renderOrderProducts();
            
            // Seçimi sıfırla
            productSelect.selectedIndex = 0;
            document.getElementById('product-code').value = '';
        }
        
        function renderOrderProducts() {
            const container = document.getElementById('order-products-container');
            
            if (orderProducts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Henüz ürün eklenmedi</p>';
                return;
            }
            
           container.innerHTML = orderProducts.map((product, index) => `
               <div class="row mb-2 border-bottom pb-2">
                   <div class="col-md-4">
                       <small class="text-muted">Ürün</small>
                       <div>${product.name}</div>
                   </div>
                   <div class="col-md-3">
                       <small class="text-muted">Kod</small>
                       <div>${product.code}</div>
                   </div>
                   <div class="col-md-3">
                       <small class="text-muted">Miktar</small>
                       <div>${product.quantity}</div>
                   </div>
                   <div class="col-md-2">
                       <button class="btn btn-sm btn-outline-danger" onclick="removeProductFromOrder(${index})">
                           <i class="fas fa-trash"></i>
                       </button>
                   </div>
               </div>
           `).join('');
            
            // Toplamları hesapla
            calculateOrderTotals();
        }
        
        function removeProductFromOrder(index) {
            orderProducts.splice(index, 1);
            renderOrderProducts();
        }
        
       function calculateOrderTotals() {
           const totalQuantity = orderProducts.reduce((sum, product) => sum + product.quantity, 0);
           
           document.getElementById('total-quantity').value = totalQuantity;
       }

        // Kaynak yönetimi fonksiyonları
        let currentResourceId = null;
        
        // Operatör kullanım bilgilerini hesapla
        async function calculateOperatorUsage() {
            try {
                // Üretim planlarından operatör kullanımını hesapla
                const response = await fetch('/api/production-plans');
                const plans = await response.json();
                
                const operatorUsage = {
                    4: 0, // Thunder Serisi Operatör
                    5: 0  // ThunderPRO Serisi Operatör
                };
                
                // Her operatör için kullanım süresini hesapla
                if (plans && Array.isArray(plans)) {
                    plans.forEach(plan => {
                        if (plan.assigned_operator) {
                            // Operatör ID'sini bul (basit eşleştirme)
                            const operatorId = plan.assigned_operator === 'Thunder Serisi Operatör' ? 4 : 
                                             plan.assigned_operator === 'ThunderPRO Serisi Operatör' ? 5 : null;
                            
                            if (operatorId) {
                                // Çalışma günlerini hesapla
                                const workingDays = plan.working_days || 0;
                                const dailyHours = 8; // Günlük çalışma saati
                                const totalHours = workingDays * dailyHours;
                                
                                operatorUsage[operatorId] = (operatorUsage[operatorId] || 0) + totalHours;
                            }
                        }
                    });
                }
                return operatorUsage;
            } catch (error) {
                console.error('Operatör kullanım hesaplama hatası:', error);
                return {
                    4: 0, // Thunder Serisi Operatör
                    5: 0  // ThunderPRO Serisi Operatör
                };
            }
        }
        
        function showAddResourceModal() {
            currentResourceId = null;
            document.getElementById('resourceModalTitle').textContent = 'Yeni Kaynak Ekle';
            document.getElementById('resourceForm').reset();
            document.getElementById('resource-status').value = 'true';
            
            // Kapasite hesaplamasını güncelle
            updateResourceCapacityCalculation();
            
            const modal = new bootstrap.Modal(document.getElementById('resourceModal'));
            modal.show();
        }
        
        function editResource(resourceId) {
            currentResourceId = resourceId;
            document.getElementById('resourceModalTitle').textContent = 'Kaynak Düzenle';
            
            // Kaynak verilerini yükle
            fetch(`/api/resources/${resourceId}`)
                .then(response => response.json())
                .then(resource => {
                    document.getElementById('resource-name').value = resource.resource_name;
                    document.getElementById('resource-type').value = resource.resource_type;
                    document.getElementById('resource-capacity').value = resource.capacity;
                    document.getElementById('resource-cost').value = resource.cost_per_hour;
                    document.getElementById('resource-location').value = resource.location;
                    document.getElementById('resource-status').value = resource.is_active.toString();
                    document.getElementById('resource-skills').value = resource.skills_required ? resource.skills_required.join(', ') : '';
                    document.getElementById('resource-notes').value = resource.notes || '';
                    
                    // Kapasite hesaplamasını güncelle
                    updateResourceCapacityCalculation();
                    
                    const modal = new bootstrap.Modal(document.getElementById('resourceModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Kaynak yükleme hatası:', error);
                    alert('Kaynak bilgileri yüklenemedi!');
                });
        }
        
        function saveResource() {
            const formData = {
                resource_name: document.getElementById('resource-name').value,
                resource_type: document.getElementById('resource-type').value,
                capacity: parseInt(document.getElementById('resource-capacity').value),
                cost_per_hour: parseFloat(document.getElementById('resource-cost').value),
                location: document.getElementById('resource-location').value,
                is_active: document.getElementById('resource-status').value === 'true',
                skills_required: document.getElementById('resource-skills').value.split(',').map(s => s.trim()).filter(s => s),
                notes: document.getElementById('resource-notes').value
            };
            
            // Validation
            if (!formData.resource_name || !formData.resource_type || !formData.capacity || !formData.cost_per_hour || !formData.location) {
                alert('Lütfen tüm zorunlu alanları doldurun!');
                return;
            }
            
            const url = currentResourceId ? `/api/resources/${currentResourceId}` : '/api/resources';
            const method = currentResourceId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    alert(currentResourceId ? 'Kaynak başarıyla güncellendi!' : 'Kaynak başarıyla eklendi!');
                    bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
                    
                    // Sayfayı yenile
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Kaynak kaydetme hatası:', error);
                alert('Kaynak kaydedilemedi!');
            });
        }
        
        function deleteResource(resourceId) {
            if (confirm('Bu kaynağı silmek istediğinizden emin misiniz?')) {
                fetch(`/api/resources/${resourceId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Hata: ' + data.error);
                    } else {
                        alert('Kaynak başarıyla silindi!');
                        
                        // Sayfayı yenile
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('Kaynak silme hatası:', error);
                    alert('Kaynak silinemedi!');
                });
            }
        }
        
        function updateResourceCapacityCalculation() {
            try {
                // Zamanlama ayarlarını al
                if (!schedulingSettings) {
                    schedulingSettings = {
                        workStartTime: '09:00',
                        workEndTime: '18:00',
                        lunchBreak: 45,
                        shortBreak: 15,
                        workingDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                        holidays: [],
                        qualityCheckTime: 30
                    };
                }
                
                // Çalışma saatleri hesaplama
                const startTime = new Date(`2000-01-01T${schedulingSettings.workStartTime}:00`);
                const endTime = new Date(`2000-01-01T${schedulingSettings.workEndTime}:00`);
                if (endTime <= startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                const workHours = (endTime - startTime) / (1000 * 60 * 60);
                const totalBreakHours = (schedulingSettings.lunchBreak + schedulingSettings.shortBreak) / 60;
                const netWorkHours = workHours - totalBreakHours;
                
                // Kaynak kapasitesi
                const resourceCapacityElement = document.getElementById('resource-capacity');
                const resourceCapacity = resourceCapacityElement ? parseInt(resourceCapacityElement.value) || 1 : 1;
                
                // Günlük üretim hesaplama
                const dailyProduction = Math.round(netWorkHours * resourceCapacity);
                
                // Güncelleme
                const workHoursElement = document.getElementById('resource-work-hours');
                const netWorkElement = document.getElementById('resource-net-work');
                const capacityDisplayElement = document.getElementById('resource-capacity-display');
                const dailyProductionElement = document.getElementById('resource-daily-production');
                
                if (workHoursElement) {
                    workHoursElement.textContent = `${schedulingSettings.workStartTime} - ${schedulingSettings.workEndTime}`;
                }
                
                if (netWorkElement) {
                    netWorkElement.textContent = `${netWorkHours.toFixed(1)} saat`;
                }
                
                if (capacityDisplayElement) {
                    capacityDisplayElement.textContent = `${resourceCapacity} adet/saat`;
                }
                
                if (dailyProductionElement) {
                    dailyProductionElement.textContent = `${dailyProduction} adet/gün`;
                }
                
            } catch (error) {
                console.error('Kapasite hesaplama hatası:', error);
            }
        }
        
        // Üretim planı yönetimi fonksiyonları
        let currentPlanId = null;
        let availableOrders = [];
        let selectedOrders = [];
        let allPlans = [];
        let currentView = 'gantt';
        let currentDateFilter = 'all';
        
        // Siparişlerden plan oluşturma fonksiyonları
        function showCreatePlanFromOrdersModal() {
            selectedOrders = [];
            loadAvailableOrders();
            
            // Operatör listesini yükle
            loadOperatorsForPlan();
            
            // Bugünün tarihini başlangıç tarihi olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date-from-orders').value = today;
            
            // Varsayılan plan durumunu ayarla
            document.getElementById('plan-status-from-orders').value = 'draft';
            
            // Plan tipine göre bitiş tarihini ayarla
            document.getElementById('plan-type-from-orders').addEventListener('change', function() {
                const planType = this.value;
                const startDate = new Date(document.getElementById('start-date-from-orders').value);
                let endDate = new Date(startDate);
                
                switch(planType) {
                    case 'daily':
                        endDate.setDate(startDate.getDate() + 1);
                        break;
                    case 'weekly':
                        endDate.setDate(startDate.getDate() + 7);
                        break;
                    case 'monthly':
                        endDate.setMonth(startDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        endDate.setMonth(startDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        endDate.setFullYear(startDate.getFullYear() + 1);
                        break;
                }
                
                document.getElementById('end-date-from-orders').value = endDate.toISOString().split('T')[0];
                
                // Kapasite analizini güncelle
                updateCapacityAnalysis();
            });
            
            // Tarih değişikliklerinde kapasite analizini güncelle
            document.getElementById('start-date-from-orders').addEventListener('change', updateCapacityAnalysis);
            document.getElementById('end-date-from-orders').addEventListener('change', updateCapacityAnalysis);
            
            // Plan durumu değişikliklerinde özeti güncelle
            document.getElementById('plan-status-from-orders').addEventListener('change', updatePlanSummary);
            
            const modal = new bootstrap.Modal(document.getElementById('createPlanFromOrdersModal'));
            modal.show();
        }
        
        function loadAvailableOrders() {
            fetch('/api/orders')
                .then(response => response.json())
                .then(orders => {
                    availableOrders = orders;
                    renderOrdersList();
                    updatePlanSummary();
                })
                .catch(error => {
                    console.error('Siparişler yükleme hatası:', error);
                    document.getElementById('orders-selection-container').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Siparişler Yüklenemedi!</h6>
                            <p>Siparişler yüklenirken hata oluştu: ${error.message}</p>
                        </div>
                    `;
                });
        }
        
        // Plan oluşturma için operatör listesini yükle
        async function loadOperatorsForPlan() {
            try {
                const response = await fetch('/api/operators');
                const operators = await response.json();
                
                const operatorSelect = document.getElementById('assigned-operator-from-orders');
                if (operatorSelect) {
                    operatorSelect.innerHTML = '<option value="">Operatör Seçiniz</option>';
                    
                    operators.forEach(operator => {
                        const option = document.createElement('option');
                        option.value = operator.name || operator;
                        option.textContent = operator.name || operator;
                        // Operatör detaylarını tooltip olarak ekle
                        if (operator.skill_level || operator.department) {
                            option.title = `${operator.department || 'Üretim'} - ${operator.skill_level || 'Uzman'}`;
                        }
                        operatorSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Operatör listesi yüklenemedi:', error);
                // Fallback operatör listesi
                const operatorSelect = document.getElementById('assigned-operator-from-orders');
                if (operatorSelect) {
                    operatorSelect.innerHTML = `
                        <option value="">Operatör Seçiniz</option>
                        <option value="Thunder Serisi Operatör">Thunder Serisi Operatör</option>
                        <option value="ThunderPRO Serisi Operatör">ThunderPRO Serisi Operatör</option>
                    `;
                }
            }
        }
        
        function renderOrdersList() {
            const container = document.getElementById('orders-selection-container');
            const statusFilter = document.getElementById('order-status-filter').value;
            
            let filteredOrders = availableOrders;
            if (statusFilter !== 'all') {
                filteredOrders = availableOrders.filter(order => order.status === statusFilter);
            }
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Sipariş Bulunamadı</h6>
                        <p>Seçilen duruma göre sipariş bulunmuyor.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="list-group">
                    ${filteredOrders.map(order => `
                        <div class="list-group-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       value="${order.id}" 
                                       id="order-${order.id}"
                                       onchange="toggleOrderSelection(${order.id})"
                                       ${selectedOrders.find(so => so.id === order.id) ? 'checked' : ''}>
                                <label class="form-check-label w-100" for="order-${order.id}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">${order.order_number}</h6>
                                            <p class="mb-1 text-muted">${order.customer_name}</p>
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>${formatDate(order.delivery_date)}
                                                <span class="badge ${getOrderStatusBadgeClass(order.status)} ms-2">${getOrderStatusText(order.status)}</span>
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted">
                                                Öncelik: ${getOrderPriorityText(order.priority)}
                                            </small>
                                            <br>
                                            <small class="text-info">
                                                ${order.quantity ? `Ürün Sayısı: ${order.quantity}` : 
                                                  order.product_details ? 'Detaylı Ürün' : 
                                                  'Ürün Sayısı: 1'}
                                            </small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function filterOrders() {
            renderOrdersList();
        }
        
        function toggleOrderSelection(orderId) {
            const order = availableOrders.find(o => o.id === orderId);
            const isSelected = selectedOrders.find(so => so.id === orderId);
            
            if (isSelected) {
                selectedOrders = selectedOrders.filter(so => so.id !== orderId);
            } else {
                selectedOrders.push(order);
            }
            
            renderSelectedOrders();
            
            // Kapasite analizini güncelle (bu da bitiş tarihini otomatik güncelleyecek)
            updateCapacityAnalysis();
            updatePlanSummary();
        }
        
        function renderSelectedOrders() {
            const container = document.getElementById('selected-orders-list');
            
            if (selectedOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-info-circle me-1"></i>
                        Plan oluşturmak için sipariş seçiniz
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                ${selectedOrders.map(order => {
                    // Sipariş miktarını hesapla
                    let orderQuantity = 0;
                    if (order.quantity) {
                        orderQuantity = parseInt(order.quantity);
                    } else if (order.product_details) {
                        try {
                            const details = typeof order.product_details === 'string' ? 
                                          JSON.parse(order.product_details) : order.product_details;
                            if (Array.isArray(details)) {
                                orderQuantity = details.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
                            }
                        } catch (e) {
                            orderQuantity = 1;
                        }
                    } else {
                        orderQuantity = 1;
                    }
                    
                    return `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <strong>${order.order_number}</strong>
                            <small class="text-muted d-block">${order.customer_name}</small>
                            <small class="text-info">Ürün Sayısı: ${orderQuantity}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderFromSelection(${order.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    `;
                }).join('')}
            `;
        }
        
        function removeOrderFromSelection(orderId) {
            selectedOrders = selectedOrders.filter(so => so.id !== orderId);
            
            // Checkbox'ı da işaretini kaldır
            const checkbox = document.getElementById(`order-${orderId}`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            renderSelectedOrders();
            
            // Kapasite analizini güncelle (bu da bitiş tarihini otomatik güncelleyecek)
            updateCapacityAnalysis();
            updatePlanSummary();
        }
        
        function updatePlanSummary() {
            document.getElementById('selected-orders-count').textContent = selectedOrders.length;
            
            // Toplam ürün sayısını hesapla
            let totalProducts = 0;
            selectedOrders.forEach(order => {
                if (order.notes && order.notes.includes('[ÜRÜN DETAYLARI:')) {
                    try {
                        const parts = order.notes.split('[ÜRÜN DETAYLARI:');
                        if (parts[1]) {
                            const jsonPart = parts[1].replace(']', '').trim();
                            const products = JSON.parse(jsonPart);
                            totalProducts += products.reduce((sum, product) => sum + product.quantity, 0);
                        }
                    } catch (error) {
                        console.log('Ürün detayları parse edilemedi:', error);
                    }
                }
            });
            
            document.getElementById('total-products-count').textContent = totalProducts;
            
            // Plan durumunu güncelle
            const planStatusSelect = document.getElementById('plan-status-from-orders');
            const selectedStatus = planStatusSelect ? planStatusSelect.value : 'draft';
            const statusTexts = {
                'draft': 'Taslak',
                'approved': 'Onaylanmış',
                'active': 'Aktif',
                'completed': 'Tamamlanmış',
                'cancelled': 'İptal Edilmiş'
            };
            document.getElementById('selected-plan-status').textContent = statusTexts[selectedStatus] || 'Taslak';
            
            // Plan adını otomatik oluştur
            if (selectedOrders.length > 0) {
                const dateStr = new Date().toLocaleDateString('tr-TR');
                // Toplam ürün adedini hesapla
                const totalQuantity = selectedOrders.reduce((sum, order) => {
                    return sum + (order.quantity || 0);
                }, 0);
                document.getElementById('plan-name-from-orders').value = `Sipariş Planı - ${dateStr} (${totalQuantity} adet)`;
            } else {
                document.getElementById('plan-name-from-orders').value = '';
            }
        }
        
        function createPlanFromSelectedOrders() {
            // Validation
            if (selectedOrders.length === 0) {
                alert('Lütfen en az bir sipariş seçiniz!');
                return;
            }
            
            if (!document.getElementById('plan-name-from-orders').value || 
                !document.getElementById('plan-type-from-orders').value || 
                !document.getElementById('plan-status-from-orders').value ||
                !document.getElementById('start-date-from-orders').value || 
                !document.getElementById('end-date-from-orders').value ||
                !document.getElementById('assigned-operator-from-orders').value) {
                alert('Lütfen tüm zorunlu alanları doldurun! (Operatör seçimi zorunludur)');
                return;
            }
            
            // Plan verilerini hazırla
            const planData = {
                plan_name: document.getElementById('plan-name-from-orders').value,
                plan_type: document.getElementById('plan-type-from-orders').value,
                start_date: document.getElementById('start-date-from-orders').value,
                end_date: document.getElementById('end-date-from-orders').value,
                status: document.getElementById('plan-status-from-orders').value,
                created_by: 'Admin',
                assigned_operator: document.getElementById('assigned-operator-from-orders').value || null,
                operator_notes: document.getElementById('operator-notes-from-orders').value,
                notes: document.getElementById('plan-notes-from-orders').value + '\n\n[SEÇİLEN SİPARİŞLER: ' + JSON.stringify(selectedOrders.map(o => ({
                    id: o.id,
                    order_number: o.order_number,
                    customer_name: o.customer_name,
                    delivery_date: o.delivery_date,
                    quantity: o.quantity || 0
                }))) + ']'
            };
            
            // Plan oluştur
            fetch('/api/production-plans', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(planData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    alert('Üretim planı başarıyla oluşturuldu!');
                    
                    // Seçilen siparişlerin durumunu "processing" olarak güncelle
                    updateSelectedOrdersStatus();
                    
                    bootstrap.Modal.getInstance(document.getElementById('createPlanFromOrdersModal')).hide();
                    
                    // Sayfayı yenile
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Plan oluşturma hatası:', error);
                alert('Plan oluşturulamadı!');
            });
        }
        
        function updateSelectedOrdersStatus() {
            selectedOrders.forEach(order => {
                fetch(`/api/orders/${order.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...order,
                        status: 'processing'
                    })
                })
                .catch(error => {
                    console.error(`Sipariş ${order.id} durumu güncellenemedi:`, error);
                });
            });
        }
        
        // Sipariş durumlarını kontrol et ve düzelt
        function checkAndFixOrderStatuses() {
            fetch('/api/orders')
                .then(response => response.json())
                .then(orders => {
                    const processingOrders = orders.filter(order => order.status === 'processing');
                    if (processingOrders.length > 0) {
                        console.log('Processing durumundaki siparişler:', processingOrders.map(o => o.order_number || o.id));
                        
                        // Bu siparişlerin aktif üretim planı var mı kontrol et
                        fetch('/api/production-plans')
                            .then(response => response.json())
                            .then(plans => {
                                const activePlans = plans.filter(plan => 
                                    plan.status === 'active' || plan.status === 'approved'
                                );
                                
                                if (activePlans.length === 0) {
                                    console.log('Aktif üretim planı yok, sipariş durumları düzeltiliyor...');
                                    
                                    // Tüm processing siparişlerini pending yap
                                    processingOrders.forEach(order => {
                                        fetch(`/api/orders/${order.id}`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({
                                                status: 'pending'
                                            })
                                        })
                                        .then(() => {
                                            console.log(`Sipariş ${order.order_number || order.id} durumu pending olarak güncellendi`);
                                        })
                                        .catch(error => {
                                            console.error(`Sipariş ${order.id} durumu güncellenemedi:`, error);
                                        });
                                    });
                                    
                                    // Sayfayı yenile
                                    setTimeout(() => {
                                        loadOrders();
                                    }, 1000);
                                }
                            })
                            .catch(error => {
                                console.error('Üretim planları kontrol hatası:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Sipariş durumu kontrol hatası:', error);
                });
        }
        
        // Yardımcı fonksiyonlar
        function getOrderStatusBadgeClass(status) {
            switch(status) {
                case 'pending': return 'bg-warning';
                case 'processing': return 'bg-info';
                case 'completed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function getOrderStatusText(status) {
            switch(status) {
                case 'pending': return 'Bekleyen';
                case 'processing': return 'İşlenen';
                case 'completed': return 'Tamamlanan';
                case 'cancelled': return 'İptal';
                default: return status;
            }
        }
        
        function getOrderPriorityText(priority) {
            switch(priority) {
                case 1: return 'Düşük';
                case 2: return 'Orta';
                case 3: return 'Yüksek';
                case 4: return 'Acil';
                default: return 'Bilinmiyor';
            }
        }
        
        // Yardımcı fonksiyonlar
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'draft': return 'bg-secondary';
                case 'active': return 'bg-success';
                case 'completed': return 'bg-primary';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'draft': return 'Taslak';
                case 'active': return 'Aktif';
                case 'completed': return 'Tamamlandı';
                case 'cancelled': return 'İptal';
                default: return status;
            }
        }
        
        function getPlanTypeText(type) {
            switch(type) {
                case 'daily': return 'Günlük';
                case 'weekly': return 'Haftalık';
                case 'monthly': return 'Aylık';
                case 'quarterly': return 'Çeyreklik';
                case 'yearly': return 'Yıllık';
                default: return type;
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }
        
        function viewPlanDetails(planId) {
            fetch(`/api/production-plans/${planId}`)
                .then(response => response.json())
                .then(plan => {
                    // Gelişmiş plan detayları modal'ını göster
                    showAdvancedPlanDetails(plan);
                    
                    // Önceki modal varsa kaldır
                    const existingModal = document.getElementById('planDetailsModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Yeni modal ekle
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                    const modal = new bootstrap.Modal(document.getElementById('planDetailsModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Plan detayları yükleme hatası:', error);
                    alert('Plan detayları yüklenemedi!');
                });
        }
        
        function editPlan(planId) {
            currentPlanId = planId;
            document.getElementById('planModalTitle').textContent = 'Üretim Planını Düzenle';
            
            // Plan verilerini yükle
            fetch(`/api/production-plans/${planId}`)
                .then(response => response.json())
                .then(plan => {
                    // Form alanlarını doldur
                    document.getElementById('plan-name').value = plan.plan_name || '';
                    document.getElementById('plan-type').value = plan.plan_type || '';
                    document.getElementById('start-date').value = plan.start_date || '';
                    document.getElementById('end-date').value = plan.end_date || '';
                    document.getElementById('plan-status').value = plan.status || 'draft';
                    document.getElementById('created-by').value = plan.created_by || 'Admin';
                    document.getElementById('plan-notes').value = plan.notes || '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('planModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Plan yükleme hatası:', error);
                    alert('Plan bilgileri yüklenemedi!');
                });
        }
        
        function deletePlan(planId) {
            if (confirm('Bu üretim planını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                fetch(`/api/production-plans/${planId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Hata: ' + data.error);
                    } else {
                        alert('Üretim planı başarıyla silindi!');
                        
                        // Üretim planları listesini yenile
                        loadProductionPlans();
                        
                        // Sipariş listesini de yenile (durum değişiklikleri için)
                        setTimeout(() => {
                            loadOrders();
                        }, 500);
                    }
                })
                .catch(error => {
                    console.error('Plan silme hatası:', error);
                    alert('Plan silinemedi!');
                });
            }
        }
        
        function showAddPlanModal() {
            currentPlanId = null;
            document.getElementById('planModalTitle').textContent = 'Yeni Üretim Planı';
            document.getElementById('planForm').reset();
            
            // Bugünün tarihini başlangıç tarihi olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
            
            // Zamanlama bilgilerini güncelle
            updateSchedulingInfoInModal();
            
            // Plan tipine göre bitiş tarihini ayarla
            document.getElementById('plan-type').addEventListener('change', function() {
                const planType = this.value;
                const startDate = new Date(document.getElementById('start-date').value);
                let endDate = new Date(startDate);
                
                switch(planType) {
                    case 'daily':
                        endDate.setDate(startDate.getDate() + 1);
                        break;
                    case 'weekly':
                        endDate.setDate(startDate.getDate() + 7);
                        break;
                    case 'monthly':
                        endDate.setMonth(startDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        endDate.setMonth(startDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        endDate.setFullYear(startDate.getFullYear() + 1);
                        break;
                }
                
                document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            });
            
            document.getElementById('plan-status').value = 'draft';
            
            const modal = new bootstrap.Modal(document.getElementById('planModal'));
            modal.show();
        }
        
        function savePlan() {
            try {
                // Validation
                if (!document.getElementById('plan-name').value || 
                    !document.getElementById('plan-type').value || 
                    !document.getElementById('start-date').value || 
                    !document.getElementById('end-date').value) {
                    alert('Lütfen tüm zorunlu alanları doldurun!');
                    return;
                }
                
                // Zamanlama ayarları kontrolü
                if (!schedulingSettings) {
                    console.warn('Zamanlama ayarları bulunamadı, varsayılan değerler kullanılıyor');
                    schedulingSettings = {
                        workStartTime: '09:00',
                        workEndTime: '18:00',
                        lunchBreak: 45,
                        shortBreak: 15,
                        workingDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                        holidays: [],
                        machineCapacity: 10
                    };
                }
                
                // Zamanlama verilerini hesapla
                const startDate = new Date(document.getElementById('start-date').value);
                const endDate = new Date(document.getElementById('end-date').value);
                const workingDays = calculateWorkingDays(startDate, endDate);
                
                // Net çalışma süresini hesapla
                const startTime = new Date(`2000-01-01T${schedulingSettings.workStartTime}:00`);
                const endTime = new Date(`2000-01-01T${schedulingSettings.workEndTime}:00`);
                
                if (endTime <= startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                const workHours = (endTime - startTime) / (1000 * 60 * 60);
                const totalBreakHours = (schedulingSettings.lunchBreak + schedulingSettings.shortBreak) / 60;
                const netWorkHours = workHours - totalBreakHours;
                
                // Toplam kapasiteyi hesapla
                const totalCapacity = workingDays * netWorkHours * 10; // Varsayılan makine kapasitesi
            
            const formData = {
                plan_name: document.getElementById('plan-name').value,
                plan_type: document.getElementById('plan-type').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value,
                status: document.getElementById('plan-status').value || 'draft',
                created_by: document.getElementById('created-by').value || 'Admin',
                notes: document.getElementById('plan-notes').value || '',
                // Zamanlama verileri - artık ayrı alanlarda
                working_days: workingDays,
                net_work_hours: parseFloat(netWorkHours.toFixed(2)),
                daily_capacity: Math.round(netWorkHours * 10), // Varsayılan makine kapasitesi
                total_capacity: Math.round(totalCapacity),
                scheduling_settings: JSON.stringify(schedulingSettings)
            };
            
            const url = currentPlanId ? `/api/production-plans/${currentPlanId}` : '/api/production-plans';
            const method = currentPlanId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    alert(currentPlanId ? 'Plan başarıyla güncellendi!' : 'Plan başarıyla oluşturuldu!');
                    bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
                    
                    // Plan listesini yenile
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Plan kaydetme hatası:', error);
                showNotification('Plan kaydedilemedi: ' + error.message, 'error');
            });
            } catch (error) {
                console.error('Plan oluşturma hatası:', error);
                showNotification('Plan oluşturulamadı: ' + error.message, 'error');
            }
        }
        
        // Görünüm değiştirme ve plan görselleştirme fonksiyonları
        function switchView(viewType) {
            currentView = viewType;
            
            // Buton durumlarını güncelle
            document.getElementById('gantt-view-btn').classList.toggle('active', viewType === 'gantt');
            document.getElementById('timeline-view-btn').classList.toggle('active', viewType === 'timeline');
            
            // Planları yeniden render et - allPlans varsa onu kullan
            if (allPlans && allPlans.length > 0) {
                renderPlansView(allPlans);
            } else {
                // Eğer allPlans yoksa, API'den tekrar yükle
                fetch('/api/production-plans')
                    .then(response => response.json())
                    .then(data => {
                        allPlans = data;
                        renderPlansView(data);
                    })
                    .catch(error => {
                        console.error('Üretim planları yükleme hatası:', error);
                        renderPlansView([]);
                    });
            }
        }
        
        function filterByDateRange(range) {
            currentDateFilter = range;
            
            // Buton durumlarını güncelle
            document.querySelectorAll('[onclick^="filterByDateRange"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filteredPlans = allPlans || [];
            const now = new Date();
            
            switch(range) {
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    
                    filteredPlans = allPlans.filter(plan => {
                        const planStart = new Date(plan.start_date);
                        return planStart >= weekStart && planStart <= weekEnd;
                    });
                    break;
                    
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    
                    filteredPlans = allPlans.filter(plan => {
                        const planStart = new Date(plan.start_date);
                        return planStart >= monthStart && planStart <= monthEnd;
                    });
                    break;
                    
                case 'all':
                default:
                    filteredPlans = allPlans;
                    break;
            }
            
            renderPlansView(filteredPlans);
        }
        
        window.renderPlansView = function(plans) {
            const container = document.getElementById('production-plans-container');
            
            // Eğer plans parametresi yoksa, allPlans'ı kullan
            if (!plans) {
                plans = allPlans || [];
            }
            
            if (!plans || plans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Henüz üretim planı bulunmuyor</h5>
                        <p class="text-muted">Yeni üretim planı oluşturmak için "Yeni Plan" butonuna tıklayın.</p>
                    </div>
                `;
                return;
            }
            
            switch(currentView) {
                case 'gantt':
                    renderGanttView(plans, container);
                    break;
                case 'timeline':
                    renderTimelineView(plans, container);
                    break;
                default:
                    renderGanttView(plans, container);
                    break;
            }
        };
        
        function renderGanttView(plans, container) {
            // Container kontrolü
            if (!container) {
                console.error('Gantt view için container bulunamadı');
                return;
            }
            
            // Plan kontrolü
            if (!plans || plans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-gantt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Görüntülenecek plan bulunmuyor</h5>
                    </div>
                `;
                return;
            }
            
            // Tarih aralığını hesapla
            const dates = plans.flatMap(plan => [new Date(plan.start_date), new Date(plan.end_date)]);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            // Gantt chart HTML'i oluştur
            const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
            const chartWidth = Math.max(800, daysDiff * 40);
            
            container.innerHTML = `
                <div class="gantt-container" style="overflow-x: auto;">
                    <div class="gantt-chart" style="width: ${chartWidth}px; min-width: 800px;">
                        <div class="gantt-header">
                            <div class="gantt-row">
                                <div class="gantt-task-column" style="width: 200px;">Plan Adı</div>
                                <div class="gantt-timeline-column" style="width: ${chartWidth - 200}px;">
                                    <div class="gantt-timeline">
                                        ${generateTimelineHeader(minDate, maxDate)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="gantt-body">
                            ${plans.map(plan => `
                                <div class="gantt-row">
                                    <div class="gantt-task-column" style="width: 200px;">
                                        <div class="gantt-task-name">
                                            <strong>${plan.plan_name}</strong>
                                            <small class="text-muted d-block">${getPlanTypeText(plan.plan_type)}</small>
                                            <span class="badge ${getStatusBadgeClass(plan.status)} badge-sm">${getStatusText(plan.status)}</span>
                                            ${plan.working_days ? `<small class="text-info d-block"><i class="fas fa-calendar me-1"></i>${plan.working_days} çalışma günü</small>` : ''}
                                            ${plan.total_capacity ? `<small class="text-success d-block"><i class="fas fa-cogs me-1"></i>${plan.total_capacity} adet kapasite</small>` : ''}
                                            ${plan.total_quantity ? `<small class="text-primary d-block"><i class="fas fa-boxes me-1"></i>${plan.total_quantity} adet ürün</small>` : ''}
                                            ${plan.total_orders ? `<small class="text-warning d-block"><i class="fas fa-shopping-cart me-1"></i>${plan.total_orders} sipariş</small>` : ''}
                                        </div>
                                    </div>
                                    <div class="gantt-timeline-column" style="width: ${chartWidth - 200}px;">
                                        <div class="gantt-bar" style="${generateGanttBarStyle(plan, minDate, chartWidth - 200)}">
                                            <div class="gantt-bar-content">
                                                ${formatDate(plan.start_date)} - ${formatDate(plan.end_date)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <style>
                    .gantt-container { border: 1px solid #dee2e6; border-radius: 0.375rem; }
                    .gantt-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
                    .gantt-row { display: flex; border-bottom: 1px solid #e9ecef; }
                    .gantt-row:last-child { border-bottom: none; }
                    .gantt-task-column { padding: 10px; border-right: 1px solid #dee2e6; background-color: #f8f9fa; }
                    .gantt-timeline-column { position: relative; padding: 5px; }
                    .gantt-timeline { display: flex; height: 30px; }
                    .gantt-timeline-day { flex: 1; text-align: center; font-size: 12px; padding: 5px 0; border-right: 1px solid #e9ecef; }
                    .gantt-bar { height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; cursor: pointer; }
                    .gantt-bar-content { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                    .badge-sm { font-size: 0.7em; }
                    
                    /* Timeline Stilleri */
                    .timeline {
                        position: relative;
                        padding-left: 30px;
                    }
                    
                    .timeline::before {
                        content: '';
                        position: absolute;
                        left: 15px;
                        top: 0;
                        bottom: 0;
                        width: 2px;
                        background: #dee2e6;
                    }
                    
                    .timeline-item {
                        position: relative;
                        margin-bottom: 20px;
                    }
                    
                    .timeline-marker {
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        position: absolute;
                        left: -21px;
                        top: 15px;
                        border: 2px solid #fff;
                        box-shadow: 0 0 0 2px #dee2e6;
                    }
                    
                    .timeline-marker.bg-success {
                        background-color: #28a745 !important;
                        box-shadow: 0 0 0 2px #28a745;
                    }
                    
                    .timeline-marker.bg-warning {
                        background-color: #ffc107 !important;
                        box-shadow: 0 0 0 2px #ffc107;
                    }
                    
                    .timeline-marker.bg-secondary {
                        background-color: #6c757d !important;
                        box-shadow: 0 0 0 2px #6c757d;
                    }
                    
                    .timeline-marker.bg-danger {
                        background-color: #dc3545 !important;
                        box-shadow: 0 0 0 2px #dc3545;
                    }
                    
                    .timeline-content {
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 15px;
                        border-left: 4px solid #007bff;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                </style>
            `;
        }
        
        function renderTimelineView(plans, container) {
            // Container kontrolü
            if (!container) {
                console.error('Timeline view için container bulunamadı');
                return;
            }
            
            // Planları tarihe göre sırala
            const sortedPlans = [...plans].sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
            
            container.innerHTML = `
                <div class="timeline-container">
                    ${sortedPlans.map((plan, index) => `
                        <div class="timeline-item">
                            <div class="timeline-marker ${getStatusBadgeClass(plan.status)}"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h6 class="mb-1">${plan.plan_name}</h6>
                                    <div class="timeline-meta">
                                        <span class="badge ${getStatusBadgeClass(plan.status)} me-2">${getStatusText(plan.status)}</span>
                                        <span class="text-muted">
                                            <i class="fas fa-tag me-1"></i>${getPlanTypeText(plan.plan_type)}
                                        </span>
                                    </div>
                                </div>
                                <div class="timeline-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Başlangıç:</strong> ${formatDate(plan.start_date)}</p>
                                            <p class="mb-1"><strong>Bitiş:</strong> ${formatDate(plan.end_date)}</p>
                                            ${plan.working_days ? `<p class="mb-1"><strong>Çalışma Günleri:</strong> ${plan.working_days} gün</p>` : ''}
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>Oluşturan:</strong> ${plan.created_by || 'Admin'}</p>
                                            <p class="mb-1"><strong>Süre:</strong> ${calculatePlanDuration(plan.start_date, plan.end_date)} gün</p>
                                            ${plan.total_capacity ? `<p class="mb-1"><strong>Toplam Kapasite:</strong> ${plan.total_capacity} adet</p>` : ''}
                                            ${plan.net_work_hours ? `<p class="mb-1"><strong>Net Çalışma:</strong> ${plan.net_work_hours} saat</p>` : ''}
                                        </div>
                                    </div>
                                    ${plan.notes ? `<p class="mb-2"><strong>Notlar:</strong> ${plan.notes.substring(0, 150)}${plan.notes.length > 150 ? '...' : ''}</p>` : ''}
                                </div>
                                <div class="timeline-actions">
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="viewPlanDetails(${plan.id})">
                                        <i class="fas fa-eye me-1"></i>Detay
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm me-2" onclick="editPlan(${plan.id})">
                                        <i class="fas fa-edit me-1"></i>Düzenle
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deletePlan(${plan.id})">
                                        <i class="fas fa-trash me-1"></i>Sil
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <style>
                    .timeline-container { position: relative; padding-left: 30px; }
                    .timeline-item { position: relative; margin-bottom: 30px; }
                    .timeline-marker { position: absolute; left: -37px; top: 5px; width: 14px; height: 14px; border-radius: 50%; border: 3px solid #fff; }
                    .timeline-item:not(:last-child)::before { content: ''; position: absolute; left: -30px; top: 19px; width: 2px; height: 100%; background-color: #dee2e6; }
                    .timeline-content { background: #fff; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                    .timeline-header { border-bottom: 1px solid #e9ecef; padding-bottom: 10px; margin-bottom: 15px; }
                    .timeline-meta { margin-top: 5px; }
                    .timeline-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef; }
                </style>
            `;
        }
        
        // Yardımcı fonksiyonlar
        function generateTimelineHeader(minDate, maxDate) {
            const daysDiff = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
            let html = '';
            
            for (let i = 0; i <= daysDiff; i++) {
                const date = new Date(minDate);
                date.setDate(minDate.getDate() + i);
                html += `<div class="gantt-timeline-day">${date.getDate()}/${date.getMonth() + 1}</div>`;
            }
            
            return html;
        }
        
        function generateGanttBarStyle(plan, minDate, timelineWidth) {
            const startDate = new Date(plan.start_date);
            const endDate = new Date(plan.end_date);
            
            // Tüm planların tarih aralığını hesapla
            const allDates = allPlans.flatMap(p => [new Date(p.start_date), new Date(p.end_date)]);
            const maxDate = new Date(Math.max(...allDates));
            
            // Toplam gün sayısını hesapla
            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Plan başlangıcının minDate'den kaç gün sonra olduğunu hesapla
            const startOffset = Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24));
            
            // Plan süresini gün cinsinden hesapla
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Yüzde hesaplamaları
            const leftPercent = (startOffset / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            
            // Durum rengini belirle
            let backgroundColor = '#6c757d'; // default gray
            switch(plan.status) {
                case 'draft': backgroundColor = '#6c757d'; break;
                case 'active': backgroundColor = '#28a745'; break;
                case 'completed': backgroundColor = '#007bff'; break;
                case 'cancelled': backgroundColor = '#dc3545'; break;
            }
            
            return `
                position: absolute;
                left: ${leftPercent}%;
                width: ${widthPercent}%;
                background-color: ${backgroundColor};
                height: 30px;
                top: 5px;
            `;
        }
        
        function calculatePlanDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }
        
        
        // Zamanlama Modalı Fonksiyonları
        let schedulingSettings = {
            workStartTime: '09:00',
            workEndTime: '18:00',
            lunchBreak: 45,
            shortBreak: 15,
            workingDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
            holidays: [],
            machineCapacity: 10,
            qualityCheckTime: 30
        };

        function showSchedulingModal() {
            const modal = new bootstrap.Modal(document.getElementById('schedulingModal'));
            modal.show();
            
            // Mevcut ayarları yükle
            loadSchedulingSettings();
            
            // Event listener'ları ekle
            setupSchedulingEventListeners();
        }

        function loadSchedulingSettings() {
            // Çalışma saatleri
            document.getElementById('work-start-time').value = schedulingSettings.workStartTime;
            document.getElementById('work-end-time').value = schedulingSettings.workEndTime;
            
            // Mola süreleri
            document.getElementById('lunch-break').value = schedulingSettings.lunchBreak;
            document.getElementById('short-break').value = schedulingSettings.shortBreak;
            
            // Çalışma günleri
            schedulingSettings.workingDays.forEach(day => {
                const checkbox = document.getElementById(day);
                if (checkbox) checkbox.checked = true;
            });
            
            // Tatil günleri
            document.getElementById('holiday-dates').value = schedulingSettings.holidays.join(', ');
            
            // Kalite kontrol ayarları
            document.getElementById('quality-check-time').value = schedulingSettings.qualityCheckTime;
            
            // Hesaplamaları güncelle
            updateSchedulingCalculations();
        }

        function setupSchedulingEventListeners() {
            // Çalışma saatleri değişikliği
            document.getElementById('work-start-time').addEventListener('change', updateSchedulingCalculations);
            document.getElementById('work-end-time').addEventListener('change', updateSchedulingCalculations);
            
            // Mola süreleri değişikliği
            document.getElementById('lunch-break').addEventListener('input', updateSchedulingCalculations);
            document.getElementById('short-break').addEventListener('input', updateSchedulingCalculations);
            
            // Çalışma günleri değişikliği
            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                const checkbox = document.getElementById(day);
                if (checkbox) {
                    checkbox.addEventListener('change', updateSchedulingCalculations);
                }
            });
            
        }

        function updateSchedulingCalculations() {
            try {
                // Çalışma saatleri hesaplama
                const startTimeElement = document.getElementById('work-start-time');
                const endTimeElement = document.getElementById('work-end-time');
                
                if (startTimeElement && endTimeElement) {
                    const startTime = startTimeElement.value;
                    const endTime = endTimeElement.value;
                    
                    if (startTime && endTime) {
                        const start = new Date(`2000-01-01T${startTime}:00`);
                        const end = new Date(`2000-01-01T${endTime}:00`);
                        
                        // Eğer bitiş saati başlangıçtan küçükse (gece vardiyası), bir gün ekle
                        if (end <= start) {
                            end.setDate(end.getDate() + 1);
                        }
                        
                        const workHours = (end - start) / (1000 * 60 * 60);
                        const dailyWorkHoursElement = document.getElementById('daily-work-hours');
                        if (dailyWorkHoursElement) {
                            dailyWorkHoursElement.textContent = workHours.toFixed(1);
                        }
                    }
                }
                
                // Mola süreleri hesaplama
                const lunchBreakElement = document.getElementById('lunch-break');
                const shortBreakElement = document.getElementById('short-break');
                
                const lunchBreak = lunchBreakElement ? parseInt(lunchBreakElement.value) || 0 : 0;
                const shortBreak = shortBreakElement ? parseInt(shortBreakElement.value) || 0 : 0;
                const totalBreakMinutes = lunchBreak + shortBreak;
                const totalBreakHours = totalBreakMinutes / 60;
                
                const totalBreakTimeElement = document.getElementById('total-break-time');
                if (totalBreakTimeElement) {
                    totalBreakTimeElement.textContent = totalBreakHours.toFixed(1);
                }
                
                // Net çalışma süresi
                const dailyWorkHoursElement = document.getElementById('daily-work-hours');
                const dailyWorkHours = dailyWorkHoursElement ? parseFloat(dailyWorkHoursElement.textContent) || 9 : 9;
                const netWorkHours = dailyWorkHours - totalBreakHours;
                
                const summaryNetWorkElement = document.getElementById('summary-net-work');
                if (summaryNetWorkElement) {
                    summaryNetWorkElement.textContent = netWorkHours.toFixed(1);
                }
                
                // Haftalık çalışma süresi
                const workingDaysCount = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']
                    .filter(day => {
                        const checkbox = document.getElementById(day);
                        return checkbox && checkbox.checked;
                    }).length;
                const weeklyWorkHours = dailyWorkHours * workingDaysCount;
                
                const summaryWeeklyWorkElement = document.getElementById('summary-weekly-work');
                if (summaryWeeklyWorkElement) {
                    summaryWeeklyWorkElement.textContent = weeklyWorkHours.toFixed(1);
                }
                
                
                // Özet güncelleme
                const summaryDailyWorkElement = document.getElementById('summary-daily-work');
                if (summaryDailyWorkElement) {
                    summaryDailyWorkElement.textContent = dailyWorkHours.toFixed(1);
                }
                
            } catch (error) {
                console.error('Hesaplama güncelleme hatası:', error);
            }
        }

        function saveSchedulingSettings() {
            try {
                // Ayarları topla
                const newSettings = {
                    workStartTime: document.getElementById('work-start-time').value || '09:00',
                    workEndTime: document.getElementById('work-end-time').value || '18:00',
                    lunchBreak: parseInt(document.getElementById('lunch-break').value) || 45,
                    shortBreak: parseInt(document.getElementById('short-break').value) || 15,
                    workingDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']
                        .filter(day => {
                            const checkbox = document.getElementById(day);
                            return checkbox && checkbox.checked;
                        }),
                    holidays: (document.getElementById('holiday-dates').value || '')
                        .split(',')
                        .map(date => date.trim())
                        .filter(date => date && date.match(/^\d{4}-\d{2}-\d{2}$/)),
                    qualityCheckTime: parseInt(document.getElementById('quality-check-time').value) || 30
                };
                
                // Ayarları kaydet
                schedulingSettings = newSettings;
                
                // LocalStorage'a kaydet
                localStorage.setItem('schedulingSettings', JSON.stringify(schedulingSettings));
                
                // Başarı mesajı
                showNotification('Zamanlama ayarları başarıyla kaydedildi!', 'success');
                
                // Modalı kapat
                const modal = bootstrap.Modal.getInstance(document.getElementById('schedulingModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Plan hesaplamalarını güncelle
                updatePlanCalculations();
                
            } catch (error) {
                console.error('Zamanlama ayarları kaydetme hatası:', error);
                showNotification('Ayarlar kaydedilirken hata oluştu: ' + error.message, 'error');
            }
        }

        function updatePlanCalculations() {
            try {
                // Mevcut planları güncelle
                if (allPlans && allPlans.length > 0) {
                    allPlans.forEach(plan => {
                        // Plan süresini yeniden hesapla
                        const startDate = new Date(plan.start_date);
                        const endDate = new Date(plan.end_date);
                        
                        // Çalışma günlerini hesapla (tatil günleri hariç)
                        const workingDays = calculateWorkingDays(startDate, endDate);
                        const summaryNetWorkElement = document.getElementById('summary-net-work');
                        const netWorkHours = summaryNetWorkElement ? parseFloat(summaryNetWorkElement.textContent) || 8 : 8;
                        const machineCapacity = 10; // Varsayılan makine kapasitesi
                        
                        // Plan kapasitesini güncelle
                        plan.calculatedCapacity = workingDays * netWorkHours * machineCapacity;
                        plan.workingDays = workingDays;
                    });
                    
                    // Gantt chart'ı yeniden çiz
                    if (currentView === 'gantt') {
                        const container = document.getElementById('production-plans-container');
                        if (container) {
                            renderGanttView(allPlans, container);
                        } else {
                            console.warn('Production plans container bulunamadı');
                        }
                    }
                }
            } catch (error) {
                console.error('Plan hesaplama güncelleme hatası:', error);
                showNotification('Plan hesaplamaları güncellenirken hata oluştu: ' + error.message, 'error');
            }
        }

        function calculateWorkingDays(startDate, endDate) {
            let workingDays = 0;
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
                const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][dayOfWeek];
                
                // Çalışma günü mü kontrol et
                if (schedulingSettings.workingDays.includes(dayName)) {
                    // Tatil günü mü kontrol et
                    const dateStr = currentDate.toISOString().split('T')[0];
                    if (!schedulingSettings.holidays.includes(dateStr)) {
                        workingDays++;
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return workingDays;
        }

        // Bildirim fonksiyonu
        function showNotification(message, type = 'info') {
            // Bootstrap toast kullanarak bildirim göster
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} text-white">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        <strong class="me-auto">Bildirim</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // Toast kapandıktan sonra DOM'dan kaldır
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        function parseSchedulingInfo(notes, field) {
            if (!notes || !notes.includes('[Zamanlama Bilgileri]')) {
                return null;
            }
            
            const lines = notes.split('\n');
            for (let line of lines) {
                if (line.includes('Çalışma Günleri:') && field === 'working_days') {
                    return line.split(':')[1].trim();
                } else if (line.includes('Toplam Kapasite:') && field === 'total_capacity') {
                    return line.split(':')[1].trim().replace(' adet', '');
                } else if (line.includes('Günlük Kapasite:') && field === 'daily_capacity') {
                    return line.split(':')[1].trim().replace(' adet', '');
                } else if (line.includes('Net Çalışma:') && field === 'net_work') {
                    return line.split(':')[1].trim().replace(' saat', '');
                }
            }
            return null;
        }

        // Tarihi çalışma gününe çevir (hafta sonlarını cuma/ponartesi yap)
        function adjustToWorkingDay(date) {
            const dayOfWeek = date.getDay(); // 0=Pazar, 1=Pazartesi, ..., 6=Cumartesi
            
            // Eğer hafta sonu ise
            if (dayOfWeek === 0) { // Pazar
                // Pazartesiye çevir
                const adjustedDate = new Date(date);
                adjustedDate.setDate(date.getDate() + 1);
                return adjustedDate;
            } else if (dayOfWeek === 6) { // Cumartesi
                // Cumaya çevir
                const adjustedDate = new Date(date);
                adjustedDate.setDate(date.getDate() - 1);
                return adjustedDate;
            }
            
            // Hafta içi ise değişiklik yok
            return null;
        }
        
        // Teslim tarihini çalışma günü kontrolü yap
        function checkAndAdjustDeliveryDate() {
            const deliveryDateInput = document.getElementById('delivery-date');
            const deliveryDate = new Date(deliveryDateInput.value);
            
            if (deliveryDateInput.value && !isNaN(deliveryDate.getTime())) {
                const dayOfWeek = deliveryDate.getDay();
                const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                
                // Hafta sonu kontrolü
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    const adjustedDate = adjustToWorkingDay(deliveryDate);
                    if (adjustedDate) {
                        const adjustedDateStr = adjustedDate.toISOString().split('T')[0];
                        const adjustedDayName = dayNames[adjustedDate.getDay()];
                        const originalDayName = dayNames[dayOfWeek];
                        
                        // Kullanıcıya bilgi ver
                        const message = `Seçilen tarih (${originalDayName}) çalışma günü değil. ${adjustedDayName} gününe çevrildi.`;
                        
                        // Toast bildirimi göster
                        showToast(message, 'warning');
                        
                        // Tarihi güncelle
                        deliveryDateInput.value = adjustedDateStr;
                    }
                }
            }
        }
        
        // Toast bildirimi gösterme fonksiyonu
        function showToast(message, type = 'info') {
            // Mevcut toast'ları temizle
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'warning' ? 'warning' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // Toast container oluştur veya bul
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Toast'ı göster
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
        }

        function updateCapacityAnalysis() {
            const startDate = document.getElementById('start-date-from-orders').value;
            const endDate = document.getElementById('end-date-from-orders').value;
            const capacityContent = document.getElementById('capacity-analysis-content');
            
            if (!startDate || !endDate || selectedOrders.length === 0) {
                capacityContent.innerHTML = `
                    <div class="text-muted text-center py-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Sipariş seçin ve tarih aralığı belirleyin
                    </div>
                `;
                return;
            }
            
            // Zamanlama ayarları kontrolü
            if (!schedulingSettings) {
                schedulingSettings = {
                    workStartTime: '09:00',
                    workEndTime: '18:00',
                    lunchBreak: 45,
                    shortBreak: 15,
                    workingDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                    holidays: [],
                    machineCapacity: 10
                };
            }
            
            // Çalışma günlerini hesapla
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            const workingDays = calculateWorkingDays(start, end);
            
            // Net çalışma süresini hesapla
            const startTime = new Date(`2000-01-01T${schedulingSettings.workStartTime}:00`);
            const endTime = new Date(`2000-01-01T${schedulingSettings.workEndTime}:00`);
            
            if (endTime <= startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            const workHours = (endTime - startTime) / (1000 * 60 * 60);
            const totalBreakHours = (schedulingSettings.lunchBreak + schedulingSettings.shortBreak) / 60;
            const netWorkHours = workHours - totalBreakHours;
            
            // Toplam kapasiteyi hesapla
            const totalCapacity = workingDays * netWorkHours * 10; // Varsayılan makine kapasitesi
            
            // Seçilen siparişlerin toplam miktarını hesapla
            const totalOrderQuantity = selectedOrders.reduce((sum, order) => {
                // Sipariş detaylarından toplam miktarı al
                let orderQuantity = 0;
                
                // Eğer siparişte quantity alanı varsa kullan
                if (order.quantity) {
                    orderQuantity = parseInt(order.quantity);
                }
                // Eğer sipariş detayları JSON formatında saklanıyorsa
                else if (order.product_details) {
                    try {
                        const details = typeof order.product_details === 'string' ? 
                                      JSON.parse(order.product_details) : order.product_details;
                        if (Array.isArray(details)) {
                            orderQuantity = details.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
                        }
                    } catch (e) {
                        console.warn('Sipariş detayları parse edilemedi:', order.product_details);
                    }
                }
                // Varsayılan olarak 1 birim kabul et
                else {
                    orderQuantity = 1;
                }
                
                return sum + orderQuantity;
            }, 0);
            
            // Teslim tarihlerini kontrol et
            const deliveryDates = selectedOrders.map(order => order.delivery_date).filter(date => date);
            const latestDeliveryDate = deliveryDates.length > 0 ? new Date(Math.max(...deliveryDates.map(d => new Date(d).getTime()))) : null;
            
            // En geç teslim tarihini çalışma gününe çevir ve bitiş tarihi alanına otomatik seç
            if (latestDeliveryDate) {
                const adjustedDate = adjustToWorkingDay(latestDeliveryDate);
                if (adjustedDate && adjustedDate.getTime() !== latestDeliveryDate.getTime()) {
                    // Düzeltilen tarihi bitiş tarihi alanına otomatik seç
                    const adjustedDateStr = adjustedDate.toISOString().split('T')[0];
                    document.getElementById('end-date-from-orders').value = adjustedDateStr;
                    
                    // Kullanıcıya bilgi ver
                    showToast(`Bitiş tarihi çalışma gününe göre otomatik düzeltildi: ${formatDate(adjustedDate.toISOString())}`, 'info');
                }
            }
            
            // Kapasite durumunu analiz et
            const canDeliver = totalCapacity >= totalOrderQuantity;
            const capacityUtilization = totalOrderQuantity > 0 ? ((totalOrderQuantity / totalCapacity) * 100).toFixed(1) : 0;
            
            // Sonuçları göster
            capacityContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <small class="text-muted">Çalışma Günleri:</small>
                            <div class="fw-bold">${workingDays} gün</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Net Çalışma:</small>
                            <div class="fw-bold">${netWorkHours.toFixed(1)} saat/gün</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Günlük Kapasite:</small>
                            <div class="fw-bold">${Math.round(netWorkHours * 10)} adet</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            <small class="text-muted">Toplam Kapasite:</small>
                            <div class="fw-bold">${totalCapacity} adet</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Toplam Ürün Sayısı:</small>
                            <div class="fw-bold">${totalOrderQuantity} adet</div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Kapasite Kullanımı:</small>
                            <div class="fw-bold">${capacityUtilization}%</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert ${canDeliver ? 'alert-success' : 'alert-warning'}">
                        <div class="d-flex align-items-center">
                            <i class="fas ${canDeliver ? 'fa-check-circle' : 'fa-exclamation-triangle'} me-2"></i>
                            <div>
                                <strong>${canDeliver ? 'Teslim Edilebilir!' : 'Kapasite Yetersiz!'}</strong>
                                <div class="small">
                                    ${canDeliver ? 
                                        `Seçilen siparişlerin toplam ürün sayısı (${totalOrderQuantity} adet) mevcut kapasiteye (${totalCapacity} adet) sığıyor.` :
                                        `Toplam ürün sayısı (${totalOrderQuantity} adet) mevcut kapasiteyi (${totalCapacity} adet) aşıyor. ${totalOrderQuantity - totalCapacity} adet daha üretim gerekli.`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${latestDeliveryDate ? `
                    <div class="alert alert-info">
                        <i class="fas fa-calendar me-2"></i>
                        <strong>En Geç Teslim Tarihi:</strong> ${formatDate(latestDeliveryDate.toISOString().split('T')[0])}
                        ${adjustToWorkingDay(latestDeliveryDate) ? `
                        <br><small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Çalışma günlerine göre düzeltildi: ${formatDate(adjustToWorkingDay(latestDeliveryDate).toISOString().split('T')[0])}
                        </small>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function updateSchedulingInfoInModal() {
            // Zamanlama bilgilerini modalda göster
            const workHoursElement = document.getElementById('plan-work-hours');
            const breakTimeElement = document.getElementById('plan-break-time');
            const netWorkElement = document.getElementById('plan-net-work');
            const dailyCapacityElement = document.getElementById('plan-daily-capacity');
            
            if (workHoursElement && schedulingSettings) {
                workHoursElement.textContent = `${schedulingSettings.workStartTime} - ${schedulingSettings.workEndTime}`;
            }
            
            if (breakTimeElement && schedulingSettings) {
                const totalBreakMinutes = schedulingSettings.lunchBreak + schedulingSettings.shortBreak;
                const totalBreakHours = totalBreakMinutes / 60;
                breakTimeElement.textContent = `${totalBreakHours.toFixed(1)} saat`;
            }
            
            if (netWorkElement && schedulingSettings) {
                // Net çalışma süresini hesapla
                const startTime = new Date(`2000-01-01T${schedulingSettings.workStartTime}:00`);
                const endTime = new Date(`2000-01-01T${schedulingSettings.workEndTime}:00`);
                
                if (endTime <= startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                const workHours = (endTime - startTime) / (1000 * 60 * 60);
                const totalBreakHours = (schedulingSettings.lunchBreak + schedulingSettings.shortBreak) / 60;
                const netWorkHours = workHours - totalBreakHours;
                
                netWorkElement.textContent = `${netWorkHours.toFixed(1)} saat`;
            }
            
            if (dailyCapacityElement && schedulingSettings) {
                // Günlük kapasiteyi hesapla
                const startTime = new Date(`2000-01-01T${schedulingSettings.workStartTime}:00`);
                const endTime = new Date(`2000-01-01T${schedulingSettings.workEndTime}:00`);
                
                if (endTime <= startTime) {
                    endTime.setDate(endTime.getDate() + 1);
                }
                
                const workHours = (endTime - startTime) / (1000 * 60 * 60);
                const totalBreakHours = (schedulingSettings.lunchBreak + schedulingSettings.shortBreak) / 60;
                const netWorkHours = workHours - totalBreakHours;
                const dailyCapacity = netWorkHours * 10; // Varsayılan makine kapasitesi
                
                dailyCapacityElement.textContent = `${Math.round(dailyCapacity)} adet`;
            }
        }

        // Sayfa yüklendiğinde ayarları geri yükle
        document.addEventListener('DOMContentLoaded', function() {
            const savedSettings = localStorage.getItem('schedulingSettings');
            if (savedSettings) {
                schedulingSettings = JSON.parse(savedSettings);
            }
            
            // Kaynak kapasitesi değişiklik event listener'ı
            const resourceCapacityElement = document.getElementById('resource-capacity');
            if (resourceCapacityElement) {
                resourceCapacityElement.addEventListener('input', updateResourceCapacityCalculation);
            }
            
            // Sipariş durumlarını kontrol et ve düzelt
            setTimeout(() => {
                checkAndFixOrderStatuses();
            }, 2000); // 2 saniye bekle, sayfa tamamen yüklendikten sonra
            
            // Tab değişikliği event listener'ları
            const productionStartTab = document.getElementById('production-start-tab');
            if (productionStartTab) {
                productionStartTab.addEventListener('shown.bs.tab', function() {
                    // Üretim Başlat tab'ına geçildiğinde
                    if (typeof initializeProductionStartTab === 'function') {
                        initializeProductionStartTab();
                    }
                });
            }
        });

        // Gelişmiş Plan Yönetimi Fonksiyonları
        let planTasks = [];
        let planResources = [];
        let taskCharts = {};
        
        function showAdvancedPlanDetails(plan) {
            currentPlanId = plan.id;
            
            // Modal başlığını güncelle
            document.getElementById('advancedPlanTitle').innerHTML = 
                `<i class="fas fa-eye me-2"></i>${plan.plan_name} - Detaylar ve Yönetimi`;
            
            // Plan bilgilerini yükle
            loadPlanInfo(plan);
            
            // Modal'ı göster
            const modal = new bootstrap.Modal(document.getElementById('advancedPlanDetailsModal'));
            modal.show();
            
            // Tab değişikliklerini dinle
            setupTabListeners();
        }
        
        function loadPlanInfo(plan) {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Plan Bilgileri</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Plan Adı:</strong></td><td>${plan.plan_name}</td></tr>
                            <tr><td><strong>Tip:</strong></td><td>${getPlanTypeText(plan.plan_type)}</td></tr>
                            <tr><td><strong>Durum:</strong></td><td><span class="badge ${getStatusBadgeClass(plan.status)}">${getStatusText(plan.status)}</span></td></tr>
                            <tr><td><strong>Oluşturan:</strong></td><td>${plan.created_by || 'Admin'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-calendar me-2"></i>Tarih Bilgileri</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Başlangıç:</strong></td><td>${formatDate(plan.start_date)}</td></tr>
                            <tr><td><strong>Bitiş:</strong></td><td>${formatDate(plan.end_date)}</td></tr>
                            <tr><td><strong>Oluşturulma:</strong></td><td>${formatDate(plan.created_at)}</td></tr>
                            <tr><td><strong>Güncelleme:</strong></td><td>${formatDate(plan.updated_at)}</td></tr>
                        </table>
                    </div>
                </div>
                
                <!-- Zamanlama Bilgileri -->
                ${plan.working_days || plan.net_work_hours || plan.total_capacity ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-clock me-2"></i>Zamanlama Bilgileri</h6>
                        <table class="table table-sm">
                            ${plan.working_days ? `<tr><td><strong>Çalışma Günleri:</strong></td><td>${plan.working_days} gün</td></tr>` : ''}
                            ${plan.net_work_hours ? `<tr><td><strong>Net Çalışma Saati:</strong></td><td>${plan.net_work_hours} saat</td></tr>` : ''}
                            ${plan.daily_capacity ? `<tr><td><strong>Günlük Kapasite:</strong></td><td>${plan.daily_capacity} adet</td></tr>` : ''}
                            ${plan.total_capacity ? `<tr><td><strong>Toplam Kapasite:</strong></td><td>${plan.total_capacity} adet</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                ` : ''}
                </div>
                ${plan.notes ? `
                    <div class="mt-3">
                        <h6><i class="fas fa-sticky-note me-2"></i>Notlar</h6>
                        <div class="alert alert-light">
                            <p class="mb-0">${plan.notes}</p>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('planDetailsContent').innerHTML = content;
            document.getElementById('editPlanBtn').style.display = 'inline-block';
            document.getElementById('editPlanBtn').onclick = () => {
                editPlan(plan.id);
                bootstrap.Modal.getInstance(document.getElementById('advancedPlanDetailsModal')).hide();
            };
        }
        
        function setupTabListeners() {
            const tabs = document.querySelectorAll('#planDetailsTabs button[data-bs-toggle="tab"]');
            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const target = event.target.getAttribute('data-bs-target');
                    switch(target) {
                        case '#tasks':
                            loadPlanTasks();
                            break;
                        case '#timeline':
                            loadPlanTimeline();
                            break;
                        case '#resources':
                            loadPlanResources();
                            break;
                        case '#progress':
                            loadPlanProgress();
                            break;
                    }
                });
            });
        }
        
        function loadPlanTasks() {
            // Örnek görev verileri (gerçek uygulamada API'den gelecek)
            planTasks = [
                {
                    id: 1,
                    name: 'Hammadde Hazırlığı',
                    priority: 'high',
                    status: 'completed',
                    start_date: '2025-09-15',
                    end_date: '2025-09-16',
                    assignee: 'Ahmet Yılmaz',
                    description: 'Üretim için gerekli hammaddelerin hazırlanması'
                },
                {
                    id: 2,
                    name: 'Kalıp Hazırlığı',
                    priority: 'medium',
                    status: 'in_progress',
                    start_date: '2025-09-16',
                    end_date: '2025-09-18',
                    assignee: 'Ayşe Demir',
                    description: 'Üretim kalıplarının hazırlanması ve kontrolü'
                },
                {
                    id: 3,
                    name: 'Üretim Süreci',
                    priority: 'high',
                    status: 'pending',
                    start_date: '2025-09-18',
                    end_date: '2025-09-22',
                    assignee: 'Mehmet Kaya',
                    description: 'Ana üretim sürecinin başlatılması'
                }
            ];
            
            renderPlanTasks();
        }
        
        function renderPlanTasks() {
            if (planTasks.length === 0) {
                document.getElementById('planTasksList').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-tasks fa-2x mb-2"></i>
                        <p>Henüz görev eklenmemiş</p>
                    </div>
                `;
                return;
            }
            
            const tasksHtml = planTasks.map(task => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">${task.name}</h6>
                                <p class="card-text text-muted small mb-2">${task.description}</p>
                                <div class="d-flex gap-3">
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i>${task.assignee || 'Atanmamış'}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${formatDate(task.start_date)} - ${formatDate(task.end_date)}
                                    </small>
                                    <span class="badge ${getTaskStatusBadgeClass(task.status)}">${getTaskStatusText(task.status)}</span>
                                    <span class="badge ${getTaskPriorityBadgeClass(task.priority)}">${getTaskPriorityText(task.priority)}</span>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editTask(${task.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteTask(${task.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('planTasksList').innerHTML = tasksHtml;
        }
        
        function loadPlanTimeline() {
            // Zaman çizelgesi yükleme
            document.getElementById('planTimeline').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="timeline">
                            ${planTasks.map(task => `
                                <div class="timeline-item">
                                    <div class="timeline-marker ${getTaskStatusBadgeClass(task.status)}"></div>
                                    <div class="timeline-content">
                                        <h6>${task.name}</h6>
                                        <p class="text-muted small">${formatDate(task.start_date)} - ${formatDate(task.end_date)}</p>
                                        <span class="badge ${getTaskStatusBadgeClass(task.status)}">${getTaskStatusText(task.status)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadPlanResources() {
            // Örnek kaynak verileri
            planResources = [
                {
                    id: 1,
                    name: 'Makine 1 - Pres',
                    type: 'machine',
                    start_date: '2025-09-15',
                    end_date: '2025-09-22',
                    notes: 'Ana üretim makinesi'
                },
                {
                    id: 2,
                    name: 'Operatör - Ahmet Yılmaz',
                    type: 'operator',
                    start_date: '2025-09-15',
                    end_date: '2025-09-22',
                    notes: 'Ana operatör'
                }
            ];
            
            renderPlanResources();
        }
        
        function renderPlanResources() {
            if (planResources.length === 0) {
                document.getElementById('planResourcesList').innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p>Henüz kaynak atanmamış</p>
                    </div>
                `;
                return;
            }
            
            const resourcesHtml = planResources.map(resource => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">
                                    <i class="fas ${resource.type === 'machine' ? 'fa-cog' : 'fa-user'} me-2"></i>
                                    ${resource.name}
                                </h6>
                                <p class="card-text text-muted small mb-2">${resource.notes}</p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>${formatDate(resource.start_date)} - ${formatDate(resource.end_date)}
                                </small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editResourceAssignment(${resource.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="removeResourceAssignment(${resource.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('planResourcesList').innerHTML = resourcesHtml;
        }
        
        function loadPlanProgress() {
            // İlerleme verilerini hesapla
            const completedTasks = planTasks.filter(t => t.status === 'completed').length;
            const inProgressTasks = planTasks.filter(t => t.status === 'in_progress').length;
            const pendingTasks = planTasks.filter(t => t.status === 'pending').length;
            const totalTasks = planTasks.length;
            
            const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // İlerleme çubuğunu güncelle
            document.getElementById('overallProgress').style.width = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `${progressPercentage}%`;
            
            // Sayıları güncelle
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            
            // Görev dağılımı grafiğini oluştur
            createTaskStatusChart();
        }
        
        function createTaskStatusChart() {
            const completedTasks = planTasks.filter(t => t.status === 'completed').length;
            const inProgressTasks = planTasks.filter(t => t.status === 'in_progress').length;
            const pendingTasks = planTasks.filter(t => t.status === 'pending').length;
            const cancelledTasks = planTasks.filter(t => t.status === 'cancelled').length;
            
            const total = completedTasks + inProgressTasks + pendingTasks + cancelledTasks;
            if (total === 0) {
                document.getElementById('taskStatusChart').innerHTML = '<div class="text-center text-muted">Henüz görev bulunmuyor</div>';
                return;
            }
            
            const chartHtml = `
                <div class="row text-center">
                    <div class="col-6 col-md-3 mb-3">
                        <div class="d-flex flex-column align-items-center">
                            <div class="bg-success rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <span class="text-white font-weight-bold">${completedTasks}</span>
                            </div>
                            <small class="text-muted">Tamamlandı</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="d-flex flex-column align-items-center">
                            <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <span class="text-dark font-weight-bold">${inProgressTasks}</span>
                            </div>
                            <small class="text-muted">Devam Ediyor</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="d-flex flex-column align-items-center">
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <span class="text-white font-weight-bold">${pendingTasks}</span>
                            </div>
                            <small class="text-muted">Beklemede</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <div class="d-flex flex-column align-items-center">
                            <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 50px; height: 50px;">
                                <span class="text-white font-weight-bold">${cancelledTasks}</span>
                            </div>
                            <small class="text-muted">İptal</small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('taskStatusChart').innerHTML = chartHtml;
        }
        
        // Görev yönetimi fonksiyonları
        function showAddTaskModal() {
            const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            modal.show();
        }
        
        function saveTask() {
            const taskData = {
                name: document.getElementById('taskName').value,
                priority: document.getElementById('taskPriority').value,
                start_date: document.getElementById('taskStartDate').value,
                end_date: document.getElementById('taskEndDate').value,
                description: document.getElementById('taskDescription').value,
                assignee: document.getElementById('taskAssignee').value,
                status: document.getElementById('taskStatus').value,
                plan_id: currentPlanId
            };
            
            // Basit validasyon
            if (!taskData.name || !taskData.start_date || !taskData.end_date) {
                alert('Lütfen tüm zorunlu alanları doldurun!');
                return;
            }
            
            // Yeni görev ekle
            const newTask = {
                id: Date.now(),
                ...taskData,
                assignee: taskData.assignee ? document.getElementById('taskAssignee').selectedOptions[0].text : 'Atanmamış'
            };
            
            planTasks.push(newTask);
            
            // Modal'ı kapat ve listeyi güncelle
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            renderPlanTasks();
            
            // Form'u temizle
            document.getElementById('taskForm').reset();
            
            alert('Görev başarıyla eklendi!');
        }
        
        function editTask(taskId) {
            const task = planTasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Form'u doldur
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStartDate').value = task.start_date;
            document.getElementById('taskEndDate').value = task.end_date;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskStatus').value = task.status;
            
            // Modal'ı göster
            showAddTaskModal();
        }
        
        function deleteTask(taskId) {
            if (confirm('Bu görevi silmek istediğinizden emin misiniz?')) {
                planTasks = planTasks.filter(t => t.id !== taskId);
                renderPlanTasks();
                alert('Görev silindi!');
            }
        }
        
        // Kaynak atama fonksiyonları
        function showAssignResourceModal() {
            const modal = new bootstrap.Modal(document.getElementById('assignResourceModal'));
            modal.show();
        }
        
        function saveResourceAssignment() {
            const assignmentData = {
                resource: document.getElementById('resourceSelect').value,
                start_date: document.getElementById('assignmentStartDate').value,
                end_date: document.getElementById('assignmentEndDate').value,
                notes: document.getElementById('assignmentNotes').value,
                plan_id: currentPlanId
            };
            
            if (!assignmentData.resource || !assignmentData.start_date || !assignmentData.end_date) {
                alert('Lütfen tüm zorunlu alanları doldurun!');
                return;
            }
            
            const newResource = {
                id: Date.now(),
                name: document.getElementById('resourceSelect').selectedOptions[0].text,
                type: assignmentData.resource.includes('machine') ? 'machine' : 'operator',
                ...assignmentData
            };
            
            planResources.push(newResource);
            
            // Modal'ı kapat ve listeyi güncelle
            bootstrap.Modal.getInstance(document.getElementById('assignResourceModal')).hide();
            renderPlanResources();
            
            // Form'u temizle
            document.getElementById('resourceAssignmentForm').reset();
            
            alert('Kaynak başarıyla atandı!');
        }
        
        function editResourceAssignment(resourceId) {
            const resource = planResources.find(r => r.id === resourceId);
            if (!resource) return;
            
            // Form'u doldur ve modal'ı göster
            showAssignResourceModal();
        }
        
        function removeResourceAssignment(resourceId) {
            if (confirm('Bu kaynak atamasını kaldırmak istediğinizden emin misiniz?')) {
                planResources = planResources.filter(r => r.id !== resourceId);
                renderPlanResources();
                alert('Kaynak ataması kaldırıldı!');
            }
        }
        
        // Timeline görünüm fonksiyonları
        function viewTimeline(viewType) {
            if (viewType === 'gantt') {
                // Gantt chart görünümü
                loadPlanTimeline();
            } else {
                // Liste görünümü
                renderPlanTasks();
            }
        }
        
        // Helper fonksiyonlar
        function getTaskStatusBadgeClass(status) {
            const classes = {
                'pending': 'bg-secondary',
                'in_progress': 'bg-warning',
                'completed': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }
        
        function getTaskStatusText(status) {
            const texts = {
                'pending': 'Beklemede',
                'in_progress': 'Devam Ediyor',
                'completed': 'Tamamlandı',
                'cancelled': 'İptal'
            };
            return texts[status] || status;
        }
        
        function getTaskPriorityBadgeClass(priority) {
            const classes = {
                'low': 'bg-info',
                'medium': 'bg-primary',
                'high': 'bg-warning',
                'urgent': 'bg-danger'
            };
            return classes[priority] || 'bg-secondary';
        }
        
        function getTaskPriorityText(priority) {
            const texts = {
                'low': 'Düşük',
                'medium': 'Orta',
                'high': 'Yüksek',
                'urgent': 'Acil'
            };
            return texts[priority] || priority;
        }
    </script>
    

    <!-- Sipariş Detayları Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="orderDetailsModalLabel">
                        <i class="fas fa-file-alt me-2"></i>Sipariş Detayları
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailsModalBody">
                    <!-- Sipariş detayları buraya gelecek -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary" onclick="editOrderFromDetails()">
                        <i class="fas fa-edit me-1"></i>Düzenle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Siparişlerden Plan Oluşturma Modal -->
    <div class="modal fade" id="createPlanFromOrdersModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Siparişlerden Üretim Planı Oluştur
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Sol: Sipariş Seçimi -->
                        <div class="col-md-6">
                            <h6><i class="fas fa-shopping-cart me-2"></i>Mevcut Siparişler</h6>
                            <div class="mb-3">
                                <label class="form-label">Sipariş Durumu:</label>
                                <select class="form-select" id="order-status-filter" onchange="filterOrders()">
                                    <option value="all">Tüm Siparişler</option>
                                    <option value="pending">Bekleyen</option>
                                    <option value="processing">İşlenen</option>
                                    <option value="completed">Tamamlanan</option>
                                </select>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <div id="orders-selection-container">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Siparişler yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sağ: Seçilen Siparişler ve Plan Ayarları -->
                        <div class="col-md-6">
                            <h6><i class="fas fa-cogs me-2"></i>Plan Ayarları</h6>
                            
                            <!-- Seçilen Siparişler -->
                            <div class="mb-3">
                                <label class="form-label">Seçilen Siparişler:</label>
                                <div id="selected-orders-list" class="border rounded p-2" style="min-height: 100px; max-height: 150px; overflow-y: auto;">
                                    <div class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Plan oluşturmak için sipariş seçiniz
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Zamanlama Analizi -->
                            <div class="card mb-3" id="capacity-analysis-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Üretim Kapasitesi ve Ürün Sayısı Analizi
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="capacity-analysis-content">
                                        <div class="text-muted text-center py-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Sipariş seçin ve tarih aralığı belirleyin
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Plan Bilgileri -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="plan-name-from-orders" class="form-label">Plan Adı *</label>
                                        <input type="text" class="form-control" id="plan-name-from-orders" placeholder="Otomatik oluşturulacak">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="plan-type-from-orders" class="form-label">Plan Tipi *</label>
                                        <select class="form-select" id="plan-type-from-orders">
                                            <option value="">Plan tipi seçiniz</option>
                                            <option value="daily">Günlük</option>
                                            <option value="weekly">Haftalık</option>
                                            <option value="monthly">Aylık</option>
                                            <option value="quarterly">Çeyreklik</option>
                                            <option value="yearly">Yıllık</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="plan-status-from-orders" class="form-label">Plan Durumu *</label>
                                        <select class="form-select" id="plan-status-from-orders">
                                            <option value="draft">Taslak</option>
                                            <option value="approved">Onaylanmış</option>
                                            <option value="active">Aktif</option>
                                            <option value="completed">Tamamlanmış</option>
                                            <option value="cancelled">İptal Edilmiş</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="start-date-from-orders" class="form-label">Başlangıç Tarihi *</label>
                                        <input type="date" class="form-control" id="start-date-from-orders">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="end-date-from-orders" class="form-label">Bitiş Tarihi *</label>
                                        <input type="date" class="form-control" id="end-date-from-orders">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="assigned-operator-from-orders" class="form-label">Atanan Operatör *</label>
                                        <select class="form-select" id="assigned-operator-from-orders" required>
                                            <option value="">Operatör Seçiniz</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="operator-notes-from-orders" class="form-label">Operatör Notları</label>
                                        <textarea class="form-control" id="operator-notes-from-orders" rows="2" placeholder="Operatör için özel notlar..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="plan-notes-from-orders" class="form-label">Notlar</label>
                                <textarea class="form-control" id="plan-notes-from-orders" rows="3" placeholder="Plan hakkında notlar..."></textarea>
                            </div>
                            
                            <!-- Plan Özeti -->
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Plan Özeti</h6>
                                <div id="plan-summary">
                                    <p class="mb-1"><strong>Sipariş Sayısı:</strong> <span id="selected-orders-count">0</span></p>
                                    <p class="mb-1"><strong>Toplam Ürün:</strong> <span id="total-products-count">0</span></p>
                                    <p class="mb-0"><strong>Plan Durumu:</strong> <span id="selected-plan-status">Taslak</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" onclick="createPlanFromSelectedOrders()">
                        <i class="fas fa-magic me-1"></i>Plan Oluştur
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Üretim Planı Ekleme/Düzenleme Modal -->
    <div class="modal fade" id="planModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalTitle">Yeni Üretim Planı</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="planForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="plan-name" class="form-label">Plan Adı *</label>
                                    <input type="text" class="form-control" id="plan-name" required>
                                </div>
                            </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="plan-type" class="form-label">Plan Tipi *</label>
                                <select class="form-select" id="plan-type" required>
                                    <option value="">Plan tipi seçiniz</option>
                                    <option value="daily">Günlük</option>
                                    <option value="weekly">Haftalık</option>
                                    <option value="monthly">Aylık</option>
                                    <option value="quarterly">Çeyreklik</option>
                                    <option value="yearly">Yıllık</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zamanlama Bilgileri -->
                    <div class="card mb-3" id="scheduling-info-card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Zamanlama Bilgileri
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Çalışma Saatleri:</small>
                                        <div id="plan-work-hours" class="fw-bold">09:00 - 18:00</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Mola Süresi:</small>
                                        <div id="plan-break-time" class="fw-bold">1 saat</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted">Net Çalışma:</small>
                                        <div id="plan-net-work" class="fw-bold">8 saat</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Günlük Kapasite:</small>
                                        <div id="plan-daily-capacity" class="fw-bold">80 adet</div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>Bu bilgiler zamanlama ayarlarından alınmaktadır. Değiştirmek için "Zamanlama" butonunu kullanın.</small>
                            </div>
                        </div>
                    </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start-date" class="form-label">Başlangıç Tarihi *</label>
                                    <input type="date" class="form-control" id="start-date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end-date" class="form-label">Bitiş Tarihi *</label>
                                    <input type="date" class="form-control" id="end-date" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="plan-status" class="form-label">Durum</label>
                                    <select class="form-select" id="plan-status">
                                        <option value="draft">Taslak</option>
                                        <option value="active">Aktif</option>
                                        <option value="completed">Tamamlandı</option>
                                        <option value="cancelled">İptal</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assigned-operator" class="form-label">Atanan Operatör</label>
                                    <select class="form-select" id="assigned-operator">
                                        <option value="">Operatör seçiniz...</option>
                                        <option value="Thunder Serisi Operatör">Thunder Serisi Operatör</option>
                                        <option value="ThunderPRO Serisi Operatör">ThunderPRO Serisi Operatör</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="created-by" class="form-label">Oluşturan</label>
                                    <input type="text" class="form-control" id="created-by" value="Admin">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="operator-notes" class="form-label">Operatör Notları</label>
                                    <textarea class="form-control" id="operator-notes" rows="2" placeholder="Operatör için özel notlar..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="plan-notes" class="form-label">Notlar</label>
                            <textarea class="form-control" id="plan-notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="savePlan()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart.js Kaldırıldı - Basit HTML/CSS grafikleri kullanılacak -->
    
    <!-- Gelişmiş Plan Detayları Modal -->
    <div class="modal fade" id="advancedPlanDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="advancedPlanTitle">
                        <i class="fas fa-eye me-2"></i>Plan Detayları ve Yönetimi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Plan Bilgileri Tab -->
                    <ul class="nav nav-tabs mb-3" id="planDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="plan-info-tab" data-bs-toggle="tab" data-bs-target="#plan-info" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>Plan Bilgileri
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                <i class="fas fa-tasks me-1"></i>Görevler
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
                                <i class="fas fa-timeline me-1"></i>Zaman Çizelgesi
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>Kaynaklar
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button" role="tab">
                                <i class="fas fa-chart-line me-1"></i>İlerleme
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="planDetailsTabContent">
                        <!-- Plan Bilgileri -->
                        <div class="tab-pane fade show active" id="plan-info" role="tabpanel">
                            <div id="planDetailsContent">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Yükleniyor...</span>
                                    </div>
                                    <p class="mt-2">Plan detayları yükleniyor...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Görevler -->
                        <div class="tab-pane fade" id="tasks" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Plan Görevleri</h6>
                                <button type="button" class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                                    <i class="fas fa-plus me-1"></i>Yeni Görev
                                </button>
                            </div>
                            <div id="planTasksList">
                                <div class="text-center text-muted">
                                    <i class="fas fa-tasks fa-2x mb-2"></i>
                                    <p>Henüz görev eklenmemiş</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Zaman Çizelgesi -->
                        <div class="tab-pane fade" id="timeline" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Plan Zaman Çizelgesi</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="viewTimeline('gantt')">
                                        <i class="fas fa-chart-gantt me-1"></i>Gantt
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="viewTimeline('list')">
                                        <i class="fas fa-list me-1"></i>Liste
                                    </button>
                                </div>
                            </div>
                            <div id="planTimeline">
                                <div class="text-center text-muted">
                                    <i class="fas fa-timeline fa-2x mb-2"></i>
                                    <p>Zaman çizelgesi yükleniyor...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kaynaklar -->
                        <div class="tab-pane fade" id="resources" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Atanmış Kaynaklar</h6>
                                <button type="button" class="btn btn-success btn-sm" onclick="showAssignResourceModal()">
                                    <i class="fas fa-user-plus me-1"></i>Kaynak Ata
                                </button>
                            </div>
                            <div id="planResourcesList">
                                <div class="text-center text-muted">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <p>Henüz kaynak atanmamış</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- İlerleme -->
                        <div class="tab-pane fade" id="progress" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Genel İlerleme</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar bg-success" role="progressbar" id="overallProgress" style="width: 0%">
                                                    <span id="progressText">0%</span>
                                                </div>
                                            </div>
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <div class="border rounded p-2">
                                                        <h6 class="mb-0 text-success" id="completedTasks">0</h6>
                                                        <small class="text-muted">Tamamlandı</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="border rounded p-2">
                                                        <h6 class="mb-0 text-warning" id="inProgressTasks">0</h6>
                                                        <small class="text-muted">Devam Ediyor</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="border rounded p-2">
                                                        <h6 class="mb-0 text-secondary" id="pendingTasks">0</h6>
                                                        <small class="text-muted">Beklemede</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Görev Dağılımı</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="taskStatusChart" width="300" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary" id="editPlanBtn" style="display: none;">
                        <i class="fas fa-edit me-1"></i>Düzenle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yeni Görev Ekleme Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Yeni Görev Ekle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskName" class="form-label">Görev Adı *</label>
                                    <input type="text" class="form-control" id="taskName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskPriority" class="form-label">Öncelik</label>
                                    <select class="form-select" id="taskPriority">
                                        <option value="low">Düşük</option>
                                        <option value="medium" selected>Orta</option>
                                        <option value="high">Yüksek</option>
                                        <option value="urgent">Acil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskStartDate" class="form-label">Başlangıç Tarihi *</label>
                                    <input type="date" class="form-control" id="taskStartDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskEndDate" class="form-label">Bitiş Tarihi *</label>
                                    <input type="date" class="form-control" id="taskEndDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Görev Açıklaması</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskAssignee" class="form-label">Atanan Kişi</label>
                                    <select class="form-select" id="taskAssignee">
                                        <option value="">Atama Yap</option>
                                        <option value="user1">Ahmet Yılmaz</option>
                                        <option value="user2">Ayşe Demir</option>
                                        <option value="user3">Mehmet Kaya</option>
                                        <option value="user4">Fatma Öz</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="taskStatus" class="form-label">Durum</label>
                                    <select class="form-select" id="taskStatus">
                                        <option value="pending">Beklemede</option>
                                        <option value="in_progress">Devam Ediyor</option>
                                        <option value="completed">Tamamlandı</option>
                                        <option value="cancelled">İptal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kaynak Atama Modal -->
    <div class="modal fade" id="assignResourceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Kaynak Ata
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="resourceAssignmentForm">
                        <div class="mb-3">
                            <label for="resourceSelect" class="form-label">Kaynak Seç *</label>
                            <select class="form-select" id="resourceSelect" required>
                                <option value="">Kaynak Seçin</option>
                                <option value="machine1">Makine 1 - Pres</option>
                                <option value="machine2">Makine 2 - CNC</option>
                                <option value="machine3">Makine 3 - Kaynak</option>
                                <option value="operator1">Operatör - Ahmet Yılmaz</option>
                                <option value="operator2">Operatör - Ayşe Demir</option>
                                <option value="supervisor1">Süpervizör - Mehmet Kaya</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assignmentStartDate" class="form-label">Başlangıç Tarihi *</label>
                                    <input type="date" class="form-control" id="assignmentStartDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assignmentEndDate" class="form-label">Bitiş Tarihi *</label>
                                    <input type="date" class="form-control" id="assignmentEndDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="assignmentNotes" class="form-label">Atama Notları</label>
                            <textarea class="form-control" id="assignmentNotes" rows="3" placeholder="Bu kaynağın planda nasıl kullanılacağına dair notlar..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" onclick="saveResourceAssignment()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Zamanlama Modalı -->
    <div class="modal fade" id="schedulingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clock me-2"></i>Zamanlama Ayarları
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="schedulingForm">
                        <!-- Çalışma Saatleri -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-clock me-2"></i>Çalışma Saatleri
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="work-start-time" class="form-label">Başlangıç Saati</label>
                                            <input type="time" class="form-control" id="work-start-time" value="09:00">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="work-end-time" class="form-label">Bitiş Saati</label>
                                            <input type="time" class="form-control" id="work-end-time" value="18:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Günlük Çalışma:</strong> <span id="daily-work-hours">9</span> saat
                                </div>
                            </div>
                        </div>

                        <!-- Mola Süreleri -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-coffee me-2"></i>Mola Süreleri
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="lunch-break" class="form-label">Yemek Molası (dakika)</label>
                                            <input type="number" class="form-control" id="lunch-break" value="45" min="0" max="120">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="short-break" class="form-label">Ara Mola (dakika)</label>
                                            <input type="number" class="form-control" id="short-break" value="15" min="0" max="60">
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>Toplam Mola:</strong> <span id="total-break-time">1</span> saat
                                </div>
                            </div>
                        </div>

                        <!-- Çalışma Günleri -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-week me-2"></i>Çalışma Günleri
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="monday" checked>
                                            <label class="form-check-label" for="monday">Pazartesi</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="tuesday" checked>
                                            <label class="form-check-label" for="tuesday">Salı</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wednesday" checked>
                                            <label class="form-check-label" for="wednesday">Çarşamba</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="thursday" checked>
                                            <label class="form-check-label" for="thursday">Perşembe</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="friday" checked>
                                            <label class="form-check-label" for="friday">Cuma</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="saturday">
                                            <label class="form-check-label" for="saturday">Cumartesi</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sunday">
                                            <label class="form-check-label" for="sunday">Pazar</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tatil Günleri -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-times me-2"></i>Tatil Günleri
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="holiday-dates" class="form-label">Tatil Tarihleri (Virgülle ayırın)</label>
                                    <input type="text" class="form-control" id="holiday-dates" 
                                           placeholder="2025-01-01, 2025-04-23, 2025-05-01, 2025-05-19, 2025-07-15, 2025-08-30, 2025-10-29">
                                    <div class="form-text">Format: YYYY-MM-DD</div>
                                </div>
                            </div>
                        </div>

                        <!-- Kapasite Ayarları -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cogs me-2"></i>Kalite Kontrol Ayarları
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="quality-check-time" class="form-label">Kalite Kontrol Süresi (dakika)</label>
                                            <input type="number" class="form-control" id="quality-check-time" value="30" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Özet -->
                        <div class="alert alert-success">
                            <h6><i class="fas fa-calculator me-2"></i>Hesaplama Özeti</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Günlük Çalışma:</strong> <span id="summary-daily-work">9</span> saat</p>
                                    <p class="mb-1"><strong>Net Çalışma:</strong> <span id="summary-net-work">8</span> saat</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Haftalık Çalışma:</strong> <span id="summary-weekly-work">45</span> saat</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedulingSettings()">
                        <i class="fas fa-save me-1"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>



</body>
</html>